<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>本地名单抽奖 · 老虎机动画（紫色主题）</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* ==================== 视觉美化 V3 (动画增强版) - 主题调色板 ==================== */
  :root {
    --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --panel: rgba(255, 255, 255, 0.75);
    --panel-border: rgba(233, 213, 255, 0.5);
    --text: #2d3748;
    --muted: #718096;
    --accent-50: #f5f3ff;
    --accent-100: #ede9fe;
    --accent-300: #c4b5fd;
    --accent-500: #8b5cf6;
    --accent-600: #7c3aed;
    --accent-700: #6d28d9;
    --ok: #28a745;
    --bad: #dc3545;
    --radius: 16px;
    --gap: 16px;
    --shadow: 0 10px 30px rgba(109, 40, 217, .12);
    --shadow-hover: 0 18px 40px rgba(109, 40, 217, .18);
    --shadow-inset: inset 0 2px 4px rgba(0,0,0,0.04);
    --cell-h: 56px;
    --reel-w: min(520px, 94vw);
    --reel-bg: #1f1147;
    --reel-grad-top: linear-gradient(to bottom, #1f1147 15%, rgba(31, 17, 71, 0));
    --reel-grad-btm: linear-gradient(to top, #1f1147 15%, rgba(31, 17, 71, 0));
  }

  /* ==================== 动画关键帧定义 ==================== */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulseWinner {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  @keyframes resultGlow {
    0% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
    50% { box-shadow: 0 0 24px rgba(124, 58, 237, 0.5); }
    100% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
  }

  /* ==================== 全局与重置 ==================== */
  * { box-sizing: border-box; }
  html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
  body {
    margin: 0;
    min-height: 100svh;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.7 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden; /* 防止入场动画产生滚动条 */
  }

  /* ==================== 布局 ==================== */
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: clamp(16px, 3vw, 32px);
    padding-top: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-top));
    padding-bottom: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-bottom));
  }
  .grid { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
  @media (min-width: 960px) { .grid { grid-template-columns: 1.1fr .9fr; } }
  .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
  @media (max-width: 720px) { .row > * { flex: 1 1 100%; } }

  /* ==================== 文字 ==================== */
  h1 {
    margin: 0 0 8px;
    color: #3c2d6b;
    font-size: clamp(22px, 3.8vw, 32px);
    font-weight: 800;
    letter-spacing: .2px;
    animation: fadeInUp 0.6s ease-out backwards;
  }
  h3 {
    margin: 20px 0 16px;
    padding-bottom: 8px;
    color: #4a3b7d;
    font-size: clamp(16px, 2.8vw, 20px);
    font-weight: 700;
    border-bottom: 1px solid var(--accent-100);
  }
  section.card > h3:first-child { margin-top: 0; }
  .sub {
    color: var(--muted);
    margin: 0 0 20px;
    font-size: 15px;
    animation: fadeInUp 0.6s 0.1s ease-out backwards;
  }
  .small { font-size: 13px; color: var(--muted); }

  /* ==================== 组件 ==================== */
  .card {
    padding: clamp(16px, 3vw, 24px);
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* 增强交互动画 */
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-hover);
  }
  .grid > .card:nth-child(1) { animation: fadeInUp 0.6s 0.2s ease-out backwards; }
  .grid > .card:nth-child(2) { animation: fadeInUp 0.6s 0.3s ease-out backwards; }

  /* 为动态出现的模块添加入场动画 */
  #mapping, #range {
    animation: fadeInUp 0.5s ease-out;
  }
  
  .list {
    padding: 10px;
    max-height: 40svh;
    overflow: auto;
    background: #fff;
    border: 1px solid var(--accent-100);
    border-radius: 12px;
  }
  .drop {
    padding: 24px 14px;
    text-align: center;
    background: rgba(250, 248, 255, 0.8);
    border: 2px dashed var(--accent-300);
    border-radius: 14px;
    transition: background-color .2s ease, border-color .2s ease;
  }
  .drop.drag { background: #f1eaff; border-color: var(--accent-600); }

  .result {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 56px;
    padding: 12px 16px;
    text-align: center;
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    letter-spacing: .5px;
    background: linear-gradient(135deg, var(--accent-700), var(--accent-500));
    border-radius: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    /* 中奖结果动画 */
    animation: resultGlow 2.5s infinite ease-in-out, pulseWinner 0.6s ease-out;
  }
  
  /* ==================== 表单 ==================== */
  input, select, textarea, button { font-size: 16px; }
  input[type="number"], input[type="text"], select, textarea {
    width: 100%;
    padding: 12px 14px;
    background-color: #fdfcff;
    border: 1px solid var(--accent-100);
    border-radius: 10px;
    outline: 0;
    box-shadow: var(--shadow-inset);
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
    border-color: var(--accent-300);
    box-shadow: var(--shadow-inset), 0 0 0 4px rgba(124, 58, 237, .15);
  }
  textarea { line-height: 1.6; min-height: 60px; }
  input[type="checkbox"], input[type="radio"] { accent-color: var(--accent-600); }
  
  .btn {
    position: relative; /* 为流光效果定位 */
    overflow: hidden;   /* 隐藏超出范围的流光 */
    padding: 12px 18px;
    color: #fff;
    font-weight: 700;
    letter-spacing: .4px;
    background-image: linear-gradient(145deg, var(--accent-500), var(--accent-600));
    border: 0;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(124, 58, 237, .2), 0 1px 3px rgba(124, 58, 237, .3);
    cursor: pointer;
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover {
    transform: translateY(-2px);
    filter: saturate(1.1) brightness(1.05);
    box-shadow: 0 8px 18px rgba(124, 58, 237, .28), 0 2px 5px rgba(124, 58, 237, .3);
  }
  .btn:active { transform: translateY(0px); filter: brightness(0.95); }
  .btn:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(50%); transform: none; }
  
  /* 流光动画效果 */
  .btn::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
    transform: rotate(30deg) translateX(-150%);
    transition: transform 0.8s ease;
  }
  .btn:hover::after {
    transform: rotate(30deg) translateX(150%);
  }

  .btn.ghost {
    color: #3b2a69;
    font-weight: 600;
    background: rgba(243, 240, 255, 0.8);
    border: 1px solid var(--accent-100);
    box-shadow: none;
    transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
  }
  .btn.ghost:hover { background-color: var(--accent-50); border-color: var(--accent-300); transform: translateY(-1px); }
  .btn.ok { background-image: linear-gradient(145deg, #34d399, #10b981); box-shadow: 0 4px 12px rgba(22,163,74,.25); }
  .btn.bad { background-image: linear-gradient(145deg, #f87171, #ef4444); box-shadow: 0 4px 12px rgba(239,68,68,.25); }
  @media (max-width: 720px) { .btn { width: 100%; } }

  /* ==================== 老虎机动画 ==================== */
  .reelsWrap { display: flex; justify-content: center; }
  .reel {
    position: relative;
    width: var(--reel-w);
    height: calc(var(--cell-h) * 3);
    overflow: hidden;
    background: var(--reel-bg);
    border-radius: 14px;
    box-shadow: inset 0 0 12px rgba(0,0,0,.5), 0 15px 40px rgba(31,17,71,.3);
  }
  .strip { position: absolute; top: 0; left: 0; right: 0; will-change: transform; }
  .cell {
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    padding: 0 16px;
    overflow: hidden;
    color: #e0d9ff;
    font-size: 1.1em;
    font-weight: 700;
    white-space: nowrap;
    text-overflow: ellipsis;
    letter-spacing: .2px;
    text-shadow: 0 0 8px rgba(230, 220, 255, 0.3);
  }
  .cell.under-hidden { visibility: hidden; }
  .reel::before, .reel::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    height: calc(var(--cell-h) * 1.1);
    pointer-events: none;
    z-index: 2;
  }
  .reel::before { top: 0; background: var(--reel-grad-top); }
  .reel::after { bottom: 0; background: var(--reel-grad-btm); }
  
  .marker {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    height: var(--cell-h);
    pointer-events: none;
  }
  .marker::before {
    content: '';
    position: absolute;
    inset: 4px 8px;
    border-radius: 10px;
    background: linear-gradient(90deg, var(--accent-500), var(--accent-300));
    opacity: 0.2;
    filter: blur(8px);
  }
  .marker::after {
    content: '';
    position: absolute;
    inset: 2px 6px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.6);
  }

  .overlay {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    z-index: 3;
  }
  .overlay.show { opacity: 1; }
  #history { max-height: 34svh; }

  /* ==================== 按姓名范围列表 ==================== */
  :root {
    --name-maxh: clamp(380px, 64svh, 820px);
    --name-font: 18px;
    --name-line: 1.35;
    --name-item-pad-y: 6px;
    --name-item-gap: 10px;
    --name-check-size: 18px;
    --name-cols: 3;
  }
  #nameRange .row { gap: 8px; }
  #nameRange #nameSearch { height: 44px; padding: 12px 14px; font-size: var(--name-font); line-height: 1.2; }
  #nameRange .btn { font-size: 15px; padding: 10px 14px; border-radius: 10px; }

  #nameList {
    display: grid;
    grid-template-columns: repeat(var(--name-cols), minmax(0, 1fr));
    gap: 4px 8px;
    padding: 8px;
    max-height: var(--name-maxh);
    font-size: var(--name-font);
    line-height: var(--name-line);
    border-radius: 12px;
  }
  #nameList label {
    display: flex;
    align-items: center;
    gap: var(--name-item-gap);
    min-width: 0;
    padding: var(--name-item-pad-y) 10px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  #nameList label:hover { background: var(--accent-50); }
  #nameList input[type="checkbox"] { flex: 0 0 auto; width: var(--name-check-size); height: var(--name-check-size); }
  #nameList .nm { min-width: 0; overflow: hidden; text-overflow: ellipsis; }
  #nameList input[type="checkbox"]:checked + .nm { color: var(--accent-700); font-weight: 600; }

  @media (max-width: 900px) { :root { --name-cols: 2; } }
  @media (max-width: 560px) { :root { --name-cols: 1; --name-font:17px; --name-check-size:17px; } }

  /* ==================== 功能类 ==================== */
  ::selection { background: var(--accent-300); color:#fff; }
  ::-webkit-scrollbar { width: 10px; height: 10px; }
  ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent-300), var(--accent-600)); border-radius: 8px; border: 2px solid var(--accent-50); }
  ::-webkit-scrollbar-track { background: var(--accent-50); border-radius: 8px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>本地名单抽奖（结果与滚动一致）</h1>
  <p class="sub">支持 TXT/CSV/XLS/XLSX；自动识别编码（UTF-8/UTF-16/GBK/GB18030/Big5/Shift_JIS…）；按学号/姓名范围；同轮不重复；随机种子；导出 CSV。</p>

  <div class="grid">
    <section class="card">
      <h3>① 导入名单</h3>
      <div class="row">
        <label class="btn ghost" for="file">选择文件</label>
        <input id="file" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none">
        <button id="btnClear" class="btn ghost">清空</button>
      </div>
      <div id="dz" class="drop" style="margin-top:10px">拖拽 TXT/CSV/XLS/XLSX 到此处，或点击“选择文件”
        <div class="small">TXT/CSV 每行可写“姓名,学号”或单列；Excel 支持“序号|姓名|序号|姓名”。编码将自动识别。</div>
        <div id="encInfo" class="small"></div>
      </div>

      <div id="mapping" style="margin-top:12px;display:none">
        <h3>② 列映射（检测到表头，可调整）</h3>
        <div class="row">姓名列：<select id="selName"></select> 学号列：<select id="selId"></select> <button id="applyMap" class="btn ghost">应用映射</button></div>
        <div id="sample" class="small" style="margin-top:6px"></div>
      </div>

      <div id="range" style="margin-top:12px;display:none">
        <h3>③ 抽取范围</h3>
        <div class="row"><label><input type="radio" name="mode" value="id" checked> 按学号</label><label><input type="radio" name="mode" value="name"> 按姓名</label></div>

        <div id="idRange" style="margin-top:6px">
          <div class="row">学号区间：<input id="idMin" type="number" placeholder="起始"><span style="align-self:center">—</span><input id="idMax" type="number" placeholder="结束"><button id="fillMM" class="btn ghost">用最小/最大填充</button></div>
          <div class="small">只在导入数据中存在的学号里抽。</div>
        </div>

        <div id="nameRange" style="display:none;margin-top:6px">
          <div class="row"><input id="nameSearch" type="text" placeholder="搜索姓名" style="flex:1"><button id="all" class="btn ghost">全选</button><button id="none" class="btn ghost">全不选</button></div>
          <div id="nameList" class="list" style="margin-top:6px"></div>
        </div>

        <div style="margin-top:8px"><div class="small">排除名单（姓名或学号，逗号/空格分隔）：</div><textarea id="exclude" placeholder="例：张三 10021,10023 李四"></textarea></div>
      </div>
    </section>

    <section class="card">
      <h3>④ 抽取设置与结果</h3>
      <div class="row">
        连抽次数：<input id="count" type="number" min="1" value="1" style="width:110px">
        <label><input id="noRepeat" type="checkbox" checked> 同轮不重复</label>
      </div>
      <div class="row" style="margin-top:6px">随机种子（可选，保证可复现）：<input id="seed" type="text" placeholder="留空使用系统随机" style="flex:1"></div>
      <div class="row" style="margin-top:8px"><button id="start" class="btn ok">开始抽取</button><button id="stop" class="btn bad" disabled>停止</button><button id="export" class="btn">导出中奖CSV</button></div>

      <div class="reelsWrap" style="margin-top:10px">
        <div class="reel">
          <div id="strip" class="strip"></div>
          <div class="marker"></div>
          <div id="overlay" class="overlay"></div>
        </div>
      </div>

      <div id="screen" class="result" style="margin-top:10px" aria-live="polite">等待抽取…</div>
      <div class="row" style="margin-top:8px"><span class="small">已导入：<b id="statTotal">0</b> | 候选数：<b id="statCand">0</b></span></div>
      <h3 style="margin-top:12px">历史记录</h3>
      <div id="history" class="list small"></div>
    </section>
  </div>

  <p class="small" style="margin-top:10px;color:#6b7280">动画由 <code>requestAnimationFrame</code> 驱动，位移用 <code>transform: translateY</code>，溢出用 <code>overflow:hidden</code> 裁剪；文本文件采用智能编码检测解析。</p>
</div>

<script>
/* ========== PRNG ========== */
function mulberry32(seed){let t=seed>>>0;return()=>{t+=0x6D2B79F5;let r=Math.imul(t^(t>>>15),1|t);r^=r+Math.imul(r^(r>>>7),61|r);return((r^(r>>>14))>>>0)/4294967296}}
function hashSeed(s){let h=2166136261>>>0;for(const ch of s){h^=ch.charCodeAt(0);h=Math.imul(h,16777619)}return h>>>0}
let rng=Math.random;

/* ========== 状态 ========== */
let entries=[], candidates=[], winnersAll=[];
let autoRun=false, spinning=false;

const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function clean(v){ if(v==null) return ""; return String(v).replace(/\s+/g," ").trim() }
function isCJK(s){ return /[\u3400-\u9FFF]/.test(s) }
function looksId(s){ return /^\d+$/.test(s) }
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ========== 智能编码识别（BOM优先 + 候选评分） ========== */
function decodeSmart(u8){
  const encInfoEl = document.getElementById('encInfo');
  const hasBOM = (u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) ||
                 (u8.length>=2 && ((u8[0]===0xFF && u8[1]===0xFE) || (u8[0]===0xFE && u8[1]===0xFF)));
  try{
    if(u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF){
      const txt = new TextDecoder('utf-8').decode(u8.subarray(3));
      encInfoEl.textContent = '编码：UTF-8 (BOM)';
      return txt;
    }
    if(u8.length>=2 && u8[0]===0xFF && u8[1]===0xFE){
      const txt = new TextDecoder('utf-16le').decode(u8.subarray(2));
      encInfoEl.textContent = '编码：UTF-16LE (BOM)';
      return txt;
    }
    if(u8.length>=2 && u8[0]===0xFE && u8[1]===0xFF){
      const txt = new TextDecoder('utf-16be').decode(u8.subarray(2));
      encInfoEl.textContent = '编码：UTF-16BE (BOM)';
      return txt;
    }
  }catch(e){}

  const labels = ['utf-8','gb18030','gbk','big5','shift_jis','euc-kr','windows-1252','iso-8859-1','koi8-r','macintosh','utf-16le','utf-16be'];
  let best = {score:-Infinity, text:null, label:null};
  for(const lb of labels){
    try{
      const dec = new TextDecoder(lb, {fatal:false, ignoreBOM:true});
      const txt = dec.decode(u8);
      const bad = (txt.match(/\uFFFD/g)||[]).length;
      const ctl = (txt.match(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g)||[]).length;
      const cjk = (txt.match(/[\u3400-\u9FFF\uF900-\uFAFF]/g)||[]).length;
      let score = 1000 - bad*100 - ctl*2 + cjk;
      if(lb==='utf-8') score += 10;
      if(/^windows|iso-8859|macintosh/i.test(lb)) score -= 5;
      if(score > best.score) best = {score, text:txt, label:lb};
    }catch(e){}
  }
  if(best.text!=null){
    encInfoEl.textContent = `编码（推测）：${best.label}${hasBOM?' + BOM':''}`;
    return best.text;
  }
  try{
    const txt = new TextDecoder().decode(u8);
    encInfoEl.textContent = '编码：未知（使用默认解码）';
    return txt;
  }catch(e){
    encInfoEl.textContent = '编码：解码失败';
    throw e;
  }
}

/* ========== 文件读取 ========== */
const dz=$('#dz');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0])});
$('#file').addEventListener('change',e=>{if(e.target.files[0]) handleFile(e.target.files[0])});
$('#btnClear').addEventListener('click',()=>{entries=[];candidates=[];winnersAll=[];updateStats();$('#mapping').style.display='none';$('#range').style.display='none';$('#screen').textContent='等待抽取…';$('#history').innerHTML=''; $('#encInfo').textContent=''; buildStrip([]); });

function handleFile(file){
  const n=file.name.toLowerCase();
  if(n.endsWith('.xlsx')||n.endsWith('.xls')){
    const fr=new FileReader(); fr.onload=()=>parseExcel(fr.result); fr.readAsArrayBuffer(file);
  }else{
    const fr=new FileReader();
    fr.onload=()=>{
      const u8 = new Uint8Array(fr.result);
      let text = '';
      try{ text = decodeSmart(u8); }catch(err){ alert('无法识别文本编码：'+(err&&err.message||err)); return; }
      parseText(text);
    };
    fr.readAsArrayBuffer(file);
  }
}

function parseExcel(buf){
  const wb=XLSX.read(new Uint8Array(buf),{type:'array'}), sh=wb.Sheets[wb.SheetNames[0]];
  const aoa=XLSX.utils.sheet_to_json(sh,{header:1,raw:false,defval:""}); processAOA(aoa);
}

/* 传入已智能解码的纯文本 */
function parseText(text){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const aoa=lines.map(line=>{
    let cells=line.split(/,|，/);
    if(cells.length===1) cells=line.split(/\t+/);
    if(cells.length===1) cells=line.split(/\s+/);
    return cells.map(clean);
  });
  processAOA(aoa);
}

/* ========== AOA -> entries（兼容表头 & 两列成组） ========== */
function processAOA(aoa){
  const rows=aoa.filter(r=> (r||[]).some(c=>clean(c)!=="")); if(!rows.length){ alert('未解析到有效数据'); return; }
  const keyName=/姓名|name|学生姓名|同学/i, keyId=/学号|学籍号|编号|序号|id|number|no/i;
  let header=-1, nameIdx=-1, idIdx=-1;
  for(let i=0;i<Math.min(10,rows.length);i++){
    const r=rows[i].map(clean);
    for(let c=0;c<r.length;c++){ if(nameIdx===-1&&keyName.test(r[c])) nameIdx=c, header=i; if(idIdx===-1&&keyId.test(r[c])) idIdx=c, header=i; }
    if(header===i && (nameIdx!==-1 || idIdx!==-1)) break;
  }
  let parsed=[];
  if(header!==-1){
    for(let i=header+1;i<rows.length;i++){ const r=rows[i].map(clean); const name=nameIdx!==-1?clean(r[nameIdx]):""; const id=idIdx!==-1?clean(r[idIdx]):""; if(name||id) parsed.push({name,id}); }
    showMapping(rows[header]);
  }else{
    for(const r0 of rows){
      const r=r0.map(clean);
      for(let c=0;c<r.length;c+=2){
        const a=r[c]??"", b=r[c+1]??""; if(!a&&!b) continue;
        if(/^\d+$/.test(a)&&isCJK(b)) parsed.push({id:String(a),name:b});
        else if(isCJK(a)&&/^\d+$/.test(b)) parsed.push({id:String(b),name:a});
        else if(isCJK(a)&&!b) parsed.push({id:"",name:a});
        else if(isCJK(b)&&!a) parsed.push({id:"",name:b});
      }
    }
    $('#mapping').style.display='none'; $('#range').style.display='';
  }
  const seen=new Set();
  entries=parsed.filter(x=>{const key=(x.name||"")+"|"+(x.id||""); if(!x.name&&!x.id) return false; if(seen.has(key)) return false; seen.add(key); return true;})
               .map(x=>({name:x.name,id:x.id,label:x.name&&x.id?`${x.name}（${x.id}）`:(x.name||x.id)}));
  buildNameList(); fillIdMM(); updateCandidates(); updateStats(); $('#screen').textContent='数据已载入，设置范围后可开始抽取';
}
function showMapping(headerRow){
  const cols=headerRow.map((v,i)=>({i,label:clean(v)||(`列${i+1}`)}));
  const selN=$('#selName'), selI=$('#selId');
  selN.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
  selI.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
  $('#mapping').style.display=''; $('#range').style.display='';
  $('#applyMap').onclick=()=>{ alert('已应用映射。为简洁起见，请按新映射重新导入一次文件。'); };
  $('#sample').textContent='已检测到表头：'+headerRow.map(clean).join(' | ');
}

/* ========== 范围 & 候选 ========== */
function buildNameList(){
  const box=$('#nameList');
  const names=[...new Set(entries.map(e=>e.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'zh'));
  box.innerHTML=names.map(n=>{
    const safe = escapeHtml(n);
    return `<label><input type="checkbox" class="cbN" value="${safe}" checked><span class="nm">${safe}</span></label>`;
  }).join('');
  $('#nameSearch').oninput=()=>{
    const kw=$('#nameSearch').value.trim();
    $$('.cbN').forEach(cb=>{
      const lab=cb.closest('label');
      const show=!kw || cb.value.includes(kw);
      lab.style.display=show?'flex':'none';
    });
  };
  $('#all').onclick=()=>{$$('.cbN').forEach(cb=>cb.checked=true); updateCandidates();};
  $('#none').onclick=()=>{$$('.cbN').forEach(cb=>cb.checked=false); updateCandidates();};
}
function fillIdMM(){ const ids=entries.map(e=>e.id).filter(v=>/^\d+$/.test(v)).map(Number); if(ids.length){ $('#idMin').value=Math.min(...ids); $('#idMax').value=Math.max(...ids); } }
$('#fillMM').onclick=fillIdMM;
$$('input[name="mode"]').forEach(r=> r.addEventListener('change',()=>{
  const m=document.querySelector('input[name="mode"]:checked').value;
  $('#idRange').style.display=m==='id'?'':'none';
  $('#nameRange').style.display=m==='name'?'':'none';
  updateCandidates();
}));
['idMin','idMax','exclude'].forEach(id=> document.getElementById(id).addEventListener('input', updateCandidates));
document.addEventListener('change', e=>{ if(e.target.classList && e.target.classList.contains('cbN')) updateCandidates(); });

function updateCandidates(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  const excl=new Set( ($('#exclude').value.trim().split(/[\s,，;；]+/).filter(Boolean)) );
  let pool=[];
  if(mode==='id'){
    const min=+($('#idMin').value||Number.NEGATIVE_INFINITY), max=+($('#idMax').value||Number.POSITIVE_INFINITY);
    pool=entries.filter(e=> /^\d+$/.test(e.id) && +e.id>=min && +e.id<=max );
  }else{
    const allowed=new Set([...document.querySelectorAll('.cbN:checked')].map(cb=>cb.value));
    pool=entries.filter(e=> e.name && allowed.has(e.name));
  }
  pool=pool.filter(e=> !(excl.has(e.name)||excl.has(e.id)) );
  candidates=pool; updateStats(); buildStrip(candidates);
}
function updateStats(){ $('#statTotal').textContent=entries.length; $('#statCand').textContent=candidates.length; }

/* ========== 老虎机：确保“滚动看到的=抽中结果” ========== */
const VISIBLE_ROWS=3, CENTER_INDEX=1, COPIES=3, MAX_N_DOM=400;
const stripEl=document.getElementById('strip'), overlayEl=document.getElementById('overlay');

function buildStrip(list){
  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
  const baseCount=Math.max(list.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
  stripEl.dataset.ndom=String(Ndom);
  for(let k=0;k<COPIES;k++){
    for(let i=0;i<Ndom;i++){
      const d=document.createElement('div'); d.className='cell';
      const data=list.length?list[i%list.length]:{label:String(i+1)};
      d.textContent=data.label; stripEl.appendChild(d);
    }
  }
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}
function buildStripForSpin(snapshot, winnerIdx){
  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
  const baseCount=Math.max(snapshot.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
  stripEl.dataset.ndom=String(Ndom);
  const start=(winnerIdx - (CENTER_INDEX + 1) + snapshot.length) % snapshot.length;
  for(let k=0;k<COPIES;k++){
    for(let i=0;i<Ndom;i++){
      const data = snapshot[(start + i) % snapshot.length];
      const d=document.createElement('div'); d.className='cell'; d.textContent=data.label; stripEl.appendChild(d);
    }
  }
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
function spinToCenter(){
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const Ndom=parseInt(stripEl.dataset.ndom,10)||VISIBLE_ROWS;
  const base=-CENTER_INDEX*cellH;
  const spins=14, duration=1400, travel=spins*Ndom*cellH;
  return new Promise(resolve=>{
    const t0=performance.now();
    function frame(now){
      const t=Math.max(0,Math.min(1,(now-t0)/duration));
      const yRaw=-travel*easeOutCubic(t);
      const yLoop=-(Math.abs(yRaw)%(Ndom*cellH));
      stripEl.style.transform=`translateY(${base + yLoop}px)`;
      if(t<1) requestAnimationFrame(frame); else { stripEl.style.transform=`translateY(${base}px)`; resolve(); }
    }
    requestAnimationFrame(frame);
  });
}
function pickFromSnapshot(snapshot, excludeSet){
  const idxPool=[]; for(let i=0;i<snapshot.length;i++){ const key=snapshot[i].name+'|'+snapshot[i].id; if(!excludeSet || !excludeSet.has(key)) idxPool.push(i); }
  if(!idxPool.length) return null;
  const chosenIndexInPool = Math.floor(rng()*idxPool.length);
  const idxSnap = idxPool[chosenIndexInPool];
  const item = snapshot[idxSnap];
  const idxGlobal = candidates.findIndex(e=> e===item || (e.name===item.name && e.id===item.id));
  return { item, idxSnap, idxGlobal };
}
function renderHistory(){
  $('#history').innerHTML=winnersAll.slice().reverse().map(rec=>{
    const line=rec.list.length?rec.list.map(x=>x.label).join('、'):'（无）';
    return `<div style="padding:6px 0;border-bottom:1px dashed #e5e7eb"><div><b>${rec.time}</b></div><div>${line}</div></div>`;
  }).join('');
}
function setBusy(b){ spinning=b; $('#start').disabled=b; $('#stop').disabled=!b; }
$('#start').onclick = async ()=>{
  if(spinning||autoRun) return;
  if(!candidates.length){ alert('候选集为空：请检查范围/排除设置'); return; }
  rng = ($('#seed').value.trim()) ? mulberry32(hashSeed($('#seed').value.trim())) : Math.random;

  const N=Math.max(1, Math.floor(+$('#count').value||1));
  const used=new Set(); autoRun=true; setBusy(true);

  for(let i=0;i<N && autoRun;i++){
    const snapshot=candidates.slice();
    const pick=pickFromSnapshot(snapshot, $('#noRepeat').checked ? used : null);
    if(!pick){ break; }

    buildStripForSpin(snapshot, pick.idxSnap);
    await spinToCenter();
    const under = stripEl.children[CENTER_INDEX+1]; if(under) under.classList.add('under-hidden');
    requestAnimationFrame(()=>{ $('#overlay').textContent = pick.item.label; $('#overlay').classList.add('show'); });
    $('#screen').textContent='🎉 '+pick.item.label;

    const when=new Date().toLocaleString(); winnersAll.push({time:when,list:[pick.item]}); renderHistory();

    if($('#noRepeat').checked){
      used.add(pick.item.name+'|'+pick.item.id);
    }
    await new Promise(r=>setTimeout(r, 300));
  }
  autoRun=false; setBusy(false);
};
$('#stop').onclick=()=>{autoRun=false;};
$('#export').onclick=()=>{
  if(!winnersAll.length){ alert('暂无中奖记录'); return; }
  const rows=[['时间','序号','姓名','学号','显示标签']];
  winnersAll.forEach(rec=> rec.list.forEach((p,i)=> rows.push([rec.time,i+1,p.name,p.id,p.label])) );
  const csv=rows.map(r=> r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
};

buildStrip([]);
</script>
</body>
</html>