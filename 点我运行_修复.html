<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æœ¬åœ°åå•æŠ½å¥– Â· è€è™æœºåŠ¨ç”»ï¼ˆç´«è‰²ä¸»é¢˜ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* ==================== è§†è§‰ç¾åŒ– V3 (åŠ¨ç”»å¢å¼ºç‰ˆ) - ä¸»é¢˜è°ƒè‰²æ¿ ==================== */
  :root {
    --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --panel: rgba(255, 255, 255, 0.75);
    --panel-border: rgba(233, 213, 255, 0.5);
    --text: #2d3748;
    --muted: #718096;
    --accent-50: #f5f3ff;
    --accent-100: #ede9fe;
    --accent-300: #c4b5fd;
    --accent-500: #8b5cf6;
    --accent-600: #7c3aed;
    --accent-700: #6d28d9;
    --ok: #28a745;
    --bad: #dc3545;
    --radius: 16px;
    --gap: 16px;
    --shadow: 0 10px 30px rgba(109, 40, 217, .12);
    --shadow-hover: 0 18px 40px rgba(109, 40, 217, .18);
    --shadow-inset: inset 0 2px 4px rgba(0,0,0,0.04);
    --cell-h: 56px;
    --reel-w: min(520px, 94vw);
    --reel-bg: #1f1147;
    --reel-grad-top: linear-gradient(to bottom, #1f1147 15%, rgba(31, 17, 71, 0));
    --reel-grad-btm: linear-gradient(to top, #1f1147 15%, rgba(31, 17, 71, 0));
  }

  /* ==================== åŠ¨ç”»å…³é”®å¸§å®šä¹‰ ==================== */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulseWinner {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  @keyframes resultGlow {
    0% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
    50% { box-shadow: 0 0 24px rgba(124, 58, 237, 0.5); }
    100% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
  }

  /* ==================== å…¨å±€ä¸é‡ç½® ==================== */
  * { box-sizing: border-box; }
  html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
  body {
    margin: 0;
    min-height: 100svh;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.7 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden; /* é˜²æ­¢å…¥åœºåŠ¨ç”»äº§ç”Ÿæ»šåŠ¨æ¡ */
  }

  /* ==================== å¸ƒå±€ ==================== */
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: clamp(16px, 3vw, 32px);
    padding-top: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-top));
    padding-bottom: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-bottom));
  }
  .grid { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
  @media (min-width: 960px) { .grid { grid-template-columns: 1.1fr .9fr; } }
  .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
  @media (max-width: 720px) { .row > * { flex: 1 1 100%; } }

  /* ==================== æ–‡å­— ==================== */
  h1 {
    margin: 0 0 8px;
    color: #3c2d6b;
    font-size: clamp(22px, 3.8vw, 32px);
    font-weight: 800;
    letter-spacing: .2px;
    animation: fadeInUp 0.6s ease-out backwards;
  }
  h3 {
    margin: 20px 0 16px;
    padding-bottom: 8px;
    color: #4a3b7d;
    font-size: clamp(16px, 2.8vw, 20px);
    font-weight: 700;
    border-bottom: 1px solid var(--accent-100);
  }
  section.card > h3:first-child { margin-top: 0; }
  .sub {
    color: var(--muted);
    margin: 0 0 20px;
    font-size: 15px;
    animation: fadeInUp 0.6s 0.1s ease-out backwards;
  }
  .small { font-size: 13px; color: var(--muted); }

  /* ==================== ç»„ä»¶ ==================== */
  .card {
    padding: clamp(16px, 3vw, 24px);
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* å¢å¼ºäº¤äº’åŠ¨ç”» */
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-hover);
  }
  .grid > .card:nth-child(1) { animation: fadeInUp 0.6s 0.2s ease-out backwards; }
  .grid > .card:nth-child(2) { animation: fadeInUp 0.6s 0.3s ease-out backwards; }

  /* ä¸ºåŠ¨æ€å‡ºç°çš„æ¨¡å—æ·»åŠ å…¥åœºåŠ¨ç”» */
  #mapping, #range {
    animation: fadeInUp 0.5s ease-out;
  }
  
  .list {
    padding: 10px;
    max-height: 40svh;
    overflow: auto;
    background: #fff;
    border: 1px solid var(--accent-100);
    border-radius: 12px;
  }
  .drop {
    padding: 24px 14px;
    text-align: center;
    background: rgba(250, 248, 255, 0.8);
    border: 2px dashed var(--accent-300);
    border-radius: 14px;
    transition: background-color .2s ease, border-color .2s ease;
  }
  .drop.drag { background: #f1eaff; border-color: var(--accent-600); }

  .result {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 56px;
    padding: 12px 16px;
    text-align: center;
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    letter-spacing: .5px;
    background: linear-gradient(135deg, var(--accent-700), var(--accent-500));
    border-radius: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    /* ä¸­å¥–ç»“æœåŠ¨ç”» */
    animation: resultGlow 2.5s infinite ease-in-out, pulseWinner 0.6s ease-out;
  }
  
  /* ==================== è¡¨å• ==================== */
  input, select, textarea, button { font-size: 16px; }
  input[type="number"], input[type="text"], select, textarea {
    width: 100%;
    padding: 12px 14px;
    background-color: #fdfcff;
    border: 1px solid var(--accent-100);
    border-radius: 10px;
    outline: 0;
    box-shadow: var(--shadow-inset);
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
    border-color: var(--accent-300);
    box-shadow: var(--shadow-inset), 0 0 0 4px rgba(124, 58, 237, .15);
  }
  textarea { line-height: 1.6; min-height: 60px; }
  input[type="checkbox"], input[type="radio"] { accent-color: var(--accent-600); }
  
  .btn {
    position: relative; /* ä¸ºæµå…‰æ•ˆæœå®šä½ */
    overflow: hidden;   /* éšè—è¶…å‡ºèŒƒå›´çš„æµå…‰ */
    padding: 12px 18px;
    color: #fff;
    font-weight: 700;
    letter-spacing: .4px;
    background-image: linear-gradient(145deg, var(--accent-500), var(--accent-600));
    border: 0;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(124, 58, 237, .2), 0 1px 3px rgba(124, 58, 237, .3);
    cursor: pointer;
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover {
    transform: translateY(-2px);
    filter: saturate(1.1) brightness(1.05);
    box-shadow: 0 8px 18px rgba(124, 58, 237, .28), 0 2px 5px rgba(124, 58, 237, .3);
  }
  .btn:active { transform: translateY(0px); filter: brightness(0.95); }
  .btn:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(50%); transform: none; }
  
  /* æµå…‰åŠ¨ç”»æ•ˆæœ */
  .btn::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
    transform: rotate(30deg) translateX(-150%);
    transition: transform 0.8s ease;
  }
  .btn:hover::after {
    transform: rotate(30deg) translateX(150%);
  }

  .btn.ghost {
    color: #3b2a69;
    font-weight: 600;
    background: rgba(243, 240, 255, 0.8);
    border: 1px solid var(--accent-100);
    box-shadow: none;
    transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
  }
  .btn.ghost:hover { background-color: var(--accent-50); border-color: var(--accent-300); transform: translateY(-1px); }
  .btn.ok { background-image: linear-gradient(145deg, #34d399, #10b981); box-shadow: 0 4px 12px rgba(22,163,74,.25); }
  .btn.bad { background-image: linear-gradient(145deg, #f87171, #ef4444); box-shadow: 0 4px 12px rgba(239,68,68,.25); }
  @media (max-width: 720px) { .btn { width: 100%; } }

  /* ==================== è€è™æœºåŠ¨ç”» ==================== */
  .reelsWrap { display: flex; justify-content: center; }
  .reel {
    position: relative;
    width: var(--reel-w);
    height: calc(var(--cell-h) * 3);
    overflow: hidden;
    background: var(--reel-bg);
    border-radius: 14px;
    box-shadow: inset 0 0 12px rgba(0,0,0,.5), 0 15px 40px rgba(31,17,71,.3);
  }
  .strip { position: absolute; top: 0; left: 0; right: 0; will-change: transform; }
  .cell {
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    padding: 0 16px;
    overflow: hidden;
    color: #e0d9ff;
    font-size: 1.1em;
    font-weight: 700;
    white-space: nowrap;
    text-overflow: ellipsis;
    letter-spacing: .2px;
    text-shadow: 0 0 8px rgba(230, 220, 255, 0.3);
  }
  .cell.under-hidden { visibility: hidden; }
  .reel::before, .reel::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    height: calc(var(--cell-h) * 1.1);
    pointer-events: none;
    z-index: 2;
  }
  .reel::before { top: 0; background: var(--reel-grad-top); }
  .reel::after { bottom: 0; background: var(--reel-grad-btm); }
  
  .marker {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    height: var(--cell-h);
    pointer-events: none;
  }
  .marker::before {
    content: '';
    position: absolute;
    inset: 4px 8px;
    border-radius: 10px;
    background: linear-gradient(90deg, var(--accent-500), var(--accent-300));
    opacity: 0.2;
    filter: blur(8px);
  }
  .marker::after {
    content: '';
    position: absolute;
    inset: 2px 6px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.6);
  }

  .overlay {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    z-index: 3;
  }
  .overlay.show { opacity: 1; }
  #history { max-height: 34svh; }

  /* ==================== æŒ‰å§“åèŒƒå›´åˆ—è¡¨ ==================== */
  :root {
    --name-maxh: clamp(380px, 64svh, 820px);
    --name-font: 18px;
    --name-line: 1.35;
    --name-item-pad-y: 6px;
    --name-item-gap: 10px;
    --name-check-size: 18px;
    --name-cols: 3;
  }
  #nameRange .row { gap: 8px; }
  #nameRange #nameSearch { height: 44px; padding: 12px 14px; font-size: var(--name-font); line-height: 1.2; }
  #nameRange .btn { font-size: 15px; padding: 10px 14px; border-radius: 10px; }

  #nameList {
    display: grid;
    grid-template-columns: repeat(var(--name-cols), minmax(0, 1fr));
    gap: 4px 8px;
    padding: 8px;
    max-height: var(--name-maxh);
    font-size: var(--name-font);
    line-height: var(--name-line);
    border-radius: 12px;
  }
  #nameList label {
    display: flex;
    align-items: center;
    gap: var(--name-item-gap);
    min-width: 0;
    padding: var(--name-item-pad-y) 10px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  #nameList label:hover { background: var(--accent-50); }
  #nameList input[type="checkbox"] { flex: 0 0 auto; width: var(--name-check-size); height: var(--name-check-size); }
  #nameList .nm { min-width: 0; overflow: hidden; text-overflow: ellipsis; }
  #nameList input[type="checkbox"]:checked + .nm { color: var(--accent-700); font-weight: 600; }

  @media (max-width: 900px) { :root { --name-cols: 2; } }
  @media (max-width: 560px) { :root { --name-cols: 1; --name-font:17px; --name-check-size:17px; } }

  /* ==================== åŠŸèƒ½ç±» ==================== */
  ::selection { background: var(--accent-300); color:#fff; }
  ::-webkit-scrollbar { width: 10px; height: 10px; }
  ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent-300), var(--accent-600)); border-radius: 8px; border: 2px solid var(--accent-50); }
  ::-webkit-scrollbar-track { background: var(--accent-50); border-radius: 8px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>æœ¬åœ°åå•æŠ½å¥–ï¼ˆç»“æœä¸æ»šåŠ¨ä¸€è‡´ï¼‰</h1>
  <p class="sub">æ”¯æŒ TXT/CSV/XLS/XLSXï¼›è‡ªåŠ¨è¯†åˆ«ç¼–ç ï¼ˆUTF-8/UTF-16/GBK/GB18030/Big5/Shift_JISâ€¦ï¼‰ï¼›æŒ‰å­¦å·/å§“åèŒƒå›´ï¼›åŒè½®ä¸é‡å¤ï¼›éšæœºç§å­ï¼›å¯¼å‡º CSVã€‚</p>

  <div class="grid">
    <section class="card">
      <h3>â‘  å¯¼å…¥åå•</h3>
      <div class="row">
        <label class="btn ghost" for="file">é€‰æ‹©æ–‡ä»¶</label>
        <input id="file" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none">
        <button id="btnClear" class="btn ghost">æ¸…ç©º</button>
      </div>
      <div id="dz" class="drop" style="margin-top:10px">æ‹–æ‹½ TXT/CSV/XLS/XLSX åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€
        <div class="small">TXT/CSV æ¯è¡Œå¯å†™â€œå§“å,å­¦å·â€æˆ–å•åˆ—ï¼›Excel æ”¯æŒâ€œåºå·|å§“å|åºå·|å§“åâ€ã€‚ç¼–ç å°†è‡ªåŠ¨è¯†åˆ«ã€‚</div>
        <div id="encInfo" class="small"></div>
      </div>

      <div id="mapping" style="margin-top:12px;display:none">
        <h3>â‘¡ åˆ—æ˜ å°„ï¼ˆæ£€æµ‹åˆ°è¡¨å¤´ï¼Œå¯è°ƒæ•´ï¼‰</h3>
        <div class="row">å§“ååˆ—ï¼š<select id="selName"></select> å­¦å·åˆ—ï¼š<select id="selId"></select> <button id="applyMap" class="btn ghost">åº”ç”¨æ˜ å°„</button></div>
        <div id="sample" class="small" style="margin-top:6px"></div>
      </div>

      <div id="range" style="margin-top:12px;display:none">
        <h3>â‘¢ æŠ½å–èŒƒå›´</h3>
        <div class="row"><label><input type="radio" name="mode" value="id" checked> æŒ‰å­¦å·</label><label><input type="radio" name="mode" value="name"> æŒ‰å§“å</label></div>

        <div id="idRange" style="margin-top:6px">
          <div class="row">å­¦å·åŒºé—´ï¼š<input id="idMin" type="number" placeholder="èµ·å§‹"><span style="align-self:center">â€”</span><input id="idMax" type="number" placeholder="ç»“æŸ"><button id="fillMM" class="btn ghost">ç”¨æœ€å°/æœ€å¤§å¡«å……</button></div>
          <div class="small">åªåœ¨å¯¼å…¥æ•°æ®ä¸­å­˜åœ¨çš„å­¦å·é‡ŒæŠ½ã€‚</div>
        </div>

        <div id="nameRange" style="display:none;margin-top:6px">
          <div class="row"><input id="nameSearch" type="text" placeholder="æœç´¢å§“å" style="flex:1"><button id="all" class="btn ghost">å…¨é€‰</button><button id="none" class="btn ghost">å…¨ä¸é€‰</button></div>
          <div id="nameList" class="list" style="margin-top:6px"></div>
        </div>

        <div style="margin-top:8px"><div class="small">æ’é™¤åå•ï¼ˆå§“åæˆ–å­¦å·ï¼Œé€—å·/ç©ºæ ¼åˆ†éš”ï¼‰ï¼š</div><textarea id="exclude" placeholder="ä¾‹ï¼šå¼ ä¸‰ 10021,10023 æå››"></textarea></div>
      </div>
    </section>

    <section class="card">
      <h3>â‘£ æŠ½å–è®¾ç½®ä¸ç»“æœ</h3>
      <div class="row">
        è¿æŠ½æ¬¡æ•°ï¼š<input id="count" type="number" min="1" value="1" style="width:110px">
        <label><input id="noRepeat" type="checkbox" checked> åŒè½®ä¸é‡å¤</label>
      </div>
      <div class="row" style="margin-top:6px">éšæœºç§å­ï¼ˆå¯é€‰ï¼Œä¿è¯å¯å¤ç°ï¼‰ï¼š<input id="seed" type="text" placeholder="ç•™ç©ºä½¿ç”¨ç³»ç»Ÿéšæœº" style="flex:1"></div>
      <div class="row" style="margin-top:8px"><button id="start" class="btn ok">å¼€å§‹æŠ½å–</button><button id="stop" class="btn bad" disabled>åœæ­¢</button><button id="export" class="btn">å¯¼å‡ºä¸­å¥–CSV</button></div>

      <div class="reelsWrap" style="margin-top:10px">
        <div class="reel">
          <div id="strip" class="strip"></div>
          <div class="marker"></div>
          <div id="overlay" class="overlay"></div>
        </div>
      </div>

      <div id="screen" class="result" style="margin-top:10px" aria-live="polite">ç­‰å¾…æŠ½å–â€¦</div>
      <div class="row" style="margin-top:8px"><span class="small">å·²å¯¼å…¥ï¼š<b id="statTotal">0</b> | å€™é€‰æ•°ï¼š<b id="statCand">0</b></span></div>
      <h3 style="margin-top:12px">å†å²è®°å½•</h3>
      <div id="history" class="list small"></div>
    </section>
  </div>

  <p class="small" style="margin-top:10px;color:#6b7280">åŠ¨ç”»ç”± <code>requestAnimationFrame</code> é©±åŠ¨ï¼Œä½ç§»ç”¨ <code>transform: translateY</code>ï¼Œæº¢å‡ºç”¨ <code>overflow:hidden</code> è£å‰ªï¼›æ–‡æœ¬æ–‡ä»¶é‡‡ç”¨æ™ºèƒ½ç¼–ç æ£€æµ‹è§£æã€‚</p>
</div>

<script>
/* ========== PRNG ========== */
function mulberry32(seed){let t=seed>>>0;return()=>{t+=0x6D2B79F5;let r=Math.imul(t^(t>>>15),1|t);r^=r+Math.imul(r^(r>>>7),61|r);return((r^(r>>>14))>>>0)/4294967296}}
function hashSeed(s){let h=2166136261>>>0;for(const ch of s){h^=ch.charCodeAt(0);h=Math.imul(h,16777619)}return h>>>0}
let rng=Math.random;

/* ========== çŠ¶æ€ ========== */
let entries=[], candidates=[], winnersAll=[];
let autoRun=false, spinning=false;

const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function clean(v){ if(v==null) return ""; return String(v).replace(/\s+/g," ").trim() }
function isCJK(s){ return /[\u3400-\u9FFF]/.test(s) }
function looksId(s){ return /^\d+$/.test(s) }
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ========== æ™ºèƒ½ç¼–ç è¯†åˆ«ï¼ˆBOMä¼˜å…ˆ + å€™é€‰è¯„åˆ†ï¼‰ ========== */
function decodeSmart(u8){
Â  const encInfoEl = document.getElementById('encInfo');
Â  const hasBOM = (u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â (u8.length>=2 && ((u8[0]===0xFF && u8[1]===0xFE) || (u8[0]===0xFE && u8[1]===0xFF)));
Â  try{
Â  Â  if(u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF){
Â  Â  Â  const txt = new TextDecoder('utf-8').decode(u8.subarray(3));
Â  Â  Â  encInfoEl.textContent = 'ç¼–ç ï¼šUTF-8 (BOM)';
Â  Â  Â  return txt;
Â  Â  }
Â  Â  if(u8.length>=2 && u8[0]===0xFF && u8[1]===0xFE){
Â  Â  Â  const txt = new TextDecoder('utf-16le').decode(u8.subarray(2));
Â  Â  Â  encInfoEl.textContent = 'ç¼–ç ï¼šUTF-16LE (BOM)';
Â  Â  Â  return txt;
Â  Â  }
Â  Â  if(u8.length>=2 && u8[0]===0xFE && u8[1]===0xFF){
Â  Â  Â  const txt = new TextDecoder('utf-16be').decode(u8.subarray(2));
Â  Â  Â  encInfoEl.textContent = 'ç¼–ç ï¼šUTF-16BE (BOM)';
Â  Â  Â  return txt;
Â  Â  }
Â  }catch(e){}

Â  const labels = ['utf-8','gb18030','gbk','big5','shift_jis','euc-kr','windows-1252','iso-8859-1','koi8-r','macintosh','utf-16le','utf-16be'];
Â  let best = {score:-Infinity, text:null, label:null};
Â  for(const lb of labels){
Â  Â  try{
Â  Â  Â  const dec = new TextDecoder(lb, {fatal:false, ignoreBOM:true});
Â  Â  Â  const txt = dec.decode(u8);
Â  Â  Â  const bad = (txt.match(/\uFFFD/g)||[]).length;
Â  Â  Â  const ctl = (txt.match(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g)||[]).length;
Â  Â  Â  const cjk = (txt.match(/[\u3400-\u9FFF\uF900-\uFAFF]/g)||[]).length;
Â  Â  Â  let score = 1000 - bad*100 - ctl*2 + cjk;
Â  Â  Â  if(lb==='utf-8') score += 10;
Â  Â  Â  if(/^windows|iso-8859|macintosh/i.test(lb)) score -= 5;
Â  Â  Â  if(score > best.score) best = {score, text:txt, label:lb};
Â  Â  }catch(e){}
Â  }
Â  if(best.text!=null){
Â  Â  encInfoEl.textContent = `ç¼–ç ï¼ˆæ¨æµ‹ï¼‰ï¼š${best.label}${hasBOM?' + BOM':''}`;
Â  Â  return best.text;
Â  }
Â  try{
Â  Â  const txt = new TextDecoder().decode(u8);
Â  Â  encInfoEl.textContent = 'ç¼–ç ï¼šæœªçŸ¥ï¼ˆä½¿ç”¨é»˜è®¤è§£ç ï¼‰';
Â  Â  return txt;
Â  }catch(e){
Â  Â  encInfoEl.textContent = 'ç¼–ç ï¼šè§£ç å¤±è´¥';
Â  Â  throw e;
Â  }
}

/* ========== æ–‡ä»¶è¯»å– ========== */
const dz=$('#dz');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag')});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0])});
$('#file').addEventListener('change',e=>{if(e.target.files[0]) handleFile(e.target.files[0])});
$('#btnClear').addEventListener('click',()=>{entries=[];candidates=[];winnersAll=[];updateStats();$('#mapping').style.display='none';$('#range').style.display='none';$('#screen').textContent='ç­‰å¾…æŠ½å–â€¦';$('#history').innerHTML=''; $('#encInfo').textContent=''; buildStrip([]); });

function handleFile(file){
Â  const n=file.name.toLowerCase();
Â  if(n.endsWith('.xlsx')||n.endsWith('.xls')){
Â  Â  const fr=new FileReader(); fr.onload=()=>parseExcel(fr.result); fr.readAsArrayBuffer(file);
Â  }else{
Â  Â  const fr=new FileReader();
Â  Â  fr.onload=()=>{
Â  Â  Â  const u8 = new Uint8Array(fr.result);
Â  Â  Â  let text = '';
Â  Â  Â  try{ text = decodeSmart(u8); }catch(err){ alert('æ— æ³•è¯†åˆ«æ–‡æœ¬ç¼–ç ï¼š'+(err&&err.message||err)); return; }
Â  Â  Â  parseText(text);
Â  Â  };
Â  Â  fr.readAsArrayBuffer(file);
Â  }
}

function parseExcel(buf){
Â  const wb=XLSX.read(new Uint8Array(buf),{type:'array'}), sh=wb.Sheets[wb.SheetNames[0]];
Â  const aoa=XLSX.utils.sheet_to_json(sh,{header:1,raw:false,defval:""}); processAOA(aoa);
}

/* ä¼ å…¥å·²æ™ºèƒ½è§£ç çš„çº¯æ–‡æœ¬ */
function parseText(text){
Â  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
Â  const aoa=lines.map(line=>{
Â  Â  let cells=line.split(/,|ï¼Œ/);
Â  Â  if(cells.length===1) cells=line.split(/\t+/);
Â  Â  if(cells.length===1) cells=line.split(/\s+/);
Â  Â  return cells.map(clean);
Â  });
Â  processAOA(aoa);
}

/* ========== AOA -> entriesï¼ˆå…¼å®¹è¡¨å¤´ & ä¸¤åˆ—æˆç»„ï¼‰ ========== */
function processAOA(aoa){
Â  const rows=aoa.filter(r=> (r||[]).some(c=>clean(c)!=="")); if(!rows.length){ alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®'); return; }
Â  const keyName=/å§“å|name|å­¦ç”Ÿå§“å|åŒå­¦/i, keyId=/å­¦å·|å­¦ç±å·|ç¼–å·|åºå·|id|number|no/i;
Â  let header=-1, nameIdx=-1, idIdx=-1;
Â  for(let i=0;i<Math.min(10,rows.length);i++){
Â  Â  const r=rows[i].map(clean);
Â  Â  for(let c=0;c<r.length;c++){ if(nameIdx===-1&&keyName.test(r[c])) nameIdx=c, header=i; if(idIdx===-1&&keyId.test(r[c])) idIdx=c, header=i; }
Â  Â  if(header===i && (nameIdx!==-1 || idIdx!==-1)) break;
Â  }
Â  let parsed=[];
Â  if(header!==-1){
Â  Â  for(let i=header+1;i<rows.length;i++){ const r=rows[i].map(clean); const name=nameIdx!==-1?clean(r[nameIdx]):""; const id=idIdx!==-1?clean(r[idIdx]):""; if(name||id) parsed.push({name,id}); }
Â  Â  showMapping(rows[header]);
Â  }else{
Â  Â  for(const r0 of rows){
Â  Â  Â  const r=r0.map(clean);
Â  Â  Â  for(let c=0;c<r.length;c+=2){
Â  Â  Â  Â  const a=r[c]??"", b=r[c+1]??""; if(!a&&!b) continue;
Â  Â  Â  Â  if(/^\d+$/.test(a)&&isCJK(b)) parsed.push({id:String(a),name:b});
Â  Â  Â  Â  else if(isCJK(a)&&/^\d+$/.test(b)) parsed.push({id:String(b),name:a});
Â  Â  Â  Â  else if(isCJK(a)&&!b) parsed.push({id:"",name:a});
Â  Â  Â  Â  else if(isCJK(b)&&!a) parsed.push({id:"",name:b});
Â  Â  Â  }
Â  Â  }
Â  Â  $('#mapping').style.display='none'; $('#range').style.display='';
Â  }
Â  const seen=new Set();
Â  entries=parsed.filter(x=>{const key=(x.name||"")+"|"+(x.id||""); if(!x.name&&!x.id) return false; if(seen.has(key)) return false; seen.add(key); return true;})
Â  Â  Â  Â  Â  Â  Â  Â .map(x=>({name:x.name,id:x.id,label:x.name&&x.id?`${x.name}ï¼ˆ${x.id}ï¼‰`:(x.name||x.id)}));
Â  buildNameList(); fillIdMM(); updateCandidates(); updateStats(); $('#screen').textContent='æ•°æ®å·²è½½å…¥ï¼Œè®¾ç½®èŒƒå›´åå¯å¼€å§‹æŠ½å–';
}
function showMapping(headerRow){
Â  const cols=headerRow.map((v,i)=>({i,label:clean(v)||(`åˆ—${i+1}`)}));
Â  const selN=$('#selName'), selI=$('#selId');
Â  selN.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
Â  selI.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
Â  $('#mapping').style.display=''; $('#range').style.display='';
Â  $('#applyMap').onclick=()=>{ alert('å·²åº”ç”¨æ˜ å°„ã€‚ä¸ºç®€æ´èµ·è§ï¼Œè¯·æŒ‰æ–°æ˜ å°„é‡æ–°å¯¼å…¥ä¸€æ¬¡æ–‡ä»¶ã€‚'); };
Â  $('#sample').textContent='å·²æ£€æµ‹åˆ°è¡¨å¤´ï¼š'+headerRow.map(clean).join(' | ');
}

/* ========== èŒƒå›´ & å€™é€‰ ========== */
function buildNameList(){
Â  const box=$('#nameList');
Â  const names=[...new Set(entries.map(e=>e.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'zh'));
Â  box.innerHTML=names.map(n=>{
Â  Â  const safe = escapeHtml(n);
Â  Â  return `<label><input type="checkbox" class="cbN" value="${safe}" checked><span class="nm">${safe}</span></label>`;
Â  }).join('');
Â  $('#nameSearch').oninput=()=>{
Â  Â  const kw=$('#nameSearch').value.trim();
Â  Â  $$('.cbN').forEach(cb=>{
Â  Â  Â  const lab=cb.closest('label');
Â  Â  Â  const show=!kw || cb.value.includes(kw);
Â  Â  Â  lab.style.display=show?'flex':'none';
Â  Â  });
Â  };
Â  $('#all').onclick=()=>{$$('.cbN').forEach(cb=>cb.checked=true); updateCandidates();};
Â  $('#none').onclick=()=>{$$('.cbN').forEach(cb=>cb.checked=false); updateCandidates();};
}
function fillIdMM(){ const ids=entries.map(e=>e.id).filter(v=>/^\d+$/.test(v)).map(Number); if(ids.length){ $('#idMin').value=Math.min(...ids); $('#idMax').value=Math.max(...ids); } }
$('#fillMM').onclick=fillIdMM;
$$('input[name="mode"]').forEach(r=> r.addEventListener('change',()=>{
Â  const m=document.querySelector('input[name="mode"]:checked').value;
Â  $('#idRange').style.display=m==='id'?'':'none';
Â  $('#nameRange').style.display=m==='name'?'':'none';
Â  updateCandidates();
}));
['idMin','idMax','exclude'].forEach(id=> document.getElementById(id).addEventListener('input', updateCandidates));
document.addEventListener('change', e=>{ if(e.target.classList && e.target.classList.contains('cbN')) updateCandidates(); });

function updateCandidates(){
Â  const mode=document.querySelector('input[name="mode"]:checked').value;
Â  const excl=new Set( ($('#exclude').value.trim().split(/[\s,ï¼Œ;ï¼›]+/).filter(Boolean)) );
Â  let pool=[];
Â  if(mode==='id'){
Â  Â  const min=+($('#idMin').value||Number.NEGATIVE_INFINITY), max=+($('#idMax').value||Number.POSITIVE_INFINITY);
Â  Â  pool=entries.filter(e=> /^\d+$/.test(e.id) && +e.id>=min && +e.id<=max );
Â  }else{
Â  Â  const allowed=new Set([...document.querySelectorAll('.cbN:checked')].map(cb=>cb.value));
Â  Â  pool=entries.filter(e=> e.name && allowed.has(e.name));
Â  }
Â  pool=pool.filter(e=> !(excl.has(e.name)||excl.has(e.id)) );
Â  candidates=pool; updateStats(); buildStrip(candidates);
}
function updateStats(){ $('#statTotal').textContent=entries.length; $('#statCand').textContent=candidates.length; }

/* ========== è€è™æœºï¼šç¡®ä¿â€œæ»šåŠ¨çœ‹åˆ°çš„=æŠ½ä¸­ç»“æœâ€ ========== */
const VISIBLE_ROWS=3, CENTER_INDEX=1, COPIES=3, MAX_N_DOM=400;
const stripEl=document.getElementById('strip'), overlayEl=document.getElementById('overlay');

function buildStrip(list){
Â  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
Â  const baseCount=Math.max(list.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
Â  stripEl.dataset.ndom=String(Ndom);
Â  for(let k=0;k<COPIES;k++){
Â  Â  for(let i=0;i<Ndom;i++){
Â  Â  Â  const d=document.createElement('div'); d.className='cell';
Â  Â  Â  const data=list.length?list[i%list.length]:{label:String(i+1)};
Â  Â  Â  d.textContent=data.label; stripEl.appendChild(d);
Â  Â  }
Â  }
Â  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
Â  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}
function buildStripForSpin(snapshot, winnerIdx){
Â  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
Â  const baseCount=Math.max(snapshot.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
Â  stripEl.dataset.ndom=String(Ndom);
Â  const start=(winnerIdx - (CENTER_INDEX + 1) + snapshot.length) % snapshot.length;
Â  for(let k=0;k<COPIES;k++){
Â  Â  for(let i=0;i<Ndom;i++){
Â  Â  Â  const data = snapshot[(start + i) % snapshot.length];
Â  Â  Â  const d=document.createElement('div'); d.className='cell'; d.textContent=data.label; stripEl.appendChild(d);
Â  Â  }
Â  }
Â  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
Â  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
function spinToCenter(){
Â  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
Â  const Ndom=parseInt(stripEl.dataset.ndom,10)||VISIBLE_ROWS;
Â  const base=-CENTER_INDEX*cellH;
Â  const spins=14, duration=1400, travel=spins*Ndom*cellH;
Â  return new Promise(resolve=>{
Â  Â  const t0=performance.now();
Â  Â  function frame(now){
Â  Â  Â  const t=Math.max(0,Math.min(1,(now-t0)/duration));
Â  Â  Â  const yRaw=-travel*easeOutCubic(t);
Â  Â  Â  const yLoop=-(Math.abs(yRaw)%(Ndom*cellH));
Â  Â  Â  stripEl.style.transform=`translateY(${base + yLoop}px)`;
Â  Â  Â  if(t<1) requestAnimationFrame(frame); else { stripEl.style.transform=`translateY(${base}px)`; resolve(); }
Â  Â  }
Â  Â  requestAnimationFrame(frame);
Â  });
}
function pickFromSnapshot(snapshot, excludeSet){
Â  const idxPool=[]; for(let i=0;i<snapshot.length;i++){ const key=snapshot[i].name+'|'+snapshot[i].id; if(!excludeSet || !excludeSet.has(key)) idxPool.push(i); }
Â  if(!idxPool.length) return null;
Â  const chosenIndexInPool = Math.floor(rng()*idxPool.length);
Â  const idxSnap = idxPool[chosenIndexInPool];
Â  const item = snapshot[idxSnap];
Â  const idxGlobal = candidates.findIndex(e=> e===item || (e.name===item.name && e.id===item.id));
Â  return { item, idxSnap, idxGlobal };
}
function renderHistory(){
Â  $('#history').innerHTML=winnersAll.slice().reverse().map(rec=>{
Â  Â  const line=rec.list.length?rec.list.map(x=>x.label).join('ã€'):'ï¼ˆæ— ï¼‰';
Â  Â  return `<div style="padding:6px 0;border-bottom:1px dashed #e5e7eb"><div><b>${rec.time}</b></div><div>${line}</div></div>`;
Â  }).join('');
}
function setBusy(b){ spinning=b; $('#start').disabled=b; $('#stop').disabled=!b; }
$('#start').onclick = async ()=>{
Â  if(spinning||autoRun) return;
Â  if(!candidates.length){ alert('å€™é€‰é›†ä¸ºç©ºï¼šè¯·æ£€æŸ¥èŒƒå›´/æ’é™¤è®¾ç½®'); return; }
Â  rng = ($('#seed').value.trim()) ? mulberry32(hashSeed($('#seed').value.trim())) : Math.random;

Â  const N=Math.max(1, Math.floor(+$('#count').value||1));
Â  const used=new Set(); autoRun=true; setBusy(true);

Â  for(let i=0;i<N && autoRun;i++){
Â  Â  const snapshot=candidates.slice();
Â  Â  const pick=pickFromSnapshot(snapshot, $('#noRepeat').checked ? used : null);
Â  Â  if(!pick){ break; }

Â  Â  buildStripForSpin(snapshot, pick.idxSnap);
Â  Â  await spinToCenter();
Â  Â  const under = stripEl.children[CENTER_INDEX+1]; if(under) under.classList.add('under-hidden');
Â  Â  requestAnimationFrame(()=>{ $('#overlay').textContent = pick.item.label; $('#overlay').classList.add('show'); });
Â  Â  $('#screen').textContent='ğŸ‰ '+pick.item.label;

Â  Â  const when=new Date().toLocaleString(); winnersAll.push({time:when,list:[pick.item]}); renderHistory();

Â  Â  if($('#noRepeat').checked){
Â  Â  Â  used.add(pick.item.name+'|'+pick.item.id);
Â  Â  }
Â  Â  await new Promise(r=>setTimeout(r, 300));
Â  }
Â  autoRun=false; setBusy(false);
};
$('#stop').onclick=()=>{autoRun=false;};
$('#export').onclick=()=>{
Â  if(!winnersAll.length){ alert('æš‚æ— ä¸­å¥–è®°å½•'); return; }
Â  const rows=[['æ—¶é—´','åºå·','å§“å','å­¦å·','æ˜¾ç¤ºæ ‡ç­¾']];
Â  winnersAll.forEach(rec=> rec.list.forEach((p,i)=> rows.push([rec.time,i+1,p.name,p.id,p.label])) );
Â  const csv=rows.map(r=> r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
Â  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
};

buildStrip([]);
</script>
</body>
</html>