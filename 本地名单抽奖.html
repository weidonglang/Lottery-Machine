<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>本地名单抽奖 · 批量历史单行｜放大保留｜范围&视觉增强｜持久化</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* -------------------- 全局主题 -------------------- */
    :root {
      --bg: linear-gradient(135deg, #f8fafc 0%, #e9e3ff 100%);
      --panel: rgba(255, 255, 255, .9);
      --panel-border: rgba(160, 140, 255, .35);
      --text: #1f2937;
      --muted: #6b7280;
      --accent-50: #f5f3ff;
      --accent-100: #ede9fe;
      --accent-300: #c4b5fd;
      --accent-500: #8b5cf6;
      --accent-600: #7c3aed;
      --accent-700: #6d28d9;
      --ok: #10b981;
      --bad: #ef4444;
      --radius: 16px;
      --gap: 16px;
      --shadow: 0 10px 30px rgba(109, 40, 217, .12);
      --cell-h: 56px;
      --reel-w: min(560px, 94vw);
      --reel-bg: #120e29;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      min-height: 100svh;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.7 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: clamp(16px, 3vw, 32px)
    }

    .grid {
      display: grid;
      gap: var(--gap);
      grid-template-columns: 1fr
    }

    @media(min-width:1000px) {
      .grid {
        grid-template-columns: 1.05fr .95fr
      }
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(22px, 3.8vw, 34px);
      color: #332768;
      font-weight: 800
    }

    h3 {
      margin: 20px 0 16px;
      padding-bottom: 8px;
      color: #4a3b7d;
      border-bottom: 1px solid var(--accent-100)
    }

    .card {
      padding: clamp(16px, 3vw, 24px);
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px)
    }

    .help {
      color: var(--muted);
      font-size: 14px
    }

    /* -------------------- 控件 -------------------- */
    .list {
      padding: 10px;
      max-height: 40svh;
      overflow: auto;
      background: #fff;
      border: 1px solid var(--accent-100);
      border-radius: 12px
    }

    input,
    select,
    textarea,
    button {
      font-size: 16px
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--accent-100);
      border-radius: 10px;
      background: #fdfcff
    }

    input[type="number"].w100 {
      width: 110px
    }

    textarea {
      min-height: 60px
    }

    input[type="checkbox"],
    input[type="radio"] {
      accent-color: var(--accent-600)
    }

    .btn {
      padding: 10px 16px;
      color: #fff;
      font-weight: 700;
      letter-spacing: .3px;
      border: 0;
      border-radius: 12px;
      background-image: linear-gradient(145deg, var(--accent-500), var(--accent-600));
      box-shadow: 0 4px 12px rgba(124, 58, 237, .22);
      cursor: pointer
    }

    .btn.ghost {
      color: #3b2a69;
      background: rgba(243, 240, 255, .92);
      border: 1px solid var(--accent-100);
      box-shadow: none
    }

    .btn.ok {
      background-image: linear-gradient(145deg, #34d399, #10b981)
    }

    .btn.bad {
      background-image: linear-gradient(145deg, #f87171, #ef4444)
    }

    @media(max-width:760px) {
      .btn {
        width: 100%
      }
    }

    /* -------------------- 老虎机区域：视觉增强 -------------------- */
    .reelsWrap {
      display: flex;
      justify-content: center
    }

    .reel {
      position: relative;
      width: var(--reel-w);
      height: calc(var(--cell-h)*3);
      overflow: hidden;
      background: var(--reel-bg);
      border-radius: 16px;
      box-shadow: inset 0 0 16px rgba(0, 0, 0, .55), 0 18px 50px rgba(31, 17, 71, .35)
    }

    /* 背景动效层：柔和光带与星屑 */
    .reel::before {
      content: "";
      position: absolute;
      inset: -30%;
      background: conic-gradient(from 0deg at 50% 50%, rgba(139, 92, 246, .12), rgba(236, 72, 153, .08), rgba(59, 130, 246, .12), rgba(139, 92, 246, .12));
      filter: blur(30px);
      animation: spin 11s linear infinite;
      opacity: .8;
      pointer-events: none
    }

    .reel::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, .6), transparent), radial-gradient(2px 2px at 70% 60%, rgba(255, 255, 255, .5), transparent), radial-gradient(2px 2px at 35% 80%, rgba(255, 255, 255, .4), transparent);
      opacity: .5;
      animation: twinkle 3.2s ease-in-out infinite;
      pointer-events: none
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    @keyframes twinkle {
      0%,
      100% {
        opacity: .35
      }
      50% {
        opacity: .7
      }
    }

    .strip {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      will-change: transform
    }

    .strip.spinning {
      filter: blur(0.8px) saturate(1.05) brightness(1.05)
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      height: var(--cell-h);
      padding: 0 16px;
      color: #efe9ff;
      font-weight: 900;
      white-space: nowrap;
      text-overflow: ellipsis
    }

    .cell.hiddenCenter {
      visibility: hidden
    }

    .marker {
      position: absolute;
      top: var(--cell-h);
      left: 0;
      right: 0;
      height: var(--cell-h);
      pointer-events: none
    }

    .marker::after {
      content: '';
      position: absolute;
      inset: 4px 8px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, .65);
      box-shadow: 0 0 20px rgba(139, 92, 246, .28)
    }

    /* 浮出的放大结果（1.5x + 轻弹） */
    .overlay {
      position: absolute;
      top: var(--cell-h);
      left: 0;
      right: 0;
      height: var(--cell-h);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      opacity: 0;
      transform: scale(1);
      transition: opacity .18s ease, transform .18s ease;
      z-index: 5;
      text-shadow: 0 2px 10px rgba(0, 0, 0, .6);
      pointer-events: none
    }

    .overlay.show {
      opacity: 1;
      transform: scale(1.5);
      animation: pop .22s ease-out
    }

    @keyframes pop {
      0% {
        transform: scale(0.9)
      }
      70% {
        transform: scale(1.54)
      }
      100% {
        transform: scale(1.5)
      }
    }

    .result {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 56px;
      margin-top: 10px;
      padding: 12px 16px;
      color: #fff;
      font-size: clamp(20px, 3.4vw, 28px);
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-700), var(--accent-500));
      border-radius: 12px
    }

    /* -------------------- 抽取范围（③）视觉增强 -------------------- */
    #range {
      font-size: 17px
    }

    #range .tag {
      font-size: 15px;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #e0e7ff;
      border-radius: 999px;
      padding: 6px 10px
    }

    #range input[type="radio"] {
      transform: scale(1.15)
    }

    #idRange .row input {
      font-size: 17px
    }

    #nameList {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 12px;
      padding: 10px;
      max-height: clamp(380px, 64svh, 820px);
      border-radius: 12px
    }

    @media(max-width:900px) {
      #nameList {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }

    @media(max-width:560px) {
      #nameList {
        grid-template-columns: repeat(1, minmax(0, 1fr))
      }
    }

    #nameList label {
      font-size: 16.5px;
      padding: 10px 12px;
      background: #fafaff;
      border: 1px solid #ecebff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(99, 102, 241, .08)
    }

    #nameList .nm {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis
    }

    #nameRange .row input[type="text"] {
      font-size: 16.5px
    }

    /* -------------------- 历史记录（批量单行显示） -------------------- */
    #history {
      background: #fff;
      border: 1px solid var(--accent-100);
      border-radius: 12px;
      padding: 10px;
      max-height: 40svh;
      overflow: auto
    }

    .history-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      border: 1px solid #eef2ff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(17, 24, 39, .04)
    }

    .history-head {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .history-time {
      font-size: 15px;
      color: #475569;
      font-weight: 800
    }

    .history-count {
      font-size: 12px;
      color: #4338ca;
      background: #eef2ff;
      border: 1px solid #e0e7ff;
      padding: 4px 8px;
      border-radius: 999px
    }

    .history-row {
      display: flex;
      align-items: center;
      gap: 10px;
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 2px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 7px 12px;
      border-radius: 999px;
      background: #ede9fe;
      color: #3b2a69;
      font-weight: 800;
      font-size: 15px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .06)
    }

    .history-list {
      display: grid;
      gap: 10px
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>本地名单抽奖（批量历史单行｜放大保留｜范围&视觉增强）</h1>
    <p class="help">支持 TXT/CSV/XLS/XLSX；自动识别编码；按学号/姓名范围（智能默认）；同轮不重复；随机种子；历史导出；名单持久化；中奖后自动取消勾选。</p>

    <div class="grid">
      <section class="card">
        <h3>① 导入名单</h3>
        <div class="row">
          <label class="btn ghost" for="file">选择文件</label>
          <input id="file" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none">
          <button id="btnClear" class="btn ghost">清空</button>
        </div>
        <div id="dz" class="drop list" style="margin-top:10px;border-style:dashed;text-align:center">
          将 TXT/CSV/XLS/XLSX 拖入此处，或点击“选择文件”
          <div id="encInfo" class="help" style="margin-top:6px"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="listName" type="text" placeholder="默认名单" />
          <button id="btnSaveList" class="btn">保存名单</button>
          <button id="btnManageList" class="btn ghost">管理本地名单</button>
          <button id="btnExportSaved" class="btn ghost" title="导出 JSON 备份">导出备份</button>
          <label class="btn ghost" title="导入 JSON 备份">导入备份<input id="importSavedFile" type="file" accept=".json,application/json" style="display:none"></label>
        </div>
        <div id="savedPanel" class="list help" style="display:none;margin-top:8px">
          <div class="help">已保存的名单（本地存储）：</div>
          <div id="savedListBox"></div>
          <div id="storageWarn" class="help" style="color:#dc2626;display:none;margin-top:6px">⚠️ 当前环境的浏览器本地存储不可用，无法保存名单。</div>
        </div>

        <div id="mapping" style="margin-top:12px;display:none">
          <h3>② 列映射（检测到表头可调整）</h3>
          <div class="row">姓名列：<select id="selName"></select> 学号列：<select id="selId"></select> <button id="applyMap" class="btn ghost">应用映射（请重新导入）</button></div>
          <div id="sample" class="help" style="margin-top:6px"></div>
        </div>

        <div id="range" style="margin-top:12px;display:none">
          <h3>③ 抽取范围</h3>
          <div class="row" role="radiogroup">
            <label class="tag"><input type="radio" name="mode" value="id" checked> 按学号</label>
            <label class="tag"><input type="radio" name="mode" value="name"> 按姓名</label>
            <span id="autoModeHint" class="help"></span>
          </div>

          <div id="idRange" style="margin-top:6px">
            <div class="row">学号区间：<input id="idMin" class="w100" type="number" placeholder="起始"><span style="align-self:center">—</span><input id="idMax" class="w100" type="number" placeholder="结束"> <button id="fillMM" class="btn ghost">用最小/最大填充</button></div>
            <div class="help">仅在导入数据中的学号范围内抽取。</div>
          </div>

          <div id="nameRange" style="display:none;margin-top:6px">
            <div class="row"><input id="nameSearch" type="text" placeholder="搜索姓名（模糊）" style="flex:1"> <button id="all" class="btn ghost">全选</button> <button id="none" class="btn ghost">全不选</button></div>
            <div id="nameList" class="list" style="margin-top:6px"></div>
          </div>

          <div style="margin-top:8px">
            <div class="help">排除名单（姓名或学号，逗号/空格分隔）：</div>
            <textarea id="exclude" placeholder="例：张三 10021,10023 李四"></textarea>
          </div>
        </div>
      </section>

      <section class="card">
        <h3>④ 抽取设置与结果</h3>
        <div class="row">
          连抽次数：<input id="count" class="w100" type="number" min="1" value="1">
          <label class="tag"><input id="noRepeat" type="checkbox" checked> 同轮不重复</label>
          <label class="tag"><input id="autoUncheck" type="checkbox"> 中奖后取消勾选</label>
        </div>
        <div class="row" style="margin-top:6px">
          滚动时长(ms)：<input id="spinMs" class="w100" type="number" min="500" value="1400">
          展示时长(ms)：<input id="holdMs" class="w100" type="number" min="200" value="900">
          连抽间隔(ms)：<input id="gapMs" class="w100" type="number" min="0" value="350">
        </div>
        <div class="row" style="margin-top:6px">随机种子（可选）：<input id="seed" type="text" placeholder="留空使用系统随机，例如：2025-晚会-B01" style="flex:1"></div>

        <div class="row" style="margin-top:8px"><button id="start" class="btn ok">开始抽取</button> <button id="stop" class="btn bad" disabled>停止</button> <button id="export" class="btn">导出中奖记录</button></div>

        <div class="reelsWrap" style="margin-top:10px">
          <div class="reel">
            <div id="strip" class="strip"></div>
            <div class="marker" aria-hidden="true"></div>
            <div id="overlay" class="overlay" aria-hidden="true"></div>
          </div>
        </div>

        <div id="screen" class="result" aria-live="polite">等待抽取…（请先导入数据并设置范围）</div>
        <div class="row" style="margin-top:8px"><span class="help">已导入：<b id="statTotal">0</b> | 当前候选：<b id="statCand">0</b> <span id="progress" class="help"></span></span></div>

        <h3 style="margin-top:12px">历史记录</h3>
        <div id="history" class="history-list"></div>
      </section>
    </div>
  </div>

  <script>
    /* =====================================================
     * 本地名单抽奖（批量历史单行｜放大保留｜范围&视觉增强｜持久化）
     * 重点：
     * - 历史按“批次”记录，连抽 N 次合并到同一行显示（水平芯片，支持横向滚动）。
     * - 保持 UI 锁定期 + 延迟重建候选集 + 1.5x 放大浮现。
     * ===================================================== */

    /* -------------------- 基础工具 -------------------- */
    const $ = s => document.querySelector(s),
      $$ = s => document.querySelectorAll(s);
    const clean = v => v == null ? "" : String(v).replace(/\s+/g, " ").trim();
    const isCJK = s => /[\u3400-\u9FFF]/.test(s);
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      '\'': '&#39;'
    } [m]));

    function storageAvailable() {
      try {
        const x = '__ls_probe__';
        localStorage.setItem(x, '1');
        localStorage.removeItem(x);
        return true;
      } catch (e) {
        return false;
      }
    }

    function mulberry32(seed) {
      let t = seed >>> 0;
      return () => {
        t += 0x6D2B79F5;
        let r = Math.imul(t ^ (t >>> 15), 1 | t);
        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
      };
    }

    function hashSeed(s) {
      let h = 2166136261 >>> 0;
      for (const ch of s) {
        h ^= ch.charCodeAt(0);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    /* -------------------- 智能编码识别（TXT/CSV） -------------------- */
    function decodeSmart(u8) {
      const encInfoEl = document.getElementById('encInfo');
      const hasBOM = (u8.length >= 3 && u8[0] === 0xEF && u8[1] === 0xBB && u8[2] === 0xBF) || (u8.length >= 2 && ((u8[0] === 0xFF && u8[1] === 0xFE) || (u8[0] === 0xFE && u8[1] === 0xFF)));
      try {
        if (u8.length >= 3 && u8[0] === 0xEF && u8[1] === 0xBB && u8[2] === 0xBF) {
          const txt = new TextDecoder('utf-8').decode(u8.subarray(3));
          encInfoEl.textContent = '编码：UTF-8 (BOM)';
          return txt;
        }
      } catch (e) {}
      try {
        if (u8.length >= 2 && u8[0] === 0xFF && u8[1] === 0xFE) {
          const txt = new TextDecoder('utf-16le').decode(u8.subarray(2));
          encInfoEl.textContent = '编码：UTF-16LE (BOM)';
          return txt;
        }
      } catch (e) {}
      try {
        if (u8.length >= 2 && u8[0] === 0xFE && u8[1] === 0xFF) {
          const txt = new TextDecoder('utf-16be').decode(u8.subarray(2));
          encInfoEl.textContent = '编码：UTF-16BE (BOM)';
          return txt;
        }
      } catch (e) {}
      const labels = ['utf-8', 'gb18030', 'gbk', 'big5', 'shift_jis', 'euc-kr', 'windows-1252', 'iso-8859-1'];
      let best = {
        score: -1,
        text: null,
        label: null
      };
      for (const lb of labels) {
        try {
          const dec = new TextDecoder(lb, {
            fatal: false,
            ignoreBOM: true
          });
          const txt = dec.decode(u8);
          const bad = (txt.match(/\uFFFD/g) || []).length;
          const ctl = (txt.match(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g) || []).length;
          const cjk = (txt.match(/[\u3400-\u9FFF\uF900-\uFAFF]/g) || []).length;
          let score = 1000 - bad * 100 - ctl * 2 + cjk;
          if (lb === 'utf-8') score += 10;
          if (score > best.score) best = {
            score,
            text: txt,
            label: lb
          };
        } catch (e) {}
      }
      if (best.text != null) {
        encInfoEl.textContent = `编码（推测）：${best.label}${hasBOM?' + BOM':''}`;
        return best.text;
      }
      try {
        const txt = new TextDecoder().decode(u8);
        encInfoEl.textContent = '编码：默认解码';
        return txt;
      } catch (e) {
        encInfoEl.textContent = '编码：解码失败';
        throw e;
      }
    }

    /* -------------------- 文件导入 -------------------- */
    const dz = $('#dz');
    ['dragover', 'dragenter'].forEach(t => dz.addEventListener(t, e => {
      e.preventDefault();
      dz.classList.add('drag')
    }));;
    ['dragleave', 'drop'].forEach(t => dz.addEventListener(t, e => {
      if (t === 'drop') e.preventDefault();
      dz.classList.remove('drag');
    }));
    dz.addEventListener('drop', e => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleFile(f);
    });
    $('#file').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (f) handleFile(f);
    });
    $('#btnClear').addEventListener('click', () => {
      entries = [];
      candidates = [];
      winnersAll = [];
      updateStats();
      $('#mapping').style.display = 'none';
      $('#range').style.display = 'none';
      $('#history').innerHTML = '';
      $('#encInfo').textContent = '';
      $('#screen').textContent = '等待抽取…（请先导入数据并设置范围）';
      buildStrip([]);
    });

    function handleFile(file) {
      const name = file.name.toLowerCase();
      if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
        const fr = new FileReader();
        fr.onload = () => parseExcel(fr.result);
        fr.readAsArrayBuffer(file);
      } else {
        const fr = new FileReader();
        fr.onload = () => {
          const u8 = new Uint8Array(fr.result);
          let text = '';
          try {
            text = decodeSmart(u8);
          } catch (err) {
            alert('无法识别文本编码：' + (err && err.message || err));
            return;
          }
          parseText(text);
        };
        fr.readAsArrayBuffer(file);
      }
    }

    function parseExcel(buf) {
      const wb = XLSX.read(new Uint8Array(buf), {
        type: 'array'
      }),
        sh = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(sh, {
        header: 1,
        raw: false,
        defval: ""
      });
      processAOA(aoa);
    }

    function parseText(text) {
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const aoa = lines.map(line => {
        let cells = line.split(/,|，/);
        if (cells.length === 1) cells = line.split(/\t+/);
        if (cells.length === 1) cells = line.split(/\s+/);
        return cells.map(clean);
      });
      processAOA(aoa);
    }

    /* -------------------- 数据与解析 -------------------- */
    let entries = [],
      candidates = [],
      winnersAll = []; // winnersAll: [{time, list:[item,...]}]
    let autoRun = false,
      spinning = false;
    let autoUncheckEnabled = false; // “中奖后取消勾选”
    let userModeTouched = false; // 用户是否手动改过“按学号/按姓名”

    // ★ UI 锁定与延迟重建
    let uiLocked = false; // 抽取进行中：禁止候选集重建
    let pendingRecalc = false; // 锁定期内如有改动，记录并在期末统一重建

    function processAOA(aoa) {
      const rows = (aoa || []).filter(r => (r || []).some(c => clean(c) !== ""));
      if (!rows.length) {
        alert('未解析到有效数据。');
        return;
      }
      // 表头映射探测
      const keyName = /姓名|name|学生姓名|同学/i,
        keyId = /学号|学籍号|编号|序号|id|number|no/i;
      let header = -1,
        nameIdx = -1,
        idIdx = -1;
      for (let i = 0; i < Math.min(10, rows.length); i++) {
        const r = rows[i].map(clean);
        for (let c = 0; c < r.length; c++) {
          if (nameIdx === -1 && keyName.test(r[c])) nameIdx = c, header = i;
          if (idIdx === -1 && keyId.test(r[c])) idIdx = c, header = i;
        }
        if (header === i && (nameIdx !== -1 || idIdx !== -1)) break;
      }
      // 解析
      let parsed = [];
      if (header !== -1) {
        for (let i = header + 1; i < rows.length; i++) {
          const r = rows[i].map(clean);
          const name = nameIdx !== -1 ? clean(r[nameIdx]) : "";
          const id = idIdx !== -1 ? clean(r[idIdx]) : "";
          if (name || id) parsed.push({
            name,
            id
          });
        }
        showMapping(rows[header]);
      } else {
        // 无表头：尝试(序号,姓名)/(姓名,序号)/单列姓名
        for (const r0 of rows) {
          const r = r0.map(clean);
          for (let c = 0; c < r.length; c += 2) {
            const a = r[c] ?? "",
              b = r[c + 1] ?? "";
            if (!a && !b) continue;
            if (/^\d+$/.test(a) && isCJK(b)) parsed.push({
              id: String(a),
              name: b
            });
            else if (isCJK(a) && /^\d+$/.test(b)) parsed.push({
              id: String(b),
              name: a
            });
            else if (isCJK(a) && !b) parsed.push({
              id: "",
              name: a
            });
            else if (isCJK(b) && !a) parsed.push({
              id: "",
              name: b
            });
          }
        }
        $('#mapping').style.display = 'none';
        $('#range').style.display = '';
      }
      // 去重 & 组装显示标签
      const seen = new Set();
      entries = parsed.filter(x => {
        const key = (x.name || "") + '|' + (x.id || "");
        if (!x.name && !x.id) return false;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      }).map(x => ({
        name: x.name,
        id: x.id,
        label: x.name && x.id ? `${x.name}（${x.id}）` : (x.name || x.id)
      }));
      buildNameList();
      fillIdMM();
      autoPickRangeMode();
      updateCandidates();
      updateStats();
      $('#screen').textContent = '数据已载入，请设置范围后点击“开始抽取”。';
    }

    function showMapping(headerRow) {
      const cols = headerRow.map((v, i) => ({
        i,
        label: clean(v) || (`列${i+1}`)
      }));
      const selN = $('#selName'),
        selI = $('#selId');
      selN.innerHTML = cols.map(c => `<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
      selI.innerHTML = cols.map(c => `<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
      $('#mapping').style.display = '';
      $('#range').style.display = '';
      $('#applyMap').onclick = () => alert('已应用映射。为简洁起见，请按新映射重新导入一次文件以完全生效。');
      $('#sample').textContent = '已检测到表头：' + headerRow.map(clean).join(' | ');
    }

    /* -------------------- 范围 / 候选 -------------------- */
    function buildNameList() {
      const box = $('#nameList');
      const names = [...new Set(entries.map(e => e.name).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'zh'));
      box.innerHTML = names.map(n => `<label><input type="checkbox" class="cbN" value="${escapeHtml(n)}" checked><span class="nm">${escapeHtml(n)}</span></label>`).join('');
      $('#nameSearch').oninput = () => {
        const kw = $('#nameSearch').value.trim();
        $$('.cbN').forEach(cb => {
          const lab = cb.closest('label');
          lab.style.display = !kw || cb.value.includes(kw) ? 'flex' : 'none';
        });
      };
      $('#all').onclick = () => {
        $$('.cbN').forEach(cb => cb.checked = true);
        updateCandidates();
      };
      $('#none').onclick = () => {
        $$('.cbN').forEach(cb => cb.checked = false);
        updateCandidates();
      };
    }

    function fillIdMM() {
      const ids = entries.map(e => e.id).filter(v => /^\d+$/.test(v)).map(Number);
      if (ids.length) {
        $('#idMin').value = Math.min(...ids);
        $('#idMax').value = Math.max(...ids);
      }
    }
    $('#fillMM').onclick = fillIdMM;
    $$('input[name="mode"]').forEach(r => r.addEventListener('change', () => {
      userModeTouched = true;
      const m = document.querySelector('input[name="mode"]:checked').value;
      $('#idRange').style.display = m === 'id' ? '' : 'none';
      $('#nameRange').style.display = m === 'name' ? '' : 'none';
      updateCandidates();
    }));
    ['idMin', 'idMax', 'exclude'].forEach(id => document.getElementById(id).addEventListener('input', updateCandidates));
    document.addEventListener('change', e => {
      if (e.target && e.target.classList && e.target.classList.contains('cbN')) updateCandidates();
    });

    function setMode(m) {
      const rId = document.querySelector('input[name="mode"][value="id"]');
      const rName = document.querySelector('input[name="mode"][value="name"]');
      rId.checked = (m === 'id');
      rName.checked = (m === 'name');
      $('#idRange').style.display = m === 'id' ? '' : 'none';
      $('#nameRange').style.display = m === 'name' ? '' : 'none';
    }

    function autoPickRangeMode() {
      if (userModeTouched) return; // 用户有过选择就不覆盖
      const total = entries.length;
      const numericIds = entries.filter(e => /^\d+$/.test(e.id)).length;
      const uniqueIdCount = new Set(entries.map(e => e.id).filter(id => /^\d+$/.test(id))).size;
      const haveNames = entries.some(e => e.name && e.name.trim());
      const pickId = (numericIds >= Math.max(5, Math.floor(total * 0.6))) && (uniqueIdCount >= 2);
      if (pickId) {
        setMode('id');
        $('#autoModeHint').textContent = '（已自动选择：按学号）';
      } else if (haveNames) {
        setMode('name');
        $('#autoModeHint').textContent = '（已自动选择：按姓名）';
      } else {
        setMode('id');
        $('#autoModeHint').textContent = '（自动选择：按学号）';
      }
    }

    function updateCandidates() {
      // ★ 若在抽取锁定期，延后重建，避免打断动画/覆盖 overlay
      if (uiLocked) {
        pendingRecalc = true;
        return;
      }

      const mode = document.querySelector('input[name="mode"]:checked').value;
      const excl = new Set(($('#exclude').value.trim().split(/[\s,，;；]+/).filter(Boolean)));
      let pool = [];
      if (mode === 'id') {
        const min = +($('#idMin').value || Number.NEGATIVE_INFINITY);
        const max = +($('#idMax').value || Number.POSITIVE_INFINITY);
        pool = entries.filter(e => /^\d+$/.test(e.id) && +e.id >= min && +e.id <= max);
      } else {
        const allowed = new Set([...document.querySelectorAll('.cbN:checked')].map(cb => cb.value));
        pool = entries.filter(e => e.name && allowed.has(e.name));
      }
      pool = pool.filter(e => !(excl.has(e.name) || excl.has(e.id)));
      candidates = pool;
      updateStats();
      buildStrip(candidates);
    }

    function updateStats() {
      $('#statTotal').textContent = entries.length;
      $('#statCand').textContent = candidates.length;
    }

    /* -------------------- 老虎机动画（顺滑连抽：可调时长/间隔） -------------------- */
    const VISIBLE_ROWS = 3,
      CENTER_INDEX = 1,
      COPIES = 3,
      MAX_N_DOM = 400;
    const stripEl = document.getElementById('strip'),
      overlayEl = document.getElementById('overlay');
    const BASE_Y = 0; // 终止在 0

    function buildStrip(list) {
      // 不在这里隐藏 overlay，避免在抽取后展示期间被意外清除
      stripEl.innerHTML = '';
      const baseCount = Math.max(list.length, VISIBLE_ROWS),
        Ndom = Math.min(baseCount, MAX_N_DOM);
      stripEl.dataset.ndom = String(Ndom);
      for (let k = 0; k < COPIES; k++)
        for (let i = 0; i < Ndom; i++) {
          const d = document.createElement('div');
          d.className = 'cell';
          const data = list.length ? list[i % list.length] : {
            label: String(i + 1)
          };
          d.textContent = data.label;
          stripEl.appendChild(d);
        }
      stripEl.style.transform = `translateY(${BASE_Y}px)`;
    }

    function buildStripForSpin(snapshot, winnerIdx) {
      // 每轮开始前清理 overlay
      overlayEl.classList.remove('show');
      overlayEl.textContent = '';
      stripEl.innerHTML = '';
      const baseCount = Math.max(snapshot.length, VISIBLE_ROWS),
        Ndom = Math.min(baseCount, MAX_N_DOM);
      stripEl.dataset.ndom = String(Ndom);
      const start = (winnerIdx - CENTER_INDEX + snapshot.length) % snapshot.length; // winner 位于中间行
      for (let k = 0; k < COPIES; k++)
        for (let i = 0; i < Ndom; i++) {
          const d = document.createElement('div');
          d.className = 'cell';
          d.textContent = snapshot[(start + i) % snapshot.length].label;
          stripEl.appendChild(d);
        }
      stripEl.style.transform = `translateY(${BASE_Y}px)`;
    }
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

    function spinToCenter(durationMs) {
      const cellH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h')) || 56;
      const Ndom = parseInt(stripEl.dataset.ndom, 10) || VISIBLE_ROWS;
      const spins = 14; // 圈数
      const travel = spins * Ndom * cellH;
      stripEl.classList.add('spinning');
      return new Promise(resolve => {
        const t0 = performance.now();

        function frame(now) {
          const t = Math.max(0, Math.min(1, (now - t0) / durationMs));
          const yRaw = -travel * easeOutCubic(t);
          const yLoop = -(Math.abs(yRaw) % (Ndom * cellH));
          stripEl.style.transform = `translateY(${BASE_Y + yLoop}px)`;
          if (t < 1) requestAnimationFrame(frame);
          else {
            stripEl.style.transform = `translateY(${BASE_Y}px)`;
            stripEl.classList.remove('spinning');
            resolve();
          }
        }
        requestAnimationFrame(frame);
      });
    }

    function pickFromSnapshot(snapshot, excludeSet) {
      const idxPool = [];
      for (let i = 0; i < snapshot.length; i++) {
        const key = snapshot[i].name + '|' + snapshot[i].id;
        if (!excludeSet || !excludeSet.has(key)) idxPool.push(i);
      }
      if (!idxPool.length) return null;
      const chosenIndex = Math.floor(rng() * idxPool.length);
      const idxSnap = idxPool[chosenIndex];
      const item = snapshot[idxSnap];
      const idxGlobal = candidates.findIndex(e => e === item || (e.name === item.name && e.id === item.id));
      return {
        item,
        idxSnap,
        idxGlobal
      };
    }

    function renderHistory() {
      const html = winnersAll.slice().reverse().map(rec => {
        const chips = rec.list.map((x, i) => `<span class="chip" title="第${i+1}个">${escapeHtml(x.label)}</span>`).join('');
        return `<div class="history-group">
        <div class="history-head"><div class="history-time">🕒 ${rec.time}</div><div class="history-count">本批次 ${rec.list.length} 个</div></div>
        <div class="history-row">${chips}</div>
      </div>`;
      }).join('');
      $('#history').innerHTML = html || '<div class="help">暂无记录</div>';
    }

    function setBusy(b) {
      spinning = b;
      $('#start').disabled = b;
      $('#stop').disabled = !b;
    }

    /* -------------------- 抽取控制（顺滑连抽 + 锁定期 + 批量历史） -------------------- */
    let rng = Math.random;
    $('#start').onclick = async () => {
      if (spinning || autoRun) return;
      if (!candidates.length) {
        alert('候选集为空：请检查范围设置或排除名单。');
        return;
      }
      rng = ($('#seed').value.trim()) ? mulberry32(hashSeed($('#seed').value.trim())) : Math.random;

      const N = Math.max(1, Math.floor(+$('#count').value || 1));
      const used = new Set();
      autoRun = true;
      setBusy(true);
      const spinMs = Math.max(500, Math.floor(+$('#spinMs').value || 1400));
      const holdMs = Math.max(200, Math.floor(+$('#holdMs').value || 900));
      const gapMs = Math.max(0, Math.floor(+$('#gapMs').value || 350));

      // 本次批量历史记录容器（一个批次=一行）
      const currentBatch = {
        time: new Date().toLocaleString(),
        list: []
      };

      for (let i = 0; i < N && autoRun; i++) {
        $('#progress').textContent = `（进度：${i+1}/${N}）`;

        // 锁定期开始：阻止任何候选集重建
        uiLocked = true;

        const snapshot = candidates.slice();
        const pick = pickFromSnapshot(snapshot, $('#noRepeat').checked ? used : null);
        if (!pick) {
          uiLocked = false;
          break;
        }

        buildStripForSpin(snapshot, pick.idxSnap);
        await spinToCenter(spinMs);

        // 隐藏条带中居中那一行，避免与浮现文本重叠
        const centerCell = stripEl.children[CENTER_INDEX];
        if (centerCell) centerCell.classList.add('hiddenCenter');

        // 浮现放大版结果
        overlayEl.textContent = pick.item.label;
        overlayEl.classList.add('show');
        $('#screen').textContent = '🎉 恭喜：' + pick.item.label;

        // 写入本批次（不立刻渲染，避免一批出现多行）
        currentBatch.list.push(pick.item);
        if ($('#noRepeat').checked) {
          used.add(pick.item.name + '|' + pick.item.id);
        }

        // 启用“中奖后取消勾选”：先仅改复选框，不触发重建；记录待重建标志
        if (autoUncheckEnabled && pick.item.name) {
          $$('.cbN').forEach(cb => {
            if (cb.value === pick.item.name) cb.checked = false;
          });
          pendingRecalc = true;
        }

        // 展示停顿
        await new Promise(r => setTimeout(r, holdMs));
        overlayEl.classList.remove('show');
        await new Promise(r => setTimeout(r, 180));

        // 锁定期结束：如有待重建，则在此刻统一更新（为下一轮准备）
        uiLocked = false;
        if (pendingRecalc) {
          pendingRecalc = false;
          updateCandidates();
        }

        if (gapMs > 0) await new Promise(r => setTimeout(r, gapMs));
      }

      // 批次写入历史并渲染（单行显示）
      if (currentBatch.list.length > 0) {
        winnersAll.push(currentBatch);
        renderHistory();
      }

      $('#progress').textContent = '';
      autoRun = false;
      setBusy(false);
    };
    $('#stop').onclick = () => {
      autoRun = false;
    };

    /* -------------------- 导出历史（批次化） -------------------- */
    $('#export').onclick = () => {
      if (!winnersAll.length) {
        alert('暂无中奖记录可导出。');
        return;
      }
      const rows = [
        ['批次时间', '批次序号', '序号(批内)', '姓名', '学号', '显示标签']
      ];
      winnersAll.forEach((rec, bi) => rec.list.forEach((p, i) => rows.push([rec.time, bi + 1, i + 1, p.name, p.id, p.label])));
      const csv = rows.map(r => r.map(x => `"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const url = URL.createObjectURL(new Blob([csv], {
        type: 'text/csv;charset=utf-8;'
      }));
      const a = document.createElement('a');
      a.href = url;
      a.download = 'winners_batches.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    /* -------------------- 中奖后取消勾选（并排开关） -------------------- */
    const autoUncheckCb = $('#autoUncheck');
    autoUncheckCb.addEventListener('change', () => {
      autoUncheckEnabled = autoUncheckCb.checked;
      if (!autoUncheckEnabled) { // 关闭时：立即恢复“按姓名”列表为全选
        $$('.cbN').forEach(cb => cb.checked = true);
        updateCandidates();
      }
    });

    /* -------------------- 名单持久化（保存/管理/导出/导入） -------------------- */
    const LS_KEY = 'lotteryListsV1';
    const loadStore = () => {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY)) || {
          lists: {},
          lastUsed: ''
        };
      } catch (e) {
        return {
          lists: {},
          lastUsed: ''
        };
      }
    };
    const saveStore = st => localStorage.setItem(LS_KEY, JSON.stringify(st));

    function refreshSavedListUI() {
      const box = $('#savedListBox');
      const st = loadStore();
      const names = Object.keys(st.lists);
      if (!names.length) {
        box.innerHTML = '<div class="help">暂无保存的名单。</div>';
        return;
      }
      box.innerHTML = names.map(n => {
        const cnt = (st.lists[n].entries || []).length;
        const tag = (st.lastUsed === n) ? '<span class="help" style="color:#10b981"> [上次使用]</span>' : '';
        const safe = escapeHtml(n);
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee">
        <div><b>${safe}</b> <span class="help">（${cnt} 条）</span>${tag}</div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" data-act="load" data-name="${safe}">加载</button>
          <button class="btn bad" data-act="del" data-name="${safe}">删除</button>
        </div></div>`;
      }).join('');
      box.querySelectorAll('button').forEach(btn => {
        btn.onclick = (e) => {
          const act = e.currentTarget.dataset.act,
            nm = e.currentTarget.dataset.name;
          if (act === 'load') loadList(nm);
          if (act === 'del') {
            if (confirm('确认删除保存的名单：' + nm + '？此操作不可撤销。')) {
              const st2 = loadStore();
              delete st2.lists[nm];
              if (st2.lastUsed === nm) st2.lastUsed = '';
              saveStore(st2);
              refreshSavedListUI();
            }
          }
        };
      });
    }

    function applyEntries(newEntries, sourceLabel) {
      entries = Array.isArray(newEntries) ? newEntries.map(x => ({
        name: x.name || '',
        id: x.id || '',
        label: x.label || ((x.name && x.id) ? `${x.name}（${x.id}）` : (x.name || x.id))
      })) : [].slice();
      buildNameList();
      fillIdMM();
      userModeTouched = false;
      autoPickRangeMode();
      updateCandidates();
      updateStats();
      $('#screen').textContent = sourceLabel || '数据已载入（本地）';
      $('#range').style.display = '';
    }

    function loadList(name) {
      const st = loadStore();
      const rec = st.lists[name];
      if (!rec) {
        alert('未找到保存的名单：' + name);
        return;
      }
      applyEntries(rec.entries, '已从本地存储加载：' + name + '（可直接抽奖）');
      st.lastUsed = name;
      saveStore(st);
    }

    function saveCurrentList() {
      if (!entries.length) {
        alert('暂无数据可保存，请先导入。');
        return;
      }
      if (!storageAvailable()) {
        $('#storageWarn').style.display = '';
        alert('当前环境不支持本地存储。');
        return;
      }
      const name = ($('#listName').value.trim() || '默认名单');
      const st = loadStore();
      if (st.lists[name] && !confirm('同名名单已存在，是否覆盖？\n名称：' + name)) return;
      st.lists[name] = {
        entries
      };
      st.lastUsed = name;
      saveStore(st);
      refreshSavedListUI();
      alert('已保存为：' + name + '。下次打开会自动加载该名单。');
    }
    $('#btnSaveList').onclick = saveCurrentList;
    $('#btnManageList').onclick = () => {
      const p = $('#savedPanel');
      const show = p.style.display === 'none';
      p.style.display = show ? 'block' : 'none';
      if (show) refreshSavedListUI();
      $('#storageWarn').style.display = storageAvailable() ? 'none' : '';
    };
    $('#btnExportSaved').onclick = () => {
      try {
        const st = loadStore();
        const blob = new Blob([JSON.stringify(st, null, 2)], {
          type: 'application/json;charset=utf-8'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'lottery_lists_backup.json';
        a.click();
        URL.revokeObjectURL(a.href);
      } catch (e) {
        alert('导出失败：' + (e && e.message || e));
      }
    };
    $('#importSavedFile').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const obj = JSON.parse(fr.result);
          if (!obj || typeof obj !== 'object' || !obj.lists) {
            alert('文件格式不正确：缺少 lists 字段');
            return;
          }
          saveStore(obj);
          refreshSavedListUI();
          alert('导入完成，已覆盖本地保存的名单。');
        } catch (err) {
          alert('解析失败：' + err.message);
        }
      };
      fr.readAsText(f, 'utf-8');
    });

    /* -------------------- 页面打开：自动加载上次使用名单 -------------------- */
    (function autoLoad() {
      try {
        if (!storageAvailable()) return;
        const st = loadStore();
        if (st.lastUsed && st.lists[st.lastUsed]) {
          applyEntries(st.lists[st.lastUsed].entries, '已自动加载上次使用的名单：' + st.lastUsed + '（可直接抽奖）');
          $('#encInfo').textContent = '来源：本地存储';
        }
      } catch (e) {}
    })();

    /* -------------------- 初始化空 strip -------------------- */
    buildStrip([]);
  </script>
</body>

</html>