<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>本地名单抽奖 · 老虎机动画（紫色主题｜注释与文案增强版）</title>
<!--
  ================================================================
  项目：本地名单抽奖（结果与滚动一致）
  版本：V3 + 文案与注释增强（2025-10-19）
  说明：
    1) 仅优化「注释」与「界面文案/可视化文字」，不改变既有功能与逻辑。
    2) 便于二次维护：所有关键模块（解析/范围/动画/导出）均有分段注释。
    3) 更友好的可视化文案：操作提示更清晰、按钮/输入框提供 title 与 aria-*。
  注意：如需新增功能，请在对应模块下方新建分节，避免污染现有逻辑。
  ================================================================
-->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* ==================== 视觉美化 V3 (动画增强版) - 主题调色板 ==================== */
  :root {
    --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --panel: rgba(255, 255, 255, 0.75);
    --panel-border: rgba(233, 213, 255, 0.5);
    --text: #2d3748;
    --muted: #718096;
    --accent-50: #f5f3ff;
    --accent-100: #ede9fe;
    --accent-300: #c4b5fd;
    --accent-500: #8b5cf6;
    --accent-600: #7c3aed;
    --accent-700: #6d28d9;
    --ok: #28a745;
    --bad: #dc3545;
    --radius: 16px;
    --gap: 16px;
    --shadow: 0 10px 30px rgba(109, 40, 217, .12);
    --shadow-hover: 0 18px 40px rgba(109, 40, 217, .18);
    --shadow-inset: inset 0 2px 4px rgba(0,0,0,0.04);
    --cell-h: 56px;                /* 老虎机单格高度 */
    --reel-w: min(520px, 94vw);    /* 老虎机宽度（响应式）*/
    --reel-bg: #1f1147;
    --reel-grad-top: linear-gradient(to bottom, #1f1147 15%, rgba(31, 17, 71, 0));
    --reel-grad-btm: linear-gradient(to top, #1f1147 15%, rgba(31, 17, 71, 0));
  }

  /* ==================== 动画关键帧定义 ==================== */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulseWinner {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  @keyframes resultGlow {
    0% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
    50% { box-shadow: 0 0 24px rgba(124, 58, 237, 0.5); }
    100% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
  }

  /* ==================== 全局与重置 ==================== */
  * { box-sizing: border-box; }
  html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
  body {
    margin: 0;
    min-height: 100svh;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.7 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden; /* 防止入场动画产生滚动条 */
  }

  /* ==================== 布局 ==================== */
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: clamp(16px, 3vw, 32px);
    padding-top: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-top));
    padding-bottom: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-bottom));
  }
  .grid { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
  @media (min-width: 960px) { .grid { grid-template-columns: 1.1fr .9fr; } }
  .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
  @media (max-width: 720px) { .row > * { flex: 1 1 100%; } }

  /* ==================== 文字 ==================== */
  h1 {
    margin: 0 0 8px;
    color: #3c2d6b;
    font-size: clamp(22px, 3.8vw, 32px);
    font-weight: 800;
    letter-spacing: .2px;
    animation: fadeInUp 0.6s ease-out backwards;
  }
  h3 {
    margin: 20px 0 16px;
    padding-bottom: 8px;
    color: #4a3b7d;
    font-size: clamp(16px, 2.8vw, 20px);
    font-weight: 700;
    border-bottom: 1px solid var(--accent-100);
  }
  section.card > h3:first-child { margin-top: 0; }
  .sub {
    color: var(--muted);
    margin: 0 0 20px;
    font-size: 15px;
    animation: fadeInUp 0.6s 0.1s ease-out backwards;
  }
  .small { font-size: 13px; color: var(--muted); }

  /* ==================== 组件 ==================== */
  .card {
    padding: clamp(16px, 3vw, 24px);
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* 增强交互动画 */
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-hover);
  }
  .grid > .card:nth-child(1) { animation: fadeInUp 0.6s 0.2s ease-out backwards; }
  .grid > .card:nth-child(2) { animation: fadeInUp 0.6s 0.3s ease-out backwards; }

  /* 为动态出现的模块添加入场动画 */
  #mapping, #range { animation: fadeInUp 0.5s ease-out; }
  
  .list {
    padding: 10px;
    max-height: 40svh;
    overflow: auto;
    background: #fff;
    border: 1px solid var(--accent-100);
    border-radius: 12px;
  }
  .drop {
    padding: 24px 14px;
    text-align: center;
    background: rgba(250, 248, 255, 0.8);
    border: 2px dashed var(--accent-300);
    border-radius: 14px;
    transition: background-color .2s ease, border-color .2s ease;
  }
  .drop.drag { background: #f1eaff; border-color: var(--accent-600); }

  .result {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 56px;
    padding: 12px 16px;
    text-align: center;
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    letter-spacing: .5px;
    background: linear-gradient(135deg, var(--accent-700), var(--accent-500));
    border-radius: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    /* 中奖结果动画 */
    animation: resultGlow 2.5s infinite ease-in-out, pulseWinner 0.6s ease-out;
  }
  
  /* ==================== 表单 ==================== */
  input, select, textarea, button { font-size: 16px; }
  input[type="number"], input[type="text"], select, textarea {
    width: 100%;
    padding: 12px 14px;
    background-color: #fdfcff;
    border: 1px solid var(--accent-100);
    border-radius: 10px;
    outline: 0;
    box-shadow: var(--shadow-inset);
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
    border-color: var(--accent-300);
    box-shadow: var(--shadow-inset), 0 0 0 4px rgba(124, 58, 237, .15);
  }
  textarea { line-height: 1.6; min-height: 60px; }
  input[type="checkbox"], input[type="radio"] { accent-color: var(--accent-600); }
  
  .btn {
    position: relative; /* 为流光效果定位 */
    overflow: hidden;   /* 隐藏超出范围的流光 */
    padding: 12px 18px;
    color: #fff;
    font-weight: 700;
    letter-spacing: .4px;
    background-image: linear-gradient(145deg, var(--accent-500), var(--accent-600));
    border: 0;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(124, 58, 237, .2), 0 1px 3px rgba(124, 58, 237, .3);
    cursor: pointer;
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover {
    transform: translateY(-2px);
    filter: saturate(1.1) brightness(1.05);
    box-shadow: 0 8px 18px rgba(124, 58, 237, .28), 0 2px 5px rgba(124, 58, 237, .3);
  }
  .btn:active { transform: translateY(0px); filter: brightness(0.95); }
  .btn:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(50%); transform: none; }
  
  /* 流光动画效果 */
  .btn::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
    transform: rotate(30deg) translateX(-150%);
    transition: transform 0.8s ease;
  }
  .btn:hover::after { transform: rotate(30deg) translateX(150%); }

  .btn.ghost {
    color: #3b2a69;
    font-weight: 600;
    background: rgba(243, 240, 255, 0.8);
    border: 1px solid var(--accent-100);
    box-shadow: none;
    transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
  }
  .btn.ghost:hover { background-color: var(--accent-50); border-color: var(--accent-300); transform: translateY(-1px); }
  .btn.ok { background-image: linear-gradient(145deg, #34d399, #10b981); box-shadow: 0 4px 12px rgba(22,163,74,.25); }
  .btn.bad { background-image: linear-gradient(145deg, #f87171, #ef4444); box-shadow: 0 4px 12px rgba(239,68,68,.25); }
  @media (max-width: 720px) { .btn { width: 100%; } }

  /* ==================== 老虎机动画 ==================== */
  .reelsWrap { display: flex; justify-content: center; }
  .reel {
    position: relative;
    width: var(--reel-w);
    height: calc(var(--cell-h) * 3);
    overflow: hidden;
    background: var(--reel-bg);
    border-radius: 14px;
    box-shadow: inset 0 0 12px rgba(0,0,0,.5), 0 15px 40px rgba(31,17,71,.3);
  }
  .strip { position: absolute; top: 0; left: 0; right: 0; will-change: transform; }
  .cell {
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    padding: 0 16px;
    overflow: hidden;
    color: #e0d9ff;
    font-size: 1.1em;
    font-weight: 700;
    white-space: nowrap;
    text-overflow: ellipsis;
    letter-spacing: .2px;
    text-shadow: 0 0 8px rgba(230, 220, 255, 0.3);
  }
  .cell.under-hidden { visibility: hidden; }
  .reel::before, .reel::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    height: calc(var(--cell-h) * 1.1);
    pointer-events: none;
    z-index: 2;
  }
  .reel::before { top: 0; background: var(--reel-grad-top); }
  .reel::after { bottom: 0; background: var(--reel-grad-btm); }
  
  .marker {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    height: var(--cell-h);
    pointer-events: none;
  }
  .marker::before {
    content: '';
    position: absolute;
    inset: 4px 8px;
    border-radius: 10px;
    background: linear-gradient(90deg, var(--accent-500), var(--accent-300));
    opacity: 0.2;
    filter: blur(8px);
  }
  .marker::after {
    content: '';
    position: absolute;
    inset: 2px 6px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.6);
  }

  .overlay {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    z-index: 3;
  }
  .overlay.show { opacity: 1; }
  #history { max-height: 34svh; }

  /* ==================== 按姓名范围列表 ==================== */
  :root {
    --name-maxh: clamp(380px, 64svh, 820px);
    --name-font: 18px;
    --name-line: 1.35;
    --name-item-pad-y: 6px;
    --name-item-gap: 10px;
    --name-check-size: 18px;
    --name-cols: 3; /* 宽屏每行 3 列姓名，窄屏响应式下调 */
  }
  #nameRange .row { gap: 8px; }
  #nameRange #nameSearch { height: 44px; padding: 12px 14px; font-size: var(--name-font); line-height: 1.2; }
  #nameRange .btn { font-size: 15px; padding: 10px 14px; border-radius: 10px; }

  #nameList {
    display: grid;
    grid-template-columns: repeat(var(--name-cols), minmax(0, 1fr));
    gap: 4px 8px;
    padding: 8px;
    max-height: var(--name-maxh);
    font-size: var(--name-font);
    line-height: var(--name-line);
    border-radius: 12px;
  }
  #nameList label {
    display: flex;
    align-items: center;
    gap: var(--name-item-gap);
    min-width: 0;
    padding: var(--name-item-pad-y) 10px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  #nameList label:hover { background: var(--accent-50); }
  #nameList input[type="checkbox"] { flex: 0 0 auto; width: var(--name-check-size); height: var(--name-check-size); }
  #nameList .nm { min-width: 0; overflow: hidden; text-overflow: ellipsis; }
  #nameList input[type="checkbox"]:checked + .nm { color: var(--accent-700); font-weight: 600; }

  @media (max-width: 900px) { :root { --name-cols: 2; } }
  @media (max-width: 560px) { :root { --name-cols: 1; --name-font:17px; --name-check-size:17px; } }

  /* ==================== 功能类 ==================== */
  ::selection { background: var(--accent-300); color:#fff; }
  ::-webkit-scrollbar { width: 10px; height: 10px; }
  ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent-300), var(--accent-600)); border-radius: 8px; border: 2px solid var(--accent-50); }
  ::-webkit-scrollbar-track { background: var(--accent-50); border-radius: 8px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>本地名单抽奖（结果与滚动一致）</h1>
  <p class="sub">支持 TXT/CSV/XLS/XLSX；自动识别编码（UTF-8/UTF-16/GBK/GB18030/Big5/Shift_JIS…）；可「按学号区间」或「按姓名勾选」设置范围；同轮不重复；可设随机种子确保复现；支持导出 CSV。<br>小贴士：导入前请尽量清洗空行与多余空格，以提升解析准确率。</p>

  <div class="grid">
    <!-- ==================== 左侧：导入/映射/范围 ==================== -->
    <section class="card" aria-label="导入与范围设置">
      <h3>① 导入名单</h3>
      <div class="row">
        <!-- label 关联隐藏的文件选择 input，便于自定义样式 -->
        <label class="btn ghost" for="file" title="从本地选择 TXT/CSV/XLS/XLSX 名单文件（支持拖拽）">选择文件</label>
        <input id="file" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none" aria-label="选择名单文件">
        <button id="btnClear" class="btn ghost" title="清空当前已导入的数据与候选列表">清空</button>
      </div>
      <div id="dz" class="drop" style="margin-top:10px" title="也可直接将文件拖拽到此区域">
        拖拽 TXT/CSV/XLS/XLSX 到此处，或点击“选择文件”
        <div class="small">TXT/CSV 每行可写「姓名,学号」或单列；Excel 支持「序号|姓名|序号|姓名」。编码将自动识别。</div>
        <div id="encInfo" class="small" aria-live="polite"></div>
      </div>

      <!-- 列映射：当检测到表头时出现，便于选择「姓名列/学号列」 -->
      <div id="mapping" style="margin-top:12px;display:none">
        <h3>② 列映射（检测到表头，可调整）</h3>
        <div class="row">
          姓名列：<select id="selName" title="请选择姓名所在的列"></select>
          学号列：<select id="selId" title="请选择学号所在的列"></select>
          <button id="applyMap" class="btn ghost" title="应用映射后请重新导入一次文件以便生效">应用映射</button>
        </div>
        <div id="sample" class="small" style="margin-top:6px"></div>
      </div>

      <!-- 范围选择：按学号区间 / 按姓名勾选，两种模式互斥 -->
      <div id="range" style="margin-top:12px;display:none">
        <h3>③ 抽取范围</h3>
        <div class="row" role="radiogroup" aria-label="范围模式">
          <label title="通过学号最小/最大值限定候选"><input type="radio" name="mode" value="id" checked> 按学号</label>
          <label title="手动勾选要参与抽取的姓名"><input type="radio" name="mode" value="name"> 按姓名</label>
        </div>

        <div id="idRange" style="margin-top:6px">
          <div class="row">
            学号区间：
            <input id="idMin" type="number" placeholder="起始" title="候选学号下界（包含）">
            <span style="align-self:center">—</span>
            <input id="idMax" type="number" placeholder="结束" title="候选学号上界（包含）">
            <button id="fillMM" class="btn ghost" title="自动读取数据中的最小/最大学号并填入">用最小/最大填充</button>
          </div>
          <div class="small">提示：仅在「导入数据中存在的学号」里抽，超出区间或不存在的学号不会被纳入。</div>
        </div>

        <div id="nameRange" style="display:none;margin-top:6px">
          <div class="row">
            <input id="nameSearch" type="text" placeholder="搜索姓名（支持模糊匹配）" style="flex:1" title="输入关键字可临时筛选下方姓名列表">
            <button id="all" class="btn ghost" title="全选当前可见的姓名">全选</button>
            <button id="none" class="btn ghost" title="取消选择">全不选</button>
          </div>
          <div id="nameList" class="list" style="margin-top:6px" aria-label="姓名可选列表"></div>
        </div>

        <div style="margin-top:8px">
          <div class="small">排除名单（姓名或学号，逗号/空格分隔）：</div>
          <textarea id="exclude" placeholder="例：张三 10021,10023 李四" title="这里列出的姓名/学号将被排除，不参与抽取"></textarea>
        </div>
      </div>
    </section>

    <!-- ==================== 右侧：设置/结果/历史 ==================== -->
    <section class="card" aria-label="抽取设置与结果">
      <h3>④ 抽取设置与结果</h3>
      <div class="row">
        连抽次数：<input id="count" type="number" min="1" value="1" style="width:110px" title="一次运行连续抽取的次数">
        <label title="同一轮运行内不重复同一人"><input id="noRepeat" type="checkbox" checked> 同轮不重复</label>
      </div>
      <div class="row" style="margin-top:6px">
        随机种子（可选，保证可复现）：
        <input id="seed" type="text" placeholder="留空使用系统随机，例如：2025-晚会-B01" style="flex:1" title="同样的种子+同样的数据+同样的设置，会得到完全一致的结果">
      </div>
      <div class="row" style="margin-top:8px">
        <button id="start" class="btn ok" title="开始抽取（滚动动画与最终结果保持一致）">开始抽取</button>
        <button id="stop" class="btn bad" disabled title="停止当前轮次的连续抽取">停止</button>
        <button id="export" class="btn" title="导出当前会话的中奖记录（CSV 文件）">导出中奖记录</button>
      </div>

      <!-- 老虎机可视化区：strip 为滚动条，overlay 为中央高亮文本层 -->
      <div class="reelsWrap" style="margin-top:10px">
        <div class="reel" aria-label="抽取滚动显示">
          <div id="strip" class="strip"></div>
          <div class="marker" aria-hidden="true"></div>
          <div id="overlay" class="overlay" aria-hidden="true"></div>
        </div>
      </div>

      <div id="screen" class="result" style="margin-top:10px" aria-live="polite">等待抽取…（请先导入数据并设置范围）</div>
      <div class="row" style="margin-top:8px"><span class="small">已导入：<b id="statTotal">0</b> | 当前候选：<b id="statCand">0</b></span></div>
      <h3 style="margin-top:12px">历史记录</h3>
      <div class="small" style="margin-bottom:6px">最新记录在最上方，包含时间与当次抽中的名单（若为连抽则逐条记录）。</div>
      <div id="history" class="list small" aria-label="中奖历史列表"></div>
    </section>
  </div>

  <p class="small" style="margin-top:10px;color:#6b7280">
    动画由 <code>requestAnimationFrame</code> 驱动，位移用 <code>transform: translateY</code>，溢出用 <code>overflow:hidden</code> 裁剪；
    文本文件采用智能编码检测解析（优先识别 BOM，其次候选评分）。
  </p>
</div>

<script>
/** *******************************************************************
 * 工具函数区：随机数、选择器、文本处理
 * 说明：仅做复用工具，无业务副作用。
 *********************************************************************/
function mulberry32(seed){
  // 简洁快速的 32 位 PRNG（可复现），用于指定种子时保障结果一致
  let t=seed>>>0;
  return()=>{
    t+=0x6D2B79F5;
    let r=Math.imul(t^(t>>>15),1|t);
    r^=r+Math.imul(r^(r>>>7),61|r);
    return((r^(r>>>14))>>>0)/4294967296;
  }
}
function hashSeed(s){
  // 将任意字符串转为 32 位整数种子（FNV-1a）
  let h=2166136261>>>0; for(const ch of s){ h^=ch.charCodeAt(0); h=Math.imul(h,16777619) } return h>>>0;
}
let rng=Math.random; // 默认使用系统随机；若用户填写了 seed，则替换为 mulberry32(seed)

// 轻量选择器
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

// 文本清洗与特征判断
function clean(v){ if(v==null) return ""; return String(v).replace(/\s+/g," ").trim() }
function isCJK(s){ return /[\u3400-\u9FFF]/.test(s) } // 是否包含中日韩统一表意字符
function looksId(s){ return /^\d+$/.test(s) }        // 是否全为数字（学号）
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])) }

/** *******************************************************************
 * 智能编码识别 decodeSmart(u8)
 * 策略：
 *   1) 优先判断 BOM（UTF-8 / UTF-16LE / UTF-16BE），命中则剥离 BOM 后解码。
 *   2) 否则在候选编码集中逐个尝试（允许非致命错误），按以下指标打分：
 *      - 乱码替代符 \uFFFD 数量（越少越好，权重最高）
 *      - 控制字符数量（越少越好）
 *      - CJK 字符数量（越多越可能正确，因常见中文名单）
 *      - 对 UTF-8 略微加分，对部分西文单字节编码略微减分
 *   3) 若仍失败，则回退到运行时默认解码（通常为 UTF-8）。
 *********************************************************************/
function decodeSmart(u8){
  const encInfoEl = document.getElementById('encInfo');
  const hasBOM = (u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) ||
                 (u8.length>=2 && ((u8[0]===0xFF && u8[1]===0xFE) || (u8[0]===0xFE && u8[1]===0xFF)));
  try{
    // --- UTF-8 with BOM ---
    if(u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF){
      const txt = new TextDecoder('utf-8').decode(u8.subarray(3));
      encInfoEl.textContent = '编码：UTF-8 (BOM)';
      return txt;
    }
    // --- UTF-16 LE with BOM ---
    if(u8.length>=2 && u8[0]===0xFF && u8[1]===0xFE){
      const txt = new TextDecoder('utf-16le').decode(u8.subarray(2));
      encInfoEl.textContent = '编码：UTF-16LE (BOM)';
      return txt;
    }
    // --- UTF-16 BE with BOM ---
    if(u8.length>=2 && u8[0]===0xFE && u8[1]===0xFF){
      const txt = new TextDecoder('utf-16be').decode(u8.subarray(2));
      encInfoEl.textContent = '编码：UTF-16BE (BOM)';
      return txt;
    }
  }catch(e){ /* 若极端情况下 TextDecoder 抛错，进入候选评分流程 */ }

  // 候选编码尝试集（可按需扩充）
  const labels = ['utf-8','gb18030','gbk','big5','shift_jis','euc-kr','windows-1252','iso-8859-1','koi8-r','macintosh','utf-16le','utf-16be'];
  let best = {score:-Infinity, text:null, label:null};
  for(const lb of labels){
    try{
      const dec = new TextDecoder(lb, {fatal:false, ignoreBOM:true});
      const txt = dec.decode(u8);
      const bad = (txt.match(/\uFFFD/g)||[]).length;          // 乱码替代符数量
      const ctl = (txt.match(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g)||[]).length; // 控制字符
      const cjk = (txt.match(/[\u3400-\u9FFF\uF900-\uFAFF]/g)||[]).length;   // CJK 文字
      let score = 1000 - bad*100 - ctl*2 + cjk;
      if(lb==='utf-8') score += 10; // 常见且稳定
      if(/^windows|iso-8859|macintosh/i.test(lb)) score -= 5; // 轻微降权
      if(score > best.score) best = {score, text:txt, label:lb};
    }catch(e){ /* 某些环境可能不支持特定标签，忽略 */ }
  }
  if(best.text!=null){
    encInfoEl.textContent = `编码（推测）：${best.label}${hasBOM?' + BOM':''}`;
    return best.text;
  }
  // 兜底策略
  try{
    const txt = new TextDecoder().decode(u8);
    encInfoEl.textContent = '编码：未知（使用默认解码）';
    return txt;
  }catch(e){
    encInfoEl.textContent = '编码：解码失败，请尝试使用 UTF-8 重新保存后再导入。';
    throw e;
  }
}

/** *******************************************************************
 * 文件读取与预处理：TXT/CSV/Excel
 *********************************************************************/
const dz=$('#dz');
// 拖拽高亮
dz.addEventListener('dragover',e=>{ e.preventDefault(); dz.classList.add('drag') });
dz.addEventListener('dragleave',()=> dz.classList.remove('drag'));
// 拖拽文件
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('drag');
  if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0])
});
// 文件选择
$('#file').addEventListener('change',e=>{ if(e.target.files[0]) handleFile(e.target.files[0]) });
// 清空数据
$('#btnClear').addEventListener('click',()=>{
  entries=[]; candidates=[]; winnersAll=[]; updateStats();
  $('#mapping').style.display='none'; $('#range').style.display='none';
  $('#screen').textContent='等待抽取…（请先导入数据并设置范围）';
  $('#history').innerHTML=''; $('#encInfo').textContent='';
  buildStrip([]);
});

// 根据扩展名选用解析方式
function handleFile(file){
  const n=file.name.toLowerCase();
  if(n.endsWith('.xlsx')||n.endsWith('.xls')){
    const fr=new FileReader(); fr.onload=()=>parseExcel(fr.result); fr.readAsArrayBuffer(file);
  }else{
    const fr=new FileReader();
    fr.onload=()=>{
      const u8 = new Uint8Array(fr.result);
      let text = '';
      try{ text = decodeSmart(u8); }
      catch(err){ alert('无法识别文本编码：'+(err&&err.message||err)+'\n建议：将文件另存为 UTF-8 后重试，或改用 Excel 格式导入。'); return; }
      parseText(text);
    };
    fr.readAsArrayBuffer(file);
  }
}

// 解析 Excel（取第一个工作表）
function parseExcel(buf){
  const wb=XLSX.read(new Uint8Array(buf),{type:'array'}), sh=wb.Sheets[wb.SheetNames[0]];
  const aoa=XLSX.utils.sheet_to_json(sh,{header:1,raw:false,defval:""});
  processAOA(aoa);
}

// 解析纯文本（支持逗号/中文逗号/制表符/空白分隔）
function parseText(text){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const aoa=lines.map(line=>{
    let cells=line.split(/,|，/);
    if(cells.length===1) cells=line.split(/\t+/);
    if(cells.length===1) cells=line.split(/\s+/);
    return cells.map(clean);
  });
  processAOA(aoa);
}

/** *******************************************************************
 * AOA -> entries：兼容「表头」与「两列成组（序号|姓名）」
 * 输出 entries 结构：{ name, id, label }
 *********************************************************************/
let entries=[], candidates=[], winnersAll=[];   // 全量/候选/历史
let autoRun=false, spinning=false;              // 运行状态

function processAOA(aoa){
  const rows=aoa.filter(r=> (r||[]).some(c=>clean(c)!==""));
  if(!rows.length){ alert('未解析到有效数据。\n请确认：每行至少包含一个姓名或学号；分隔符可为逗号/空格/制表符。'); return; }

  // 智能识别表头位置与列索引
  const keyName=/姓名|name|学生姓名|同学/i, keyId=/学号|学籍号|编号|序号|id|number|no/i;
  let header=-1, nameIdx=-1, idIdx=-1;
  for(let i=0;i<Math.min(10,rows.length);i++){
    const r=rows[i].map(clean);
    for(let c=0;c<r.length;c++){
      if(nameIdx===-1&&keyName.test(r[c])) nameIdx=c, header=i;
      if(idIdx===-1&&keyId.test(r[c]))    idIdx=c, header=i;
    }
    if(header===i && (nameIdx!==-1 || idIdx!==-1)) break;
  }

  // 将不同输入格式统一为 {name, id}
  let parsed=[];
  if(header!==-1){
    // 表头模式：后续各行根据列索引提取
    for(let i=header+1;i<rows.length;i++){
      const r=rows[i].map(clean);
      const name=nameIdx!==-1?clean(r[nameIdx]):"";
      const id=idIdx!==-1?clean(r[idIdx]):"";
      if(name||id) parsed.push({name,id});
    }
    showMapping(rows[header]);
  }else{
    // 无表头：按「两列成组」或「单列姓名/学号」猜测
    for(const r0 of rows){
      const r=r0.map(clean);
      for(let c=0;c<r.length;c+=2){
        const a=r[c]??"", b=r[c+1]??""; if(!a&&!b) continue;
        if(/^\d+$/.test(a)&&isCJK(b)) parsed.push({id:String(a),name:b});
        else if(isCJK(a)&&/^\d+$/.test(b)) parsed.push({id:String(b),name:a});
        else if(isCJK(a)&&!b) parsed.push({id:"",name:a});
        else if(isCJK(b)&&!a) parsed.push({id:"",name:b});
      }
    }
    $('#mapping').style.display='none'; $('#range').style.display='';
  }

  // 去重与统一显示标签 label（优先显示“姓名（学号）”）
  const seen=new Set();
  entries=parsed.filter(x=>{
      const key=(x.name||"")+"|"+(x.id||"");
      if(!x.name&&!x.id) return false;
      if(seen.has(key)) return false;
      seen.add(key); return true;
    })
    .map(x=>({
      name:x.name,
      id:x.id,
      label:x.name&&x.id?`${x.name}（${x.id}）`:(x.name||x.id)
    }));

  buildNameList();
  fillIdMM();
  updateCandidates();
  updateStats();
  $('#screen').textContent='数据已载入，请设置范围后点击“开始抽取”。';
}

// 显示映射下拉供用户确认（提示重新导入以生效）
function showMapping(headerRow){
  const cols=headerRow.map((v,i)=>({i,label:clean(v)||(`列${i+1}`)}));
  const selN=$('#selName'), selI=$('#selId');
  selN.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
  selI.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
  $('#mapping').style.display=''; $('#range').style.display='';
  $('#applyMap').onclick=()=>{ alert('已应用映射。\n为简洁起见，请按新映射重新导入一次文件以完全生效。'); };
  $('#sample').textContent='已检测到表头：'+headerRow.map(clean).join(' | ');
}

/** *******************************************************************
 * 范围选择与候选集更新
 *********************************************************************/
function buildNameList(){
  const box=$('#nameList');
  const names=[...new Set(entries.map(e=>e.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'zh'));
  box.innerHTML=names.map(n=>{
    const safe = escapeHtml(n);
    return `<label title="勾选/取消该姓名参与抽取"><input type="checkbox" class="cbN" value="${safe}" checked><span class="nm">${safe}</span></label>`;
  }).join('');
  // 即时搜索：仅影响可见性，不改变勾选状态
  $('#nameSearch').oninput=()=>{
    const kw=$('#nameSearch').value.trim();
    $$('.cbN').forEach(cb=>{
      const lab=cb.closest('label');
      const show=!kw || cb.value.includes(kw);
      lab.style.display=show?'flex':'none';
    });
  };
  // 全选/全不选按钮
  $('#all').onclick=()=>{ $$('.cbN').forEach(cb=>cb.checked=true); updateCandidates(); };
  $('#none').onclick=()=>{ $$('.cbN').forEach(cb=>cb.checked=false); updateCandidates(); };
}

// 自动填入学号最小/最大值
function fillIdMM(){
  const ids=entries.map(e=>e.id).filter(v=>/^\d+$/.test(v)).map(Number);
  if(ids.length){ $('#idMin').value=Math.min(...ids); $('#idMax').value=Math.max(...ids); }
}
$('#fillMM').onclick=fillIdMM;

// 切换范围模式：id/name
$$('input[name="mode"]').forEach(r=> r.addEventListener('change',()=>{
  const m=document.querySelector('input[name="mode"]:checked').value;
  $('#idRange').style.display=m==='id'?'':'none';
  $('#nameRange').style.display=m==='name'?'':'none';
  updateCandidates();
}));

// 输入变化时重算候选
['idMin','idMax','exclude'].forEach(id=> document.getElementById(id).addEventListener('input', updateCandidates));
document.addEventListener('change', e=>{ if(e.target.classList && e.target.classList.contains('cbN')) updateCandidates(); });

// 汇总候选集
function updateCandidates(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  const excl=new Set( ($('#exclude').value.trim().split(/[\s,，;；]+/).filter(Boolean)) );
  let pool=[];
  if(mode==='id'){
    const min=+( $('#idMin').value || Number.NEGATIVE_INFINITY );
    const max=+( $('#idMax').value || Number.POSITIVE_INFINITY );
    pool=entries.filter(e=> /^\d+$/.test(e.id) && +e.id>=min && +e.id<=max );
  }else{
    const allowed=new Set([...document.querySelectorAll('.cbN:checked')].map(cb=>cb.value));
    pool=entries.filter(e=> e.name && allowed.has(e.name));
  }
  // 排除名单（支持姓名/学号）
  pool=pool.filter(e=> !(excl.has(e.name)||excl.has(e.id)) );
  candidates=pool; updateStats(); buildStrip(candidates);
}
function updateStats(){ $('#statTotal').textContent=entries.length; $('#statCand').textContent=candidates.length; }

/** *******************************************************************
 * 老虎机动画：确保「可见中央项 === 抽中结果」
 * 思路概述：
 *   1) 抽取前先复制一份当前候选快照 snapshot（保证动画期间不会受外部改变影响）。
 *   2) 在快照上挑出目标索引 winnerIdx，并预先构建 strip 内容，使其滚动结束时中央项为 winner。
 *   3) 使用 easeOutCubic 做减速动画，结束后将中央下方原始 cell 设为隐藏，叠加 overlay 文本。
 *********************************************************************/
const VISIBLE_ROWS=3, CENTER_INDEX=1, COPIES=3, MAX_N_DOM=400; // DOM 数量做上限以防爆内存
const stripEl=document.getElementById('strip'), overlayEl=document.getElementById('overlay');

// 初次或候选变化时构建静态 strip（非抽取态）
function buildStrip(list){
  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
  const baseCount=Math.max(list.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
  stripEl.dataset.ndom=String(Ndom);
  for(let k=0;k<COPIES;k++){
    for(let i=0;i<Ndom;i++){
      const d=document.createElement('div'); d.className='cell';
      const data=list.length?list[i%list.length]:{label:String(i+1)};
      d.textContent=data.label; stripEl.appendChild(d);
    }
  }
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}

// 为抽取过程按「快照 + 目标索引」重排 strip，使滚动后中央即为获选项
function buildStripForSpin(snapshot, winnerIdx){
  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
  const baseCount=Math.max(snapshot.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
  stripEl.dataset.ndom=String(Ndom);
  // 计算从哪一项开始渲染，确保滚动后中央是 winnerIdx
  const start=(winnerIdx - (CENTER_INDEX + 1) + snapshot.length) % snapshot.length;
  for(let k=0;k<COPIES;k++){
    for(let i=0;i<Ndom;i++){
      const data = snapshot[(start + i) % snapshot.length];
      const d=document.createElement('div'); d.className='cell'; d.textContent=data.label; stripEl.appendChild(d);
    }
  }
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}

// 缓动函数（减速）
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

// 执行动画到中央（不改变最终 transform，避免浮点累积）
function spinToCenter(){
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const Ndom=parseInt(stripEl.dataset.ndom,10)||VISIBLE_ROWS;
  const base=-CENTER_INDEX*cellH;
  const spins=14, duration=1400, travel=spins*Ndom*cellH; // 总路程按整圈倍数计算
  return new Promise(resolve=>{
    const t0=performance.now();
    function frame(now){
      const t=Math.max(0,Math.min(1,(now-t0)/duration));
      const yRaw=-travel*easeOutCubic(t);
      const yLoop=-(Math.abs(yRaw)%(Ndom*cellH));
      stripEl.style.transform=`translateY(${base + yLoop}px)`;
      if(t<1) requestAnimationFrame(frame); else { stripEl.style.transform=`translateY(${base}px)`; resolve(); }
    }
    requestAnimationFrame(frame);
  });
}

// 从快照中挑选目标项（可选同轮不重复）
function pickFromSnapshot(snapshot, excludeSet){
  const idxPool=[];
  for(let i=0;i<snapshot.length;i++){
    const key=snapshot[i].name+'|'+snapshot[i].id;
    if(!excludeSet || !excludeSet.has(key)) idxPool.push(i);
  }
  if(!idxPool.length) return null;
  const chosenIndexInPool = Math.floor(rng()*idxPool.length);
  const idxSnap = idxPool[chosenIndexInPool];
  const item = snapshot[idxSnap];
  const idxGlobal = candidates.findIndex(e=> e===item || (e.name===item.name && e.id===item.id));
  return { item, idxSnap, idxGlobal };
}

// 渲染历史区域（新记录置顶）
function renderHistory(){
  $('#history').innerHTML=winnersAll.slice().reverse().map(rec=>{
    const line=rec.list.length?rec.list.map(x=>x.label).join('、'):'（无）';
    return `<div style="padding:6px 0;border-bottom:1px dashed #e5e7eb"><div><b>${rec.time}</b></div><div>${line}</div></div>`;
  }).join('');
}

// 控制按钮忙闲状态
function setBusy(b){ spinning=b; $('#start').disabled=b; $('#stop').disabled=!b; }

// 绑定「开始/停止/导出」按钮
$('#start').onclick = async ()=>{
  if(spinning||autoRun) return;
  if(!candidates.length){ alert('候选集为空：请检查范围设置或排除名单，确认列表中存在可抽取的条目。'); return; }
  // 根据 seed 配置 RNG（保证可复现）
  rng = ($('#seed').value.trim()) ? mulberry32(hashSeed($('#seed').value.trim())) : Math.random;

  const N=Math.max(1, Math.floor(+$('#count').value||1));
  const used=new Set(); autoRun=true; setBusy(true);

  for(let i=0;i<N && autoRun;i++){
    // 每次抽取使用候选快照，避免动画期间外部变化造成不一致
    const snapshot=candidates.slice();
    const pick=pickFromSnapshot(snapshot, $('#noRepeat').checked ? used : null);
    if(!pick){ break; }

    // 按目标重排 strip 并播放动画
    buildStripForSpin(snapshot, pick.idxSnap);
    await spinToCenter();

    // 隐藏中央下一格，叠加高亮 overlay；屏幕区输出可读文案
    const under = stripEl.children[CENTER_INDEX+1]; if(under) under.classList.add('under-hidden');
    requestAnimationFrame(()=>{ $('#overlay').textContent = pick.item.label; $('#overlay').classList.add('show'); });
    $('#screen').textContent='🎉 恭喜：'+pick.item.label;

    // 记录历史
    const when=new Date().toLocaleString(); winnersAll.push({time:when,list:[pick.item]}); renderHistory();

    // 同轮不重复：记录已用键值
    if($('#noRepeat').checked){ used.add(pick.item.name+'|'+pick.item.id); }

    // 连抽节流（避免动画叠加过紧）
    await new Promise(r=>setTimeout(r, 300));
  }
  autoRun=false; setBusy(false);
};
$('#stop').onclick=()=>{ autoRun=false; };

// 导出 CSV（含时间/序号/姓名/学号/显示标签）
$('#export').onclick=()=>{
  if(!winnersAll.length){ alert('暂无中奖记录可导出。'); return; }
  const rows=[[ '时间','序号','姓名','学号','显示标签' ]];
  winnersAll.forEach(rec=> rec.list.forEach((p,i)=> rows.push([rec.time,i+1,p.name,p.id,p.label])) );
  const csv=rows.map(r=> r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
};

// 首次进入：构建空 strip
buildStrip([]);
</script>
</body>
</html>
