<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>æœ¬åœ°åå•æŠ½å¥– Â· è€è™æœºåŠ¨ç”»ï¼ˆç´«è‰²ä¸»é¢˜ï½œæ³¨é‡Šä¸æ–‡æ¡ˆå¢å¼ºç‰ˆï¼‰</title>
<!--
  ================================================================
  é¡¹ç›®ï¼šæœ¬åœ°åå•æŠ½å¥–ï¼ˆç»“æœä¸æ»šåŠ¨ä¸€è‡´ï¼‰
  ç‰ˆæœ¬ï¼šV3 + æ–‡æ¡ˆä¸æ³¨é‡Šå¢å¼ºï¼ˆ2025-10-19ï¼‰
  è¯´æ˜ï¼š
    1) ä»…ä¼˜åŒ–ã€Œæ³¨é‡Šã€ä¸ã€Œç•Œé¢æ–‡æ¡ˆ/å¯è§†åŒ–æ–‡å­—ã€ï¼Œä¸æ”¹å˜æ—¢æœ‰åŠŸèƒ½ä¸é€»è¾‘ã€‚
    2) ä¾¿äºäºŒæ¬¡ç»´æŠ¤ï¼šæ‰€æœ‰å…³é”®æ¨¡å—ï¼ˆè§£æ/èŒƒå›´/åŠ¨ç”»/å¯¼å‡ºï¼‰å‡æœ‰åˆ†æ®µæ³¨é‡Šã€‚
    3) æ›´å‹å¥½çš„å¯è§†åŒ–æ–‡æ¡ˆï¼šæ“ä½œæç¤ºæ›´æ¸…æ™°ã€æŒ‰é’®/è¾“å…¥æ¡†æä¾› title ä¸ aria-*ã€‚
  æ³¨æ„ï¼šå¦‚éœ€æ–°å¢åŠŸèƒ½ï¼Œè¯·åœ¨å¯¹åº”æ¨¡å—ä¸‹æ–¹æ–°å»ºåˆ†èŠ‚ï¼Œé¿å…æ±¡æŸ“ç°æœ‰é€»è¾‘ã€‚
  ================================================================
-->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* ==================== è§†è§‰ç¾åŒ– V3 (åŠ¨ç”»å¢å¼ºç‰ˆ) - ä¸»é¢˜è°ƒè‰²æ¿ ==================== */
  :root {
    --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --panel: rgba(255, 255, 255, 0.75);
    --panel-border: rgba(233, 213, 255, 0.5);
    --text: #2d3748;
    --muted: #718096;
    --accent-50: #f5f3ff;
    --accent-100: #ede9fe;
    --accent-300: #c4b5fd;
    --accent-500: #8b5cf6;
    --accent-600: #7c3aed;
    --accent-700: #6d28d9;
    --ok: #28a745;
    --bad: #dc3545;
    --radius: 16px;
    --gap: 16px;
    --shadow: 0 10px 30px rgba(109, 40, 217, .12);
    --shadow-hover: 0 18px 40px rgba(109, 40, 217, .18);
    --shadow-inset: inset 0 2px 4px rgba(0,0,0,0.04);
    --cell-h: 56px;                /* è€è™æœºå•æ ¼é«˜åº¦ */
    --reel-w: min(520px, 94vw);    /* è€è™æœºå®½åº¦ï¼ˆå“åº”å¼ï¼‰*/
    --reel-bg: #1f1147;
    --reel-grad-top: linear-gradient(to bottom, #1f1147 15%, rgba(31, 17, 71, 0));
    --reel-grad-btm: linear-gradient(to top, #1f1147 15%, rgba(31, 17, 71, 0));
  }

  /* ==================== åŠ¨ç”»å…³é”®å¸§å®šä¹‰ ==================== */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulseWinner {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  @keyframes resultGlow {
    0% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
    50% { box-shadow: 0 0 24px rgba(124, 58, 237, 0.5); }
    100% { box-shadow: 0 0 12px rgba(124, 58, 237, 0.2); }
  }

  /* ==================== å…¨å±€ä¸é‡ç½® ==================== */
  * { box-sizing: border-box; }
  html { -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
  body {
    margin: 0;
    min-height: 100svh;
    background: var(--bg);
    color: var(--text);
    font: 16px/1.7 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden; /* é˜²æ­¢å…¥åœºåŠ¨ç”»äº§ç”Ÿæ»šåŠ¨æ¡ */
  }

  /* ==================== å¸ƒå±€ ==================== */
  .wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: clamp(16px, 3vw, 32px);
    padding-top: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-top));
    padding-bottom: calc(clamp(16px, 3vw, 32px) + env(safe-area-inset-bottom));
  }
  .grid { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
  @media (min-width: 960px) { .grid { grid-template-columns: 1.1fr .9fr; } }
  .row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
  @media (max-width: 720px) { .row > * { flex: 1 1 100%; } }

  /* ==================== æ–‡å­— ==================== */
  h1 {
    margin: 0 0 8px;
    color: #3c2d6b;
    font-size: clamp(22px, 3.8vw, 32px);
    font-weight: 800;
    letter-spacing: .2px;
    animation: fadeInUp 0.6s ease-out backwards;
  }
  h3 {
    margin: 20px 0 16px;
    padding-bottom: 8px;
    color: #4a3b7d;
    font-size: clamp(16px, 2.8vw, 20px);
    font-weight: 700;
    border-bottom: 1px solid var(--accent-100);
  }
  section.card > h3:first-child { margin-top: 0; }
  .sub {
    color: var(--muted);
    margin: 0 0 20px;
    font-size: 15px;
    animation: fadeInUp 0.6s 0.1s ease-out backwards;
  }
  .small { font-size: 13px; color: var(--muted); }

  /* ==================== ç»„ä»¶ ==================== */
  .card {
    padding: clamp(16px, 3vw, 24px);
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    transition: transform 0.3s ease-out, box-shadow 0.3s ease-out; /* å¢å¼ºäº¤äº’åŠ¨ç”» */
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-hover);
  }
  .grid > .card:nth-child(1) { animation: fadeInUp 0.6s 0.2s ease-out backwards; }
  .grid > .card:nth-child(2) { animation: fadeInUp 0.6s 0.3s ease-out backwards; }

  /* ä¸ºåŠ¨æ€å‡ºç°çš„æ¨¡å—æ·»åŠ å…¥åœºåŠ¨ç”» */
  #mapping, #range { animation: fadeInUp 0.5s ease-out; }
  
  .list {
    padding: 10px;
    max-height: 40svh;
    overflow: auto;
    background: #fff;
    border: 1px solid var(--accent-100);
    border-radius: 12px;
  }
  .drop {
    padding: 24px 14px;
    text-align: center;
    background: rgba(250, 248, 255, 0.8);
    border: 2px dashed var(--accent-300);
    border-radius: 14px;
    transition: background-color .2s ease, border-color .2s ease;
  }
  .drop.drag { background: #f1eaff; border-color: var(--accent-600); }

  .result {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 56px;
    padding: 12px 16px;
    text-align: center;
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    letter-spacing: .5px;
    background: linear-gradient(135deg, var(--accent-700), var(--accent-500));
    border-radius: 12px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    /* ä¸­å¥–ç»“æœåŠ¨ç”» */
    animation: resultGlow 2.5s infinite ease-in-out, pulseWinner 0.6s ease-out;
  }
  
  /* ==================== è¡¨å• ==================== */
  input, select, textarea, button { font-size: 16px; }
  input[type="number"], input[type="text"], select, textarea {
    width: 100%;
    padding: 12px 14px;
    background-color: #fdfcff;
    border: 1px solid var(--accent-100);
    border-radius: 10px;
    outline: 0;
    box-shadow: var(--shadow-inset);
    transition: border-color .2s ease, box-shadow .2s ease;
  }
  input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
    border-color: var(--accent-300);
    box-shadow: var(--shadow-inset), 0 0 0 4px rgba(124, 58, 237, .15);
  }
  textarea { line-height: 1.6; min-height: 60px; }
  input[type="checkbox"], input[type="radio"] { accent-color: var(--accent-600); }
  
  .btn {
    position: relative; /* ä¸ºæµå…‰æ•ˆæœå®šä½ */
    overflow: hidden;   /* éšè—è¶…å‡ºèŒƒå›´çš„æµå…‰ */
    padding: 12px 18px;
    color: #fff;
    font-weight: 700;
    letter-spacing: .4px;
    background-image: linear-gradient(145deg, var(--accent-500), var(--accent-600));
    border: 0;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(124, 58, 237, .2), 0 1px 3px rgba(124, 58, 237, .3);
    cursor: pointer;
    transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  }
  .btn:hover {
    transform: translateY(-2px);
    filter: saturate(1.1) brightness(1.05);
    box-shadow: 0 8px 18px rgba(124, 58, 237, .28), 0 2px 5px rgba(124, 58, 237, .3);
  }
  .btn:active { transform: translateY(0px); filter: brightness(0.95); }
  .btn:disabled { cursor: not-allowed; opacity: 0.6; filter: grayscale(50%); transform: none; }
  
  /* æµå…‰åŠ¨ç”»æ•ˆæœ */
  .btn::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
    transform: rotate(30deg) translateX(-150%);
    transition: transform 0.8s ease;
  }
  .btn:hover::after { transform: rotate(30deg) translateX(150%); }

  .btn.ghost {
    color: #3b2a69;
    font-weight: 600;
    background: rgba(243, 240, 255, 0.8);
    border: 1px solid var(--accent-100);
    box-shadow: none;
    transition: background-color .2s ease, border-color .2s ease, transform .15s ease;
  }
  .btn.ghost:hover { background-color: var(--accent-50); border-color: var(--accent-300); transform: translateY(-1px); }
  .btn.ok { background-image: linear-gradient(145deg, #34d399, #10b981); box-shadow: 0 4px 12px rgba(22,163,74,.25); }
  .btn.bad { background-image: linear-gradient(145deg, #f87171, #ef4444); box-shadow: 0 4px 12px rgba(239,68,68,.25); }
  @media (max-width: 720px) { .btn { width: 100%; } }

  /* ==================== è€è™æœºåŠ¨ç”» ==================== */
  .reelsWrap { display: flex; justify-content: center; }
  .reel {
    position: relative;
    width: var(--reel-w);
    height: calc(var(--cell-h) * 3);
    overflow: hidden;
    background: var(--reel-bg);
    border-radius: 14px;
    box-shadow: inset 0 0 12px rgba(0,0,0,.5), 0 15px 40px rgba(31,17,71,.3);
  }
  .strip { position: absolute; top: 0; left: 0; right: 0; will-change: transform; }
  .cell {
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    padding: 0 16px;
    overflow: hidden;
    color: #e0d9ff;
    font-size: 1.1em;
    font-weight: 700;
    white-space: nowrap;
    text-overflow: ellipsis;
    letter-spacing: .2px;
    text-shadow: 0 0 8px rgba(230, 220, 255, 0.3);
  }
  .cell.under-hidden { visibility: hidden; }
  .reel::before, .reel::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    height: calc(var(--cell-h) * 1.1);
    pointer-events: none;
    z-index: 2;
  }
  .reel::before { top: 0; background: var(--reel-grad-top); }
  .reel::after { bottom: 0; background: var(--reel-grad-btm); }
  
  .marker {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    height: var(--cell-h);
    pointer-events: none;
  }
  .marker::before {
    content: '';
    position: absolute;
    inset: 4px 8px;
    border-radius: 10px;
    background: linear-gradient(90deg, var(--accent-500), var(--accent-300));
    opacity: 0.2;
    filter: blur(8px);
  }
  .marker::after {
    content: '';
    position: absolute;
    inset: 2px 6px;
    border-radius: 12px;
    border: 2px solid rgba(255, 255, 255, 0.6);
  }

  .overlay {
    position: absolute;
    top: var(--cell-h);
    left: 0; right: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    height: var(--cell-h);
    color: #fff;
    font-size: clamp(20px, 3.4vw, 28px);
    font-weight: 800;
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s;
    text-shadow: 0 2px 6px rgba(0,0,0,0.5);
    z-index: 3;
  }
  .overlay.show { opacity: 1; }
  #history { max-height: 34svh; }

  /* ==================== æŒ‰å§“åèŒƒå›´åˆ—è¡¨ ==================== */
  :root {
    --name-maxh: clamp(380px, 64svh, 820px);
    --name-font: 18px;
    --name-line: 1.35;
    --name-item-pad-y: 6px;
    --name-item-gap: 10px;
    --name-check-size: 18px;
    --name-cols: 3; /* å®½å±æ¯è¡Œ 3 åˆ—å§“åï¼Œçª„å±å“åº”å¼ä¸‹è°ƒ */
  }
  #nameRange .row { gap: 8px; }
  #nameRange #nameSearch { height: 44px; padding: 12px 14px; font-size: var(--name-font); line-height: 1.2; }
  #nameRange .btn { font-size: 15px; padding: 10px 14px; border-radius: 10px; }

  #nameList {
    display: grid;
    grid-template-columns: repeat(var(--name-cols), minmax(0, 1fr));
    gap: 4px 8px;
    padding: 8px;
    max-height: var(--name-maxh);
    font-size: var(--name-font);
    line-height: var(--name-line);
    border-radius: 12px;
  }
  #nameList label {
    display: flex;
    align-items: center;
    gap: var(--name-item-gap);
    min-width: 0;
    padding: var(--name-item-pad-y) 10px;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
  }
  #nameList label:hover { background: var(--accent-50); }
  #nameList input[type="checkbox"] { flex: 0 0 auto; width: var(--name-check-size); height: var(--name-check-size); }
  #nameList .nm { min-width: 0; overflow: hidden; text-overflow: ellipsis; }
  #nameList input[type="checkbox"]:checked + .nm { color: var(--accent-700); font-weight: 600; }

  @media (max-width: 900px) { :root { --name-cols: 2; } }
  @media (max-width: 560px) { :root { --name-cols: 1; --name-font:17px; --name-check-size:17px; } }

  /* ==================== åŠŸèƒ½ç±» ==================== */
  ::selection { background: var(--accent-300); color:#fff; }
  ::-webkit-scrollbar { width: 10px; height: 10px; }
  ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, var(--accent-300), var(--accent-600)); border-radius: 8px; border: 2px solid var(--accent-50); }
  ::-webkit-scrollbar-track { background: var(--accent-50); border-radius: 8px; }
</style>
</head>
<body>
<div class="wrap">
  <h1>æœ¬åœ°åå•æŠ½å¥–ï¼ˆç»“æœä¸æ»šåŠ¨ä¸€è‡´ï¼‰</h1>
  <p class="sub">æ”¯æŒ TXT/CSV/XLS/XLSXï¼›è‡ªåŠ¨è¯†åˆ«ç¼–ç ï¼ˆUTF-8/UTF-16/GBK/GB18030/Big5/Shift_JISâ€¦ï¼‰ï¼›å¯ã€ŒæŒ‰å­¦å·åŒºé—´ã€æˆ–ã€ŒæŒ‰å§“åå‹¾é€‰ã€è®¾ç½®èŒƒå›´ï¼›åŒè½®ä¸é‡å¤ï¼›å¯è®¾éšæœºç§å­ç¡®ä¿å¤ç°ï¼›æ”¯æŒå¯¼å‡º CSVã€‚<br>å°è´´å£«ï¼šå¯¼å…¥å‰è¯·å°½é‡æ¸…æ´—ç©ºè¡Œä¸å¤šä½™ç©ºæ ¼ï¼Œä»¥æå‡è§£æå‡†ç¡®ç‡ã€‚</p>

  <div class="grid">
    <!-- ==================== å·¦ä¾§ï¼šå¯¼å…¥/æ˜ å°„/èŒƒå›´ ==================== -->
    <section class="card" aria-label="å¯¼å…¥ä¸èŒƒå›´è®¾ç½®">
      <h3>â‘  å¯¼å…¥åå•</h3>
      <div class="row">
        <!-- label å…³è”éšè—çš„æ–‡ä»¶é€‰æ‹© inputï¼Œä¾¿äºè‡ªå®šä¹‰æ ·å¼ -->
        <label class="btn ghost" for="file" title="ä»æœ¬åœ°é€‰æ‹© TXT/CSV/XLS/XLSX åå•æ–‡ä»¶ï¼ˆæ”¯æŒæ‹–æ‹½ï¼‰">é€‰æ‹©æ–‡ä»¶</label>
        <input id="file" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none" aria-label="é€‰æ‹©åå•æ–‡ä»¶">
        <button id="btnClear" class="btn ghost" title="æ¸…ç©ºå½“å‰å·²å¯¼å…¥çš„æ•°æ®ä¸å€™é€‰åˆ—è¡¨">æ¸…ç©º</button>
      </div>
      <div id="dz" class="drop" style="margin-top:10px" title="ä¹Ÿå¯ç›´æ¥å°†æ–‡ä»¶æ‹–æ‹½åˆ°æ­¤åŒºåŸŸ">
        æ‹–æ‹½ TXT/CSV/XLS/XLSX åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€
        <div class="small">TXT/CSV æ¯è¡Œå¯å†™ã€Œå§“å,å­¦å·ã€æˆ–å•åˆ—ï¼›Excel æ”¯æŒã€Œåºå·|å§“å|åºå·|å§“åã€ã€‚ç¼–ç å°†è‡ªåŠ¨è¯†åˆ«ã€‚</div>
        <div id="encInfo" class="small" aria-live="polite"></div>
      </div>

      <!-- åˆ—æ˜ å°„ï¼šå½“æ£€æµ‹åˆ°è¡¨å¤´æ—¶å‡ºç°ï¼Œä¾¿äºé€‰æ‹©ã€Œå§“ååˆ—/å­¦å·åˆ—ã€ -->
      <div id="mapping" style="margin-top:12px;display:none">
        <h3>â‘¡ åˆ—æ˜ å°„ï¼ˆæ£€æµ‹åˆ°è¡¨å¤´ï¼Œå¯è°ƒæ•´ï¼‰</h3>
        <div class="row">
          å§“ååˆ—ï¼š<select id="selName" title="è¯·é€‰æ‹©å§“åæ‰€åœ¨çš„åˆ—"></select>
          å­¦å·åˆ—ï¼š<select id="selId" title="è¯·é€‰æ‹©å­¦å·æ‰€åœ¨çš„åˆ—"></select>
          <button id="applyMap" class="btn ghost" title="åº”ç”¨æ˜ å°„åè¯·é‡æ–°å¯¼å…¥ä¸€æ¬¡æ–‡ä»¶ä»¥ä¾¿ç”Ÿæ•ˆ">åº”ç”¨æ˜ å°„</button>
        </div>
        <div id="sample" class="small" style="margin-top:6px"></div>
      </div>

      <!-- èŒƒå›´é€‰æ‹©ï¼šæŒ‰å­¦å·åŒºé—´ / æŒ‰å§“åå‹¾é€‰ï¼Œä¸¤ç§æ¨¡å¼äº’æ–¥ -->
      <div id="range" style="margin-top:12px;display:none">
        <h3>â‘¢ æŠ½å–èŒƒå›´</h3>
        <div class="row" role="radiogroup" aria-label="èŒƒå›´æ¨¡å¼">
          <label title="é€šè¿‡å­¦å·æœ€å°/æœ€å¤§å€¼é™å®šå€™é€‰"><input type="radio" name="mode" value="id" checked> æŒ‰å­¦å·</label>
          <label title="æ‰‹åŠ¨å‹¾é€‰è¦å‚ä¸æŠ½å–çš„å§“å"><input type="radio" name="mode" value="name"> æŒ‰å§“å</label>
        </div>

        <div id="idRange" style="margin-top:6px">
          <div class="row">
            å­¦å·åŒºé—´ï¼š
            <input id="idMin" type="number" placeholder="èµ·å§‹" title="å€™é€‰å­¦å·ä¸‹ç•Œï¼ˆåŒ…å«ï¼‰">
            <span style="align-self:center">â€”</span>
            <input id="idMax" type="number" placeholder="ç»“æŸ" title="å€™é€‰å­¦å·ä¸Šç•Œï¼ˆåŒ…å«ï¼‰">
            <button id="fillMM" class="btn ghost" title="è‡ªåŠ¨è¯»å–æ•°æ®ä¸­çš„æœ€å°/æœ€å¤§å­¦å·å¹¶å¡«å…¥">ç”¨æœ€å°/æœ€å¤§å¡«å……</button>
          </div>
          <div class="small">æç¤ºï¼šä»…åœ¨ã€Œå¯¼å…¥æ•°æ®ä¸­å­˜åœ¨çš„å­¦å·ã€é‡ŒæŠ½ï¼Œè¶…å‡ºåŒºé—´æˆ–ä¸å­˜åœ¨çš„å­¦å·ä¸ä¼šè¢«çº³å…¥ã€‚</div>
        </div>

        <div id="nameRange" style="display:none;margin-top:6px">
          <div class="row">
            <input id="nameSearch" type="text" placeholder="æœç´¢å§“åï¼ˆæ”¯æŒæ¨¡ç³ŠåŒ¹é…ï¼‰" style="flex:1" title="è¾“å…¥å…³é”®å­—å¯ä¸´æ—¶ç­›é€‰ä¸‹æ–¹å§“ååˆ—è¡¨">
            <button id="all" class="btn ghost" title="å…¨é€‰å½“å‰å¯è§çš„å§“å">å…¨é€‰</button>
            <button id="none" class="btn ghost" title="å–æ¶ˆé€‰æ‹©">å…¨ä¸é€‰</button>
          </div>
          <div id="nameList" class="list" style="margin-top:6px" aria-label="å§“åå¯é€‰åˆ—è¡¨"></div>
        </div>

        <div style="margin-top:8px">
          <div class="small">æ’é™¤åå•ï¼ˆå§“åæˆ–å­¦å·ï¼Œé€—å·/ç©ºæ ¼åˆ†éš”ï¼‰ï¼š</div>
          <textarea id="exclude" placeholder="ä¾‹ï¼šå¼ ä¸‰ 10021,10023 æå››" title="è¿™é‡Œåˆ—å‡ºçš„å§“å/å­¦å·å°†è¢«æ’é™¤ï¼Œä¸å‚ä¸æŠ½å–"></textarea>
        </div>
      </div>
    </section>

    <!-- ==================== å³ä¾§ï¼šè®¾ç½®/ç»“æœ/å†å² ==================== -->
    <section class="card" aria-label="æŠ½å–è®¾ç½®ä¸ç»“æœ">
      <h3>â‘£ æŠ½å–è®¾ç½®ä¸ç»“æœ</h3>
      <div class="row">
        è¿æŠ½æ¬¡æ•°ï¼š<input id="count" type="number" min="1" value="1" style="width:110px" title="ä¸€æ¬¡è¿è¡Œè¿ç»­æŠ½å–çš„æ¬¡æ•°">
        <label title="åŒä¸€è½®è¿è¡Œå†…ä¸é‡å¤åŒä¸€äºº"><input id="noRepeat" type="checkbox" checked> åŒè½®ä¸é‡å¤</label>
      </div>
      <div class="row" style="margin-top:6px">
        éšæœºç§å­ï¼ˆå¯é€‰ï¼Œä¿è¯å¯å¤ç°ï¼‰ï¼š
        <input id="seed" type="text" placeholder="ç•™ç©ºä½¿ç”¨ç³»ç»Ÿéšæœºï¼Œä¾‹å¦‚ï¼š2025-æ™šä¼š-B01" style="flex:1" title="åŒæ ·çš„ç§å­+åŒæ ·çš„æ•°æ®+åŒæ ·çš„è®¾ç½®ï¼Œä¼šå¾—åˆ°å®Œå…¨ä¸€è‡´çš„ç»“æœ">
      </div>
      <div class="row" style="margin-top:8px">
        <button id="start" class="btn ok" title="å¼€å§‹æŠ½å–ï¼ˆæ»šåŠ¨åŠ¨ç”»ä¸æœ€ç»ˆç»“æœä¿æŒä¸€è‡´ï¼‰">å¼€å§‹æŠ½å–</button>
        <button id="stop" class="btn bad" disabled title="åœæ­¢å½“å‰è½®æ¬¡çš„è¿ç»­æŠ½å–">åœæ­¢</button>
        <button id="export" class="btn" title="å¯¼å‡ºå½“å‰ä¼šè¯çš„ä¸­å¥–è®°å½•ï¼ˆCSV æ–‡ä»¶ï¼‰">å¯¼å‡ºä¸­å¥–è®°å½•</button>
      </div>

      <!-- è€è™æœºå¯è§†åŒ–åŒºï¼šstrip ä¸ºæ»šåŠ¨æ¡ï¼Œoverlay ä¸ºä¸­å¤®é«˜äº®æ–‡æœ¬å±‚ -->
      <div class="reelsWrap" style="margin-top:10px">
        <div class="reel" aria-label="æŠ½å–æ»šåŠ¨æ˜¾ç¤º">
          <div id="strip" class="strip"></div>
          <div class="marker" aria-hidden="true"></div>
          <div id="overlay" class="overlay" aria-hidden="true"></div>
        </div>
      </div>

      <div id="screen" class="result" style="margin-top:10px" aria-live="polite">ç­‰å¾…æŠ½å–â€¦ï¼ˆè¯·å…ˆå¯¼å…¥æ•°æ®å¹¶è®¾ç½®èŒƒå›´ï¼‰</div>
      <div class="row" style="margin-top:8px"><span class="small">å·²å¯¼å…¥ï¼š<b id="statTotal">0</b> | å½“å‰å€™é€‰ï¼š<b id="statCand">0</b></span></div>
      <h3 style="margin-top:12px">å†å²è®°å½•</h3>
      <div class="small" style="margin-bottom:6px">æœ€æ–°è®°å½•åœ¨æœ€ä¸Šæ–¹ï¼ŒåŒ…å«æ—¶é—´ä¸å½“æ¬¡æŠ½ä¸­çš„åå•ï¼ˆè‹¥ä¸ºè¿æŠ½åˆ™é€æ¡è®°å½•ï¼‰ã€‚</div>
      <div id="history" class="list small" aria-label="ä¸­å¥–å†å²åˆ—è¡¨"></div>
    </section>
  </div>

  <p class="small" style="margin-top:10px;color:#6b7280">
    åŠ¨ç”»ç”± <code>requestAnimationFrame</code> é©±åŠ¨ï¼Œä½ç§»ç”¨ <code>transform: translateY</code>ï¼Œæº¢å‡ºç”¨ <code>overflow:hidden</code> è£å‰ªï¼›
    æ–‡æœ¬æ–‡ä»¶é‡‡ç”¨æ™ºèƒ½ç¼–ç æ£€æµ‹è§£æï¼ˆä¼˜å…ˆè¯†åˆ« BOMï¼Œå…¶æ¬¡å€™é€‰è¯„åˆ†ï¼‰ã€‚
  </p>
</div>

<script>
/** *******************************************************************
 * å·¥å…·å‡½æ•°åŒºï¼šéšæœºæ•°ã€é€‰æ‹©å™¨ã€æ–‡æœ¬å¤„ç†
 * è¯´æ˜ï¼šä»…åšå¤ç”¨å·¥å…·ï¼Œæ— ä¸šåŠ¡å‰¯ä½œç”¨ã€‚
 *********************************************************************/
function mulberry32(seed){
  // ç®€æ´å¿«é€Ÿçš„ 32 ä½ PRNGï¼ˆå¯å¤ç°ï¼‰ï¼Œç”¨äºæŒ‡å®šç§å­æ—¶ä¿éšœç»“æœä¸€è‡´
  let t=seed>>>0;
  return()=>{
    t+=0x6D2B79F5;
    let r=Math.imul(t^(t>>>15),1|t);
    r^=r+Math.imul(r^(r>>>7),61|r);
    return((r^(r>>>14))>>>0)/4294967296;
  }
}
function hashSeed(s){
  // å°†ä»»æ„å­—ç¬¦ä¸²è½¬ä¸º 32 ä½æ•´æ•°ç§å­ï¼ˆFNV-1aï¼‰
  let h=2166136261>>>0; for(const ch of s){ h^=ch.charCodeAt(0); h=Math.imul(h,16777619) } return h>>>0;
}
let rng=Math.random; // é»˜è®¤ä½¿ç”¨ç³»ç»Ÿéšæœºï¼›è‹¥ç”¨æˆ·å¡«å†™äº† seedï¼Œåˆ™æ›¿æ¢ä¸º mulberry32(seed)

// è½»é‡é€‰æ‹©å™¨
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

// æ–‡æœ¬æ¸…æ´—ä¸ç‰¹å¾åˆ¤æ–­
function clean(v){ if(v==null) return ""; return String(v).replace(/\s+/g," ").trim() }
function isCJK(s){ return /[\u3400-\u9FFF]/.test(s) } // æ˜¯å¦åŒ…å«ä¸­æ—¥éŸ©ç»Ÿä¸€è¡¨æ„å­—ç¬¦
function looksId(s){ return /^\d+$/.test(s) }        // æ˜¯å¦å…¨ä¸ºæ•°å­—ï¼ˆå­¦å·ï¼‰
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])) }

/** *******************************************************************
 * æ™ºèƒ½ç¼–ç è¯†åˆ« decodeSmart(u8)
 * ç­–ç•¥ï¼š
 *   1) ä¼˜å…ˆåˆ¤æ–­ BOMï¼ˆUTF-8 / UTF-16LE / UTF-16BEï¼‰ï¼Œå‘½ä¸­åˆ™å‰¥ç¦» BOM åè§£ç ã€‚
 *   2) å¦åˆ™åœ¨å€™é€‰ç¼–ç é›†ä¸­é€ä¸ªå°è¯•ï¼ˆå…è®¸éè‡´å‘½é”™è¯¯ï¼‰ï¼ŒæŒ‰ä»¥ä¸‹æŒ‡æ ‡æ‰“åˆ†ï¼š
 *      - ä¹±ç æ›¿ä»£ç¬¦ \uFFFD æ•°é‡ï¼ˆè¶Šå°‘è¶Šå¥½ï¼Œæƒé‡æœ€é«˜ï¼‰
 *      - æ§åˆ¶å­—ç¬¦æ•°é‡ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰
 *      - CJK å­—ç¬¦æ•°é‡ï¼ˆè¶Šå¤šè¶Šå¯èƒ½æ­£ç¡®ï¼Œå› å¸¸è§ä¸­æ–‡åå•ï¼‰
 *      - å¯¹ UTF-8 ç•¥å¾®åŠ åˆ†ï¼Œå¯¹éƒ¨åˆ†è¥¿æ–‡å•å­—èŠ‚ç¼–ç ç•¥å¾®å‡åˆ†
 *   3) è‹¥ä»å¤±è´¥ï¼Œåˆ™å›é€€åˆ°è¿è¡Œæ—¶é»˜è®¤è§£ç ï¼ˆé€šå¸¸ä¸º UTF-8ï¼‰ã€‚
 *********************************************************************/
function decodeSmart(u8){
  const encInfoEl = document.getElementById('encInfo');
  const hasBOM = (u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF) ||
                 (u8.length>=2 && ((u8[0]===0xFF && u8[1]===0xFE) || (u8[0]===0xFE && u8[1]===0xFF)));
  try{
    // --- UTF-8 with BOM ---
    if(u8.length>=3 && u8[0]===0xEF && u8[1]===0xBB && u8[2]===0xBF){
      const txt = new TextDecoder('utf-8').decode(u8.subarray(3));
      encInfoEl.textContent = 'ç¼–ç ï¼šUTF-8 (BOM)';
      return txt;
    }
    // --- UTF-16 LE with BOM ---
    if(u8.length>=2 && u8[0]===0xFF && u8[1]===0xFE){
      const txt = new TextDecoder('utf-16le').decode(u8.subarray(2));
      encInfoEl.textContent = 'ç¼–ç ï¼šUTF-16LE (BOM)';
      return txt;
    }
    // --- UTF-16 BE with BOM ---
    if(u8.length>=2 && u8[0]===0xFE && u8[1]===0xFF){
      const txt = new TextDecoder('utf-16be').decode(u8.subarray(2));
      encInfoEl.textContent = 'ç¼–ç ï¼šUTF-16BE (BOM)';
      return txt;
    }
  }catch(e){ /* è‹¥æç«¯æƒ…å†µä¸‹ TextDecoder æŠ›é”™ï¼Œè¿›å…¥å€™é€‰è¯„åˆ†æµç¨‹ */ }

  // å€™é€‰ç¼–ç å°è¯•é›†ï¼ˆå¯æŒ‰éœ€æ‰©å……ï¼‰
  const labels = ['utf-8','gb18030','gbk','big5','shift_jis','euc-kr','windows-1252','iso-8859-1','koi8-r','macintosh','utf-16le','utf-16be'];
  let best = {score:-Infinity, text:null, label:null};
  for(const lb of labels){
    try{
      const dec = new TextDecoder(lb, {fatal:false, ignoreBOM:true});
      const txt = dec.decode(u8);
      const bad = (txt.match(/\uFFFD/g)||[]).length;          // ä¹±ç æ›¿ä»£ç¬¦æ•°é‡
      const ctl = (txt.match(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g)||[]).length; // æ§åˆ¶å­—ç¬¦
      const cjk = (txt.match(/[\u3400-\u9FFF\uF900-\uFAFF]/g)||[]).length;   // CJK æ–‡å­—
      let score = 1000 - bad*100 - ctl*2 + cjk;
      if(lb==='utf-8') score += 10; // å¸¸è§ä¸”ç¨³å®š
      if(/^windows|iso-8859|macintosh/i.test(lb)) score -= 5; // è½»å¾®é™æƒ
      if(score > best.score) best = {score, text:txt, label:lb};
    }catch(e){ /* æŸäº›ç¯å¢ƒå¯èƒ½ä¸æ”¯æŒç‰¹å®šæ ‡ç­¾ï¼Œå¿½ç•¥ */ }
  }
  if(best.text!=null){
    encInfoEl.textContent = `ç¼–ç ï¼ˆæ¨æµ‹ï¼‰ï¼š${best.label}${hasBOM?' + BOM':''}`;
    return best.text;
  }
  // å…œåº•ç­–ç•¥
  try{
    const txt = new TextDecoder().decode(u8);
    encInfoEl.textContent = 'ç¼–ç ï¼šæœªçŸ¥ï¼ˆä½¿ç”¨é»˜è®¤è§£ç ï¼‰';
    return txt;
  }catch(e){
    encInfoEl.textContent = 'ç¼–ç ï¼šè§£ç å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨ UTF-8 é‡æ–°ä¿å­˜åå†å¯¼å…¥ã€‚';
    throw e;
  }
}

/** *******************************************************************
 * æ–‡ä»¶è¯»å–ä¸é¢„å¤„ç†ï¼šTXT/CSV/Excel
 *********************************************************************/
const dz=$('#dz');
// æ‹–æ‹½é«˜äº®
dz.addEventListener('dragover',e=>{ e.preventDefault(); dz.classList.add('drag') });
dz.addEventListener('dragleave',()=> dz.classList.remove('drag'));
// æ‹–æ‹½æ–‡ä»¶
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('drag');
  if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0])
});
// æ–‡ä»¶é€‰æ‹©
$('#file').addEventListener('change',e=>{ if(e.target.files[0]) handleFile(e.target.files[0]) });
// æ¸…ç©ºæ•°æ®
$('#btnClear').addEventListener('click',()=>{
  entries=[]; candidates=[]; winnersAll=[]; updateStats();
  $('#mapping').style.display='none'; $('#range').style.display='none';
  $('#screen').textContent='ç­‰å¾…æŠ½å–â€¦ï¼ˆè¯·å…ˆå¯¼å…¥æ•°æ®å¹¶è®¾ç½®èŒƒå›´ï¼‰';
  $('#history').innerHTML=''; $('#encInfo').textContent='';
  buildStrip([]);
});

// æ ¹æ®æ‰©å±•åé€‰ç”¨è§£ææ–¹å¼
function handleFile(file){
  const n=file.name.toLowerCase();
  if(n.endsWith('.xlsx')||n.endsWith('.xls')){
    const fr=new FileReader(); fr.onload=()=>parseExcel(fr.result); fr.readAsArrayBuffer(file);
  }else{
    const fr=new FileReader();
    fr.onload=()=>{
      const u8 = new Uint8Array(fr.result);
      let text = '';
      try{ text = decodeSmart(u8); }
      catch(err){ alert('æ— æ³•è¯†åˆ«æ–‡æœ¬ç¼–ç ï¼š'+(err&&err.message||err)+'\nå»ºè®®ï¼šå°†æ–‡ä»¶å¦å­˜ä¸º UTF-8 åé‡è¯•ï¼Œæˆ–æ”¹ç”¨ Excel æ ¼å¼å¯¼å…¥ã€‚'); return; }
      parseText(text);
    };
    fr.readAsArrayBuffer(file);
  }
}

// è§£æ Excelï¼ˆå–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨ï¼‰
function parseExcel(buf){
  const wb=XLSX.read(new Uint8Array(buf),{type:'array'}), sh=wb.Sheets[wb.SheetNames[0]];
  const aoa=XLSX.utils.sheet_to_json(sh,{header:1,raw:false,defval:""});
  processAOA(aoa);
}

// è§£æçº¯æ–‡æœ¬ï¼ˆæ”¯æŒé€—å·/ä¸­æ–‡é€—å·/åˆ¶è¡¨ç¬¦/ç©ºç™½åˆ†éš”ï¼‰
function parseText(text){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const aoa=lines.map(line=>{
    let cells=line.split(/,|ï¼Œ/);
    if(cells.length===1) cells=line.split(/\t+/);
    if(cells.length===1) cells=line.split(/\s+/);
    return cells.map(clean);
  });
  processAOA(aoa);
}

/** *******************************************************************
 * AOA -> entriesï¼šå…¼å®¹ã€Œè¡¨å¤´ã€ä¸ã€Œä¸¤åˆ—æˆç»„ï¼ˆåºå·|å§“åï¼‰ã€
 * è¾“å‡º entries ç»“æ„ï¼š{ name, id, label }
 *********************************************************************/
let entries=[], candidates=[], winnersAll=[];   // å…¨é‡/å€™é€‰/å†å²
let autoRun=false, spinning=false;              // è¿è¡ŒçŠ¶æ€

function processAOA(aoa){
  const rows=aoa.filter(r=> (r||[]).some(c=>clean(c)!==""));
  if(!rows.length){ alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®ã€‚\nè¯·ç¡®è®¤ï¼šæ¯è¡Œè‡³å°‘åŒ…å«ä¸€ä¸ªå§“åæˆ–å­¦å·ï¼›åˆ†éš”ç¬¦å¯ä¸ºé€—å·/ç©ºæ ¼/åˆ¶è¡¨ç¬¦ã€‚'); return; }

  // æ™ºèƒ½è¯†åˆ«è¡¨å¤´ä½ç½®ä¸åˆ—ç´¢å¼•
  const keyName=/å§“å|name|å­¦ç”Ÿå§“å|åŒå­¦/i, keyId=/å­¦å·|å­¦ç±å·|ç¼–å·|åºå·|id|number|no/i;
  let header=-1, nameIdx=-1, idIdx=-1;
  for(let i=0;i<Math.min(10,rows.length);i++){
    const r=rows[i].map(clean);
    for(let c=0;c<r.length;c++){
      if(nameIdx===-1&&keyName.test(r[c])) nameIdx=c, header=i;
      if(idIdx===-1&&keyId.test(r[c]))    idIdx=c, header=i;
    }
    if(header===i && (nameIdx!==-1 || idIdx!==-1)) break;
  }

  // å°†ä¸åŒè¾“å…¥æ ¼å¼ç»Ÿä¸€ä¸º {name, id}
  let parsed=[];
  if(header!==-1){
    // è¡¨å¤´æ¨¡å¼ï¼šåç»­å„è¡Œæ ¹æ®åˆ—ç´¢å¼•æå–
    for(let i=header+1;i<rows.length;i++){
      const r=rows[i].map(clean);
      const name=nameIdx!==-1?clean(r[nameIdx]):"";
      const id=idIdx!==-1?clean(r[idIdx]):"";
      if(name||id) parsed.push({name,id});
    }
    showMapping(rows[header]);
  }else{
    // æ— è¡¨å¤´ï¼šæŒ‰ã€Œä¸¤åˆ—æˆç»„ã€æˆ–ã€Œå•åˆ—å§“å/å­¦å·ã€çŒœæµ‹
    for(const r0 of rows){
      const r=r0.map(clean);
      for(let c=0;c<r.length;c+=2){
        const a=r[c]??"", b=r[c+1]??""; if(!a&&!b) continue;
        if(/^\d+$/.test(a)&&isCJK(b)) parsed.push({id:String(a),name:b});
        else if(isCJK(a)&&/^\d+$/.test(b)) parsed.push({id:String(b),name:a});
        else if(isCJK(a)&&!b) parsed.push({id:"",name:a});
        else if(isCJK(b)&&!a) parsed.push({id:"",name:b});
      }
    }
    $('#mapping').style.display='none'; $('#range').style.display='';
  }

  // å»é‡ä¸ç»Ÿä¸€æ˜¾ç¤ºæ ‡ç­¾ labelï¼ˆä¼˜å…ˆæ˜¾ç¤ºâ€œå§“åï¼ˆå­¦å·ï¼‰â€ï¼‰
  const seen=new Set();
  entries=parsed.filter(x=>{
      const key=(x.name||"")+"|"+(x.id||"");
      if(!x.name&&!x.id) return false;
      if(seen.has(key)) return false;
      seen.add(key); return true;
    })
    .map(x=>({
      name:x.name,
      id:x.id,
      label:x.name&&x.id?`${x.name}ï¼ˆ${x.id}ï¼‰`:(x.name||x.id)
    }));

  buildNameList();
  fillIdMM();
  updateCandidates();
  updateStats();
  $('#screen').textContent='æ•°æ®å·²è½½å…¥ï¼Œè¯·è®¾ç½®èŒƒå›´åç‚¹å‡»â€œå¼€å§‹æŠ½å–â€ã€‚';
}

// æ˜¾ç¤ºæ˜ å°„ä¸‹æ‹‰ä¾›ç”¨æˆ·ç¡®è®¤ï¼ˆæç¤ºé‡æ–°å¯¼å…¥ä»¥ç”Ÿæ•ˆï¼‰
function showMapping(headerRow){
  const cols=headerRow.map((v,i)=>({i,label:clean(v)||(`åˆ—${i+1}`)}));
  const selN=$('#selName'), selI=$('#selId');
  selN.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
  selI.innerHTML=cols.map(c=>`<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
  $('#mapping').style.display=''; $('#range').style.display='';
  $('#applyMap').onclick=()=>{ alert('å·²åº”ç”¨æ˜ å°„ã€‚\nä¸ºç®€æ´èµ·è§ï¼Œè¯·æŒ‰æ–°æ˜ å°„é‡æ–°å¯¼å…¥ä¸€æ¬¡æ–‡ä»¶ä»¥å®Œå…¨ç”Ÿæ•ˆã€‚'); };
  $('#sample').textContent='å·²æ£€æµ‹åˆ°è¡¨å¤´ï¼š'+headerRow.map(clean).join(' | ');
}

/** *******************************************************************
 * èŒƒå›´é€‰æ‹©ä¸å€™é€‰é›†æ›´æ–°
 *********************************************************************/
function buildNameList(){
  const box=$('#nameList');
  const names=[...new Set(entries.map(e=>e.name).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'zh'));
  box.innerHTML=names.map(n=>{
    const safe = escapeHtml(n);
    return `<label title="å‹¾é€‰/å–æ¶ˆè¯¥å§“åå‚ä¸æŠ½å–"><input type="checkbox" class="cbN" value="${safe}" checked><span class="nm">${safe}</span></label>`;
  }).join('');
  // å³æ—¶æœç´¢ï¼šä»…å½±å“å¯è§æ€§ï¼Œä¸æ”¹å˜å‹¾é€‰çŠ¶æ€
  $('#nameSearch').oninput=()=>{
    const kw=$('#nameSearch').value.trim();
    $$('.cbN').forEach(cb=>{
      const lab=cb.closest('label');
      const show=!kw || cb.value.includes(kw);
      lab.style.display=show?'flex':'none';
    });
  };
  // å…¨é€‰/å…¨ä¸é€‰æŒ‰é’®
  $('#all').onclick=()=>{ $$('.cbN').forEach(cb=>cb.checked=true); updateCandidates(); };
  $('#none').onclick=()=>{ $$('.cbN').forEach(cb=>cb.checked=false); updateCandidates(); };
}

// è‡ªåŠ¨å¡«å…¥å­¦å·æœ€å°/æœ€å¤§å€¼
function fillIdMM(){
  const ids=entries.map(e=>e.id).filter(v=>/^\d+$/.test(v)).map(Number);
  if(ids.length){ $('#idMin').value=Math.min(...ids); $('#idMax').value=Math.max(...ids); }
}
$('#fillMM').onclick=fillIdMM;

// åˆ‡æ¢èŒƒå›´æ¨¡å¼ï¼šid/name
$$('input[name="mode"]').forEach(r=> r.addEventListener('change',()=>{
  const m=document.querySelector('input[name="mode"]:checked').value;
  $('#idRange').style.display=m==='id'?'':'none';
  $('#nameRange').style.display=m==='name'?'':'none';
  updateCandidates();
}));

// è¾“å…¥å˜åŒ–æ—¶é‡ç®—å€™é€‰
['idMin','idMax','exclude'].forEach(id=> document.getElementById(id).addEventListener('input', updateCandidates));
document.addEventListener('change', e=>{ if(e.target.classList && e.target.classList.contains('cbN')) updateCandidates(); });

// æ±‡æ€»å€™é€‰é›†
function updateCandidates(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  const excl=new Set( ($('#exclude').value.trim().split(/[\s,ï¼Œ;ï¼›]+/).filter(Boolean)) );
  let pool=[];
  if(mode==='id'){
    const min=+( $('#idMin').value || Number.NEGATIVE_INFINITY );
    const max=+( $('#idMax').value || Number.POSITIVE_INFINITY );
    pool=entries.filter(e=> /^\d+$/.test(e.id) && +e.id>=min && +e.id<=max );
  }else{
    const allowed=new Set([...document.querySelectorAll('.cbN:checked')].map(cb=>cb.value));
    pool=entries.filter(e=> e.name && allowed.has(e.name));
  }
  // æ’é™¤åå•ï¼ˆæ”¯æŒå§“å/å­¦å·ï¼‰
  pool=pool.filter(e=> !(excl.has(e.name)||excl.has(e.id)) );
  candidates=pool; updateStats(); buildStrip(candidates);
}
function updateStats(){ $('#statTotal').textContent=entries.length; $('#statCand').textContent=candidates.length; }

/** *******************************************************************
 * è€è™æœºåŠ¨ç”»ï¼šç¡®ä¿ã€Œå¯è§ä¸­å¤®é¡¹ === æŠ½ä¸­ç»“æœã€
 * æ€è·¯æ¦‚è¿°ï¼š
 *   1) æŠ½å–å‰å…ˆå¤åˆ¶ä¸€ä»½å½“å‰å€™é€‰å¿«ç…§ snapshotï¼ˆä¿è¯åŠ¨ç”»æœŸé—´ä¸ä¼šå—å¤–éƒ¨æ”¹å˜å½±å“ï¼‰ã€‚
 *   2) åœ¨å¿«ç…§ä¸ŠæŒ‘å‡ºç›®æ ‡ç´¢å¼• winnerIdxï¼Œå¹¶é¢„å…ˆæ„å»º strip å†…å®¹ï¼Œä½¿å…¶æ»šåŠ¨ç»“æŸæ—¶ä¸­å¤®é¡¹ä¸º winnerã€‚
 *   3) ä½¿ç”¨ easeOutCubic åšå‡é€ŸåŠ¨ç”»ï¼Œç»“æŸåå°†ä¸­å¤®ä¸‹æ–¹åŸå§‹ cell è®¾ä¸ºéšè—ï¼Œå åŠ  overlay æ–‡æœ¬ã€‚
 *********************************************************************/
const VISIBLE_ROWS=3, CENTER_INDEX=1, COPIES=3, MAX_N_DOM=400; // DOM æ•°é‡åšä¸Šé™ä»¥é˜²çˆ†å†…å­˜
const stripEl=document.getElementById('strip'), overlayEl=document.getElementById('overlay');

// åˆæ¬¡æˆ–å€™é€‰å˜åŒ–æ—¶æ„å»ºé™æ€ stripï¼ˆéæŠ½å–æ€ï¼‰
function buildStrip(list){
  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
  const baseCount=Math.max(list.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
  stripEl.dataset.ndom=String(Ndom);
  for(let k=0;k<COPIES;k++){
    for(let i=0;i<Ndom;i++){
      const d=document.createElement('div'); d.className='cell';
      const data=list.length?list[i%list.length]:{label:String(i+1)};
      d.textContent=data.label; stripEl.appendChild(d);
    }
  }
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}

// ä¸ºæŠ½å–è¿‡ç¨‹æŒ‰ã€Œå¿«ç…§ + ç›®æ ‡ç´¢å¼•ã€é‡æ’ stripï¼Œä½¿æ»šåŠ¨åä¸­å¤®å³ä¸ºè·é€‰é¡¹
function buildStripForSpin(snapshot, winnerIdx){
  overlayEl.classList.remove('show'); overlayEl.textContent=''; stripEl.innerHTML='';
  const baseCount=Math.max(snapshot.length,VISIBLE_ROWS), Ndom=Math.min(baseCount,MAX_N_DOM);
  stripEl.dataset.ndom=String(Ndom);
  // è®¡ç®—ä»å“ªä¸€é¡¹å¼€å§‹æ¸²æŸ“ï¼Œç¡®ä¿æ»šåŠ¨åä¸­å¤®æ˜¯ winnerIdx
  const start=(winnerIdx - (CENTER_INDEX + 1) + snapshot.length) % snapshot.length;
  for(let k=0;k<COPIES;k++){
    for(let i=0;i<Ndom;i++){
      const data = snapshot[(start + i) % snapshot.length];
      const d=document.createElement('div'); d.className='cell'; d.textContent=data.label; stripEl.appendChild(d);
    }
  }
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const base=-CENTER_INDEX*cellH; stripEl.style.transform=`translateY(${base}px)`;
}

// ç¼“åŠ¨å‡½æ•°ï¼ˆå‡é€Ÿï¼‰
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

// æ‰§è¡ŒåŠ¨ç”»åˆ°ä¸­å¤®ï¼ˆä¸æ”¹å˜æœ€ç»ˆ transformï¼Œé¿å…æµ®ç‚¹ç´¯ç§¯ï¼‰
function spinToCenter(){
  const cellH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h'))||56;
  const Ndom=parseInt(stripEl.dataset.ndom,10)||VISIBLE_ROWS;
  const base=-CENTER_INDEX*cellH;
  const spins=14, duration=1400, travel=spins*Ndom*cellH; // æ€»è·¯ç¨‹æŒ‰æ•´åœˆå€æ•°è®¡ç®—
  return new Promise(resolve=>{
    const t0=performance.now();
    function frame(now){
      const t=Math.max(0,Math.min(1,(now-t0)/duration));
      const yRaw=-travel*easeOutCubic(t);
      const yLoop=-(Math.abs(yRaw)%(Ndom*cellH));
      stripEl.style.transform=`translateY(${base + yLoop}px)`;
      if(t<1) requestAnimationFrame(frame); else { stripEl.style.transform=`translateY(${base}px)`; resolve(); }
    }
    requestAnimationFrame(frame);
  });
}

// ä»å¿«ç…§ä¸­æŒ‘é€‰ç›®æ ‡é¡¹ï¼ˆå¯é€‰åŒè½®ä¸é‡å¤ï¼‰
function pickFromSnapshot(snapshot, excludeSet){
  const idxPool=[];
  for(let i=0;i<snapshot.length;i++){
    const key=snapshot[i].name+'|'+snapshot[i].id;
    if(!excludeSet || !excludeSet.has(key)) idxPool.push(i);
  }
  if(!idxPool.length) return null;
  const chosenIndexInPool = Math.floor(rng()*idxPool.length);
  const idxSnap = idxPool[chosenIndexInPool];
  const item = snapshot[idxSnap];
  const idxGlobal = candidates.findIndex(e=> e===item || (e.name===item.name && e.id===item.id));
  return { item, idxSnap, idxGlobal };
}

// æ¸²æŸ“å†å²åŒºåŸŸï¼ˆæ–°è®°å½•ç½®é¡¶ï¼‰
function renderHistory(){
  $('#history').innerHTML=winnersAll.slice().reverse().map(rec=>{
    const line=rec.list.length?rec.list.map(x=>x.label).join('ã€'):'ï¼ˆæ— ï¼‰';
    return `<div style="padding:6px 0;border-bottom:1px dashed #e5e7eb"><div><b>${rec.time}</b></div><div>${line}</div></div>`;
  }).join('');
}

// æ§åˆ¶æŒ‰é’®å¿™é—²çŠ¶æ€
function setBusy(b){ spinning=b; $('#start').disabled=b; $('#stop').disabled=!b; }

// ç»‘å®šã€Œå¼€å§‹/åœæ­¢/å¯¼å‡ºã€æŒ‰é’®
$('#start').onclick = async ()=>{
  if(spinning||autoRun) return;
  if(!candidates.length){ alert('å€™é€‰é›†ä¸ºç©ºï¼šè¯·æ£€æŸ¥èŒƒå›´è®¾ç½®æˆ–æ’é™¤åå•ï¼Œç¡®è®¤åˆ—è¡¨ä¸­å­˜åœ¨å¯æŠ½å–çš„æ¡ç›®ã€‚'); return; }
  // æ ¹æ® seed é…ç½® RNGï¼ˆä¿è¯å¯å¤ç°ï¼‰
  rng = ($('#seed').value.trim()) ? mulberry32(hashSeed($('#seed').value.trim())) : Math.random;

  const N=Math.max(1, Math.floor(+$('#count').value||1));
  const used=new Set(); autoRun=true; setBusy(true);

  for(let i=0;i<N && autoRun;i++){
    // æ¯æ¬¡æŠ½å–ä½¿ç”¨å€™é€‰å¿«ç…§ï¼Œé¿å…åŠ¨ç”»æœŸé—´å¤–éƒ¨å˜åŒ–é€ æˆä¸ä¸€è‡´
    const snapshot=candidates.slice();
    const pick=pickFromSnapshot(snapshot, $('#noRepeat').checked ? used : null);
    if(!pick){ break; }

    // æŒ‰ç›®æ ‡é‡æ’ strip å¹¶æ’­æ”¾åŠ¨ç”»
    buildStripForSpin(snapshot, pick.idxSnap);
    await spinToCenter();

    // éšè—ä¸­å¤®ä¸‹ä¸€æ ¼ï¼Œå åŠ é«˜äº® overlayï¼›å±å¹•åŒºè¾“å‡ºå¯è¯»æ–‡æ¡ˆ
    const under = stripEl.children[CENTER_INDEX+1]; if(under) under.classList.add('under-hidden');
    requestAnimationFrame(()=>{ $('#overlay').textContent = pick.item.label; $('#overlay').classList.add('show'); });
    $('#screen').textContent='ğŸ‰ æ­å–œï¼š'+pick.item.label;

    // è®°å½•å†å²
    const when=new Date().toLocaleString(); winnersAll.push({time:when,list:[pick.item]}); renderHistory();

    // åŒè½®ä¸é‡å¤ï¼šè®°å½•å·²ç”¨é”®å€¼
    if($('#noRepeat').checked){ used.add(pick.item.name+'|'+pick.item.id); }

    // è¿æŠ½èŠ‚æµï¼ˆé¿å…åŠ¨ç”»å åŠ è¿‡ç´§ï¼‰
    await new Promise(r=>setTimeout(r, 300));
  }
  autoRun=false; setBusy(false);
};
$('#stop').onclick=()=>{ autoRun=false; };

// å¯¼å‡º CSVï¼ˆå«æ—¶é—´/åºå·/å§“å/å­¦å·/æ˜¾ç¤ºæ ‡ç­¾ï¼‰
$('#export').onclick=()=>{
  if(!winnersAll.length){ alert('æš‚æ— ä¸­å¥–è®°å½•å¯å¯¼å‡ºã€‚'); return; }
  const rows=[[ 'æ—¶é—´','åºå·','å§“å','å­¦å·','æ˜¾ç¤ºæ ‡ç­¾' ]];
  winnersAll.forEach(rec=> rec.list.forEach((p,i)=> rows.push([rec.time,i+1,p.name,p.id,p.label])) );
  const csv=rows.map(r=> r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
};

// é¦–æ¬¡è¿›å…¥ï¼šæ„å»ºç©º strip
buildStrip([]);
</script>
</body>
</html>
