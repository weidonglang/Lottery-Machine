<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>æœ¬åœ°åå•æŠ½å¥– Â· æ‰¹é‡å†å²å•è¡Œï½œæ”¾å¤§ä¿ç•™ï½œèŒƒå›´&è§†è§‰å¢å¼ºï½œæŒä¹…åŒ–</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* -------------------- å…¨å±€ä¸»é¢˜ -------------------- */
    :root {
      --bg: linear-gradient(135deg, #f8fafc 0%, #e9e3ff 100%);
      --panel: rgba(255, 255, 255, .9);
      --panel-border: rgba(160, 140, 255, .35);
      --text: #1f2937;
      --muted: #6b7280;
      --accent-50: #f5f3ff;
      --accent-100: #ede9fe;
      --accent-300: #c4b5fd;
      --accent-500: #8b5cf6;
      --accent-600: #7c3aed;
      --accent-700: #6d28d9;
      --ok: #10b981;
      --bad: #ef4444;
      --radius: 16px;
      --gap: 16px;
      --shadow: 0 10px 30px rgba(109, 40, 217, .12);
      --cell-h: 56px;
      --reel-w: min(560px, 94vw);
      --reel-bg: #120e29;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      min-height: 100svh;
      background: var(--bg);
      color: var(--text);
      font: 16px/1.7 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: clamp(16px, 3vw, 32px)
    }

    .grid {
      display: grid;
      gap: var(--gap);
      grid-template-columns: 1fr
    }

    @media(min-width:1000px) {
      .grid {
        grid-template-columns: 1.05fr .95fr
      }
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center
    }

    h1 {
      margin: 0 0 8px;
      font-size: clamp(22px, 3.8vw, 34px);
      color: #332768;
      font-weight: 800
    }

    h3 {
      margin: 20px 0 16px;
      padding-bottom: 8px;
      color: #4a3b7d;
      border-bottom: 1px solid var(--accent-100)
    }

    .card {
      padding: clamp(16px, 3vw, 24px);
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px)
    }

    .help {
      color: var(--muted);
      font-size: 14px
    }

    /* -------------------- æ§ä»¶ -------------------- */
    .list {
      padding: 10px;
      max-height: 40svh;
      overflow: auto;
      background: #fff;
      border: 1px solid var(--accent-100);
      border-radius: 12px
    }

    input,
    select,
    textarea,
    button {
      font-size: 16px
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--accent-100);
      border-radius: 10px;
      background: #fdfcff
    }

    input[type="number"].w100 {
      width: 110px
    }

    textarea {
      min-height: 60px
    }

    input[type="checkbox"],
    input[type="radio"] {
      accent-color: var(--accent-600)
    }

    .btn {
      padding: 10px 16px;
      color: #fff;
      font-weight: 700;
      letter-spacing: .3px;
      border: 0;
      border-radius: 12px;
      background-image: linear-gradient(145deg, var(--accent-500), var(--accent-600));
      box-shadow: 0 4px 12px rgba(124, 58, 237, .22);
      cursor: pointer
    }

    .btn.ghost {
      color: #3b2a69;
      background: rgba(243, 240, 255, .92);
      border: 1px solid var(--accent-100);
      box-shadow: none
    }

    .btn.ok {
      background-image: linear-gradient(145deg, #34d399, #10b981)
    }

    .btn.bad {
      background-image: linear-gradient(145deg, #f87171, #ef4444)
    }

    @media(max-width:760px) {
      .btn {
        width: 100%
      }
    }

    /* -------------------- è€è™æœºåŒºåŸŸï¼šè§†è§‰å¢å¼º -------------------- */
    .reelsWrap {
      display: flex;
      justify-content: center
    }

    .reel {
      position: relative;
      width: var(--reel-w);
      height: calc(var(--cell-h)*3);
      overflow: hidden;
      background: var(--reel-bg);
      border-radius: 16px;
      box-shadow: inset 0 0 16px rgba(0, 0, 0, .55), 0 18px 50px rgba(31, 17, 71, .35)
    }

    /* èƒŒæ™¯åŠ¨æ•ˆå±‚ï¼šæŸ”å’Œå…‰å¸¦ä¸æ˜Ÿå±‘ */
    .reel::before {
      content: "";
      position: absolute;
      inset: -30%;
      background: conic-gradient(from 0deg at 50% 50%, rgba(139, 92, 246, .12), rgba(236, 72, 153, .08), rgba(59, 130, 246, .12), rgba(139, 92, 246, .12));
      filter: blur(30px);
      animation: spin 11s linear infinite;
      opacity: .8;
      pointer-events: none
    }

    .reel::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(2px 2px at 20% 30%, rgba(255, 255, 255, .6), transparent), radial-gradient(2px 2px at 70% 60%, rgba(255, 255, 255, .5), transparent), radial-gradient(2px 2px at 35% 80%, rgba(255, 255, 255, .4), transparent);
      opacity: .5;
      animation: twinkle 3.2s ease-in-out infinite;
      pointer-events: none
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    @keyframes twinkle {
      0%,
      100% {
        opacity: .35
      }
      50% {
        opacity: .7
      }
    }

    .strip {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      will-change: transform
    }

    .strip.spinning {
      filter: blur(0.8px) saturate(1.05) brightness(1.05)
    }

    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      height: var(--cell-h);
      padding: 0 16px;
      color: #efe9ff;
      font-weight: 900;
      white-space: nowrap;
      text-overflow: ellipsis
    }

    .cell.hiddenCenter {
      visibility: hidden
    }

    .marker {
      position: absolute;
      top: var(--cell-h);
      left: 0;
      right: 0;
      height: var(--cell-h);
      pointer-events: none
    }

    .marker::after {
      content: '';
      position: absolute;
      inset: 4px 8px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, .65);
      box-shadow: 0 0 20px rgba(139, 92, 246, .28)
    }

    /* æµ®å‡ºçš„æ”¾å¤§ç»“æœï¼ˆ1.5x + è½»å¼¹ï¼‰ */
    .overlay {
      position: absolute;
      top: var(--cell-h);
      left: 0;
      right: 0;
      height: var(--cell-h);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      opacity: 0;
      transform: scale(1);
      transition: opacity .18s ease, transform .18s ease;
      z-index: 5;
      text-shadow: 0 2px 10px rgba(0, 0, 0, .6);
      pointer-events: none
    }

    .overlay.show {
      opacity: 1;
      transform: scale(1.5);
      animation: pop .22s ease-out
    }

    @keyframes pop {
      0% {
        transform: scale(0.9)
      }
      70% {
        transform: scale(1.54)
      }
      100% {
        transform: scale(1.5)
      }
    }

    .result {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 56px;
      margin-top: 10px;
      padding: 12px 16px;
      color: #fff;
      font-size: clamp(20px, 3.4vw, 28px);
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-700), var(--accent-500));
      border-radius: 12px
    }

    /* -------------------- æŠ½å–èŒƒå›´ï¼ˆâ‘¢ï¼‰è§†è§‰å¢å¼º -------------------- */
    #range {
      font-size: 17px
    }

    #range .tag {
      font-size: 15px;
      background: #eef2ff;
      color: #4338ca;
      border: 1px solid #e0e7ff;
      border-radius: 999px;
      padding: 6px 10px
    }

    #range input[type="radio"] {
      transform: scale(1.15)
    }

    #idRange .row input {
      font-size: 17px
    }

    #nameList {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 12px;
      padding: 10px;
      max-height: clamp(380px, 64svh, 820px);
      border-radius: 12px
    }

    @media(max-width:900px) {
      #nameList {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }

    @media(max-width:560px) {
      #nameList {
        grid-template-columns: repeat(1, minmax(0, 1fr))
      }
    }

    #nameList label {
      font-size: 16.5px;
      padding: 10px 12px;
      background: #fafaff;
      border: 1px solid #ecebff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(99, 102, 241, .08)
    }

    #nameList .nm {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis
    }

    #nameRange .row input[type="text"] {
      font-size: 16.5px
    }

    /* -------------------- å†å²è®°å½•ï¼ˆæ‰¹é‡å•è¡Œæ˜¾ç¤ºï¼‰ -------------------- */
    #history {
      background: #fff;
      border: 1px solid var(--accent-100);
      border-radius: 12px;
      padding: 10px;
      max-height: 40svh;
      overflow: auto
    }

    .history-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
      border: 1px solid #eef2ff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(17, 24, 39, .04)
    }

    .history-head {
      display: flex;
      align-items: center;
      justify-content: space-between
    }

    .history-time {
      font-size: 15px;
      color: #475569;
      font-weight: 800
    }

    .history-count {
      font-size: 12px;
      color: #4338ca;
      background: #eef2ff;
      border: 1px solid #e0e7ff;
      padding: 4px 8px;
      border-radius: 999px
    }

    .history-row {
      display: flex;
      align-items: center;
      gap: 10px;
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 2px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 7px 12px;
      border-radius: 999px;
      background: #ede9fe;
      color: #3b2a69;
      font-weight: 800;
      font-size: 15px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .06)
    }

    .history-list {
      display: grid;
      gap: 10px
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>æœ¬åœ°åå•æŠ½å¥–ï¼ˆæ‰¹é‡å†å²å•è¡Œï½œæ”¾å¤§ä¿ç•™ï½œèŒƒå›´&è§†è§‰å¢å¼ºï¼‰</h1>
    <p class="help">æ”¯æŒ TXT/CSV/XLS/XLSXï¼›è‡ªåŠ¨è¯†åˆ«ç¼–ç ï¼›æŒ‰å­¦å·/å§“åèŒƒå›´ï¼ˆæ™ºèƒ½é»˜è®¤ï¼‰ï¼›åŒè½®ä¸é‡å¤ï¼›éšæœºç§å­ï¼›å†å²å¯¼å‡ºï¼›åå•æŒä¹…åŒ–ï¼›ä¸­å¥–åè‡ªåŠ¨å–æ¶ˆå‹¾é€‰ã€‚</p>

    <div class="grid">
      <section class="card">
        <h3>â‘  å¯¼å…¥åå•</h3>
        <div class="row">
          <label class="btn ghost" for="file">é€‰æ‹©æ–‡ä»¶</label>
          <input id="file" type="file" accept=".txt,.csv,.xlsx,.xls" style="display:none">
          <button id="btnClear" class="btn ghost">æ¸…ç©º</button>
        </div>
        <div id="dz" class="drop list" style="margin-top:10px;border-style:dashed;text-align:center">
          å°† TXT/CSV/XLS/XLSX æ‹–å…¥æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»â€œé€‰æ‹©æ–‡ä»¶â€
          <div id="encInfo" class="help" style="margin-top:6px"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <input id="listName" type="text" placeholder="é»˜è®¤åå•" />
          <button id="btnSaveList" class="btn">ä¿å­˜åå•</button>
          <button id="btnManageList" class="btn ghost">ç®¡ç†æœ¬åœ°åå•</button>
          <button id="btnExportSaved" class="btn ghost" title="å¯¼å‡º JSON å¤‡ä»½">å¯¼å‡ºå¤‡ä»½</button>
          <label class="btn ghost" title="å¯¼å…¥ JSON å¤‡ä»½">å¯¼å…¥å¤‡ä»½<input id="importSavedFile" type="file" accept=".json,application/json" style="display:none"></label>
        </div>
        <div id="savedPanel" class="list help" style="display:none;margin-top:8px">
          <div class="help">å·²ä¿å­˜çš„åå•ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰ï¼š</div>
          <div id="savedListBox"></div>
          <div id="storageWarn" class="help" style="color:#dc2626;display:none;margin-top:6px">âš ï¸ å½“å‰ç¯å¢ƒçš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜åå•ã€‚</div>
        </div>

        <div id="mapping" style="margin-top:12px;display:none">
          <h3>â‘¡ åˆ—æ˜ å°„ï¼ˆæ£€æµ‹åˆ°è¡¨å¤´å¯è°ƒæ•´ï¼‰</h3>
          <div class="row">å§“ååˆ—ï¼š<select id="selName"></select> å­¦å·åˆ—ï¼š<select id="selId"></select> <button id="applyMap" class="btn ghost">åº”ç”¨æ˜ å°„ï¼ˆè¯·é‡æ–°å¯¼å…¥ï¼‰</button></div>
          <div id="sample" class="help" style="margin-top:6px"></div>
        </div>

        <div id="range" style="margin-top:12px;display:none">
          <h3>â‘¢ æŠ½å–èŒƒå›´</h3>
          <div class="row" role="radiogroup">
            <label class="tag"><input type="radio" name="mode" value="id" checked> æŒ‰å­¦å·</label>
            <label class="tag"><input type="radio" name="mode" value="name"> æŒ‰å§“å</label>
            <span id="autoModeHint" class="help"></span>
          </div>

          <div id="idRange" style="margin-top:6px">
            <div class="row">å­¦å·åŒºé—´ï¼š<input id="idMin" class="w100" type="number" placeholder="èµ·å§‹"><span style="align-self:center">â€”</span><input id="idMax" class="w100" type="number" placeholder="ç»“æŸ"> <button id="fillMM" class="btn ghost">ç”¨æœ€å°/æœ€å¤§å¡«å……</button></div>
            <div class="help">ä»…åœ¨å¯¼å…¥æ•°æ®ä¸­çš„å­¦å·èŒƒå›´å†…æŠ½å–ã€‚</div>
          </div>

          <div id="nameRange" style="display:none;margin-top:6px">
            <div class="row"><input id="nameSearch" type="text" placeholder="æœç´¢å§“åï¼ˆæ¨¡ç³Šï¼‰" style="flex:1"> <button id="all" class="btn ghost">å…¨é€‰</button> <button id="none" class="btn ghost">å…¨ä¸é€‰</button></div>
            <div id="nameList" class="list" style="margin-top:6px"></div>
          </div>

          <div style="margin-top:8px">
            <div class="help">æ’é™¤åå•ï¼ˆå§“åæˆ–å­¦å·ï¼Œé€—å·/ç©ºæ ¼åˆ†éš”ï¼‰ï¼š</div>
            <textarea id="exclude" placeholder="ä¾‹ï¼šå¼ ä¸‰ 10021,10023 æå››"></textarea>
          </div>
        </div>
      </section>

      <section class="card">
        <h3>â‘£ æŠ½å–è®¾ç½®ä¸ç»“æœ</h3>
        <div class="row">
          è¿æŠ½æ¬¡æ•°ï¼š<input id="count" class="w100" type="number" min="1" value="1">
          <label class="tag"><input id="noRepeat" type="checkbox" checked> åŒè½®ä¸é‡å¤</label>
          <label class="tag"><input id="autoUncheck" type="checkbox"> ä¸­å¥–åå–æ¶ˆå‹¾é€‰</label>
        </div>
        <div class="row" style="margin-top:6px">
          æ»šåŠ¨æ—¶é•¿(ms)ï¼š<input id="spinMs" class="w100" type="number" min="500" value="1400">
          å±•ç¤ºæ—¶é•¿(ms)ï¼š<input id="holdMs" class="w100" type="number" min="200" value="900">
          è¿æŠ½é—´éš”(ms)ï¼š<input id="gapMs" class="w100" type="number" min="0" value="350">
        </div>
        <div class="row" style="margin-top:6px">éšæœºç§å­ï¼ˆå¯é€‰ï¼‰ï¼š<input id="seed" type="text" placeholder="ç•™ç©ºä½¿ç”¨ç³»ç»Ÿéšæœºï¼Œä¾‹å¦‚ï¼š2025-æ™šä¼š-B01" style="flex:1"></div>

        <div class="row" style="margin-top:8px"><button id="start" class="btn ok">å¼€å§‹æŠ½å–</button> <button id="stop" class="btn bad" disabled>åœæ­¢</button> <button id="export" class="btn">å¯¼å‡ºä¸­å¥–è®°å½•</button></div>

        <div class="reelsWrap" style="margin-top:10px">
          <div class="reel">
            <div id="strip" class="strip"></div>
            <div class="marker" aria-hidden="true"></div>
            <div id="overlay" class="overlay" aria-hidden="true"></div>
          </div>
        </div>

        <div id="screen" class="result" aria-live="polite">ç­‰å¾…æŠ½å–â€¦ï¼ˆè¯·å…ˆå¯¼å…¥æ•°æ®å¹¶è®¾ç½®èŒƒå›´ï¼‰</div>
        <div class="row" style="margin-top:8px"><span class="help">å·²å¯¼å…¥ï¼š<b id="statTotal">0</b> | å½“å‰å€™é€‰ï¼š<b id="statCand">0</b> <span id="progress" class="help"></span></span></div>

        <h3 style="margin-top:12px">å†å²è®°å½•</h3>
        <div id="history" class="history-list"></div>
      </section>
    </div>
  </div>

  <script>
    /* =====================================================
     * æœ¬åœ°åå•æŠ½å¥–ï¼ˆæ‰¹é‡å†å²å•è¡Œï½œæ”¾å¤§ä¿ç•™ï½œèŒƒå›´&è§†è§‰å¢å¼ºï½œæŒä¹…åŒ–ï¼‰
     * é‡ç‚¹ï¼š
     * - å†å²æŒ‰â€œæ‰¹æ¬¡â€è®°å½•ï¼Œè¿æŠ½ N æ¬¡åˆå¹¶åˆ°åŒä¸€è¡Œæ˜¾ç¤ºï¼ˆæ°´å¹³èŠ¯ç‰‡ï¼Œæ”¯æŒæ¨ªå‘æ»šåŠ¨ï¼‰ã€‚
     * - ä¿æŒ UI é”å®šæœŸ + å»¶è¿Ÿé‡å»ºå€™é€‰é›† + 1.5x æ”¾å¤§æµ®ç°ã€‚
     * ===================================================== */

    /* -------------------- åŸºç¡€å·¥å…· -------------------- */
    const $ = s => document.querySelector(s),
      $$ = s => document.querySelectorAll(s);
    const clean = v => v == null ? "" : String(v).replace(/\s+/g, " ").trim();
    const isCJK = s => /[\u3400-\u9FFF]/.test(s);
    const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      '\'': '&#39;'
    } [m]));

    function storageAvailable() {
      try {
        const x = '__ls_probe__';
        localStorage.setItem(x, '1');
        localStorage.removeItem(x);
        return true;
      } catch (e) {
        return false;
      }
    }

    function mulberry32(seed) {
      let t = seed >>> 0;
      return () => {
        t += 0x6D2B79F5;
        let r = Math.imul(t ^ (t >>> 15), 1 | t);
        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
      };
    }

    function hashSeed(s) {
      let h = 2166136261 >>> 0;
      for (const ch of s) {
        h ^= ch.charCodeAt(0);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    /* -------------------- æ™ºèƒ½ç¼–ç è¯†åˆ«ï¼ˆTXT/CSVï¼‰ -------------------- */
    function decodeSmart(u8) {
      const encInfoEl = document.getElementById('encInfo');
      const hasBOM = (u8.length >= 3 && u8[0] === 0xEF && u8[1] === 0xBB && u8[2] === 0xBF) || (u8.length >= 2 && ((u8[0] === 0xFF && u8[1] === 0xFE) || (u8[0] === 0xFE && u8[1] === 0xFF)));
      try {
        if (u8.length >= 3 && u8[0] === 0xEF && u8[1] === 0xBB && u8[2] === 0xBF) {
          const txt = new TextDecoder('utf-8').decode(u8.subarray(3));
          encInfoEl.textContent = 'ç¼–ç ï¼šUTF-8 (BOM)';
          return txt;
        }
      } catch (e) {}
      try {
        if (u8.length >= 2 && u8[0] === 0xFF && u8[1] === 0xFE) {
          const txt = new TextDecoder('utf-16le').decode(u8.subarray(2));
          encInfoEl.textContent = 'ç¼–ç ï¼šUTF-16LE (BOM)';
          return txt;
        }
      } catch (e) {}
      try {
        if (u8.length >= 2 && u8[0] === 0xFE && u8[1] === 0xFF) {
          const txt = new TextDecoder('utf-16be').decode(u8.subarray(2));
          encInfoEl.textContent = 'ç¼–ç ï¼šUTF-16BE (BOM)';
          return txt;
        }
      } catch (e) {}
      const labels = ['utf-8', 'gb18030', 'gbk', 'big5', 'shift_jis', 'euc-kr', 'windows-1252', 'iso-8859-1'];
      let best = {
        score: -1,
        text: null,
        label: null
      };
      for (const lb of labels) {
        try {
          const dec = new TextDecoder(lb, {
            fatal: false,
            ignoreBOM: true
          });
          const txt = dec.decode(u8);
          const bad = (txt.match(/\uFFFD/g) || []).length;
          const ctl = (txt.match(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g) || []).length;
          const cjk = (txt.match(/[\u3400-\u9FFF\uF900-\uFAFF]/g) || []).length;
          let score = 1000 - bad * 100 - ctl * 2 + cjk;
          if (lb === 'utf-8') score += 10;
          if (score > best.score) best = {
            score,
            text: txt,
            label: lb
          };
        } catch (e) {}
      }
      if (best.text != null) {
        encInfoEl.textContent = `ç¼–ç ï¼ˆæ¨æµ‹ï¼‰ï¼š${best.label}${hasBOM?' + BOM':''}`;
        return best.text;
      }
      try {
        const txt = new TextDecoder().decode(u8);
        encInfoEl.textContent = 'ç¼–ç ï¼šé»˜è®¤è§£ç ';
        return txt;
      } catch (e) {
        encInfoEl.textContent = 'ç¼–ç ï¼šè§£ç å¤±è´¥';
        throw e;
      }
    }

    /* -------------------- æ–‡ä»¶å¯¼å…¥ -------------------- */
    const dz = $('#dz');
    ['dragover', 'dragenter'].forEach(t => dz.addEventListener(t, e => {
      e.preventDefault();
      dz.classList.add('drag')
    }));;
    ['dragleave', 'drop'].forEach(t => dz.addEventListener(t, e => {
      if (t === 'drop') e.preventDefault();
      dz.classList.remove('drag');
    }));
    dz.addEventListener('drop', e => {
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleFile(f);
    });
    $('#file').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (f) handleFile(f);
    });
    $('#btnClear').addEventListener('click', () => {
      entries = [];
      candidates = [];
      winnersAll = [];
      updateStats();
      $('#mapping').style.display = 'none';
      $('#range').style.display = 'none';
      $('#history').innerHTML = '';
      $('#encInfo').textContent = '';
      $('#screen').textContent = 'ç­‰å¾…æŠ½å–â€¦ï¼ˆè¯·å…ˆå¯¼å…¥æ•°æ®å¹¶è®¾ç½®èŒƒå›´ï¼‰';
      buildStrip([]);
    });

    function handleFile(file) {
      const name = file.name.toLowerCase();
      if (name.endsWith('.xlsx') || name.endsWith('.xls')) {
        const fr = new FileReader();
        fr.onload = () => parseExcel(fr.result);
        fr.readAsArrayBuffer(file);
      } else {
        const fr = new FileReader();
        fr.onload = () => {
          const u8 = new Uint8Array(fr.result);
          let text = '';
          try {
            text = decodeSmart(u8);
          } catch (err) {
            alert('æ— æ³•è¯†åˆ«æ–‡æœ¬ç¼–ç ï¼š' + (err && err.message || err));
            return;
          }
          parseText(text);
        };
        fr.readAsArrayBuffer(file);
      }
    }

    function parseExcel(buf) {
      const wb = XLSX.read(new Uint8Array(buf), {
        type: 'array'
      }),
        sh = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(sh, {
        header: 1,
        raw: false,
        defval: ""
      });
      processAOA(aoa);
    }

    function parseText(text) {
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const aoa = lines.map(line => {
        let cells = line.split(/,|ï¼Œ/);
        if (cells.length === 1) cells = line.split(/\t+/);
        if (cells.length === 1) cells = line.split(/\s+/);
        return cells.map(clean);
      });
      processAOA(aoa);
    }

    /* -------------------- æ•°æ®ä¸è§£æ -------------------- */
    let entries = [],
      candidates = [],
      winnersAll = []; // winnersAll: [{time, list:[item,...]}]
    let autoRun = false,
      spinning = false;
    let autoUncheckEnabled = false; // â€œä¸­å¥–åå–æ¶ˆå‹¾é€‰â€
    let userModeTouched = false; // ç”¨æˆ·æ˜¯å¦æ‰‹åŠ¨æ”¹è¿‡â€œæŒ‰å­¦å·/æŒ‰å§“åâ€

    // â˜… UI é”å®šä¸å»¶è¿Ÿé‡å»º
    let uiLocked = false; // æŠ½å–è¿›è¡Œä¸­ï¼šç¦æ­¢å€™é€‰é›†é‡å»º
    let pendingRecalc = false; // é”å®šæœŸå†…å¦‚æœ‰æ”¹åŠ¨ï¼Œè®°å½•å¹¶åœ¨æœŸæœ«ç»Ÿä¸€é‡å»º

    function processAOA(aoa) {
      const rows = (aoa || []).filter(r => (r || []).some(c => clean(c) !== ""));
      if (!rows.length) {
        alert('æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®ã€‚');
        return;
      }
      // è¡¨å¤´æ˜ å°„æ¢æµ‹
      const keyName = /å§“å|name|å­¦ç”Ÿå§“å|åŒå­¦/i,
        keyId = /å­¦å·|å­¦ç±å·|ç¼–å·|åºå·|id|number|no/i;
      let header = -1,
        nameIdx = -1,
        idIdx = -1;
      for (let i = 0; i < Math.min(10, rows.length); i++) {
        const r = rows[i].map(clean);
        for (let c = 0; c < r.length; c++) {
          if (nameIdx === -1 && keyName.test(r[c])) nameIdx = c, header = i;
          if (idIdx === -1 && keyId.test(r[c])) idIdx = c, header = i;
        }
        if (header === i && (nameIdx !== -1 || idIdx !== -1)) break;
      }
      // è§£æ
      let parsed = [];
      if (header !== -1) {
        for (let i = header + 1; i < rows.length; i++) {
          const r = rows[i].map(clean);
          const name = nameIdx !== -1 ? clean(r[nameIdx]) : "";
          const id = idIdx !== -1 ? clean(r[idIdx]) : "";
          if (name || id) parsed.push({
            name,
            id
          });
        }
        showMapping(rows[header]);
      } else {
        // æ— è¡¨å¤´ï¼šå°è¯•(åºå·,å§“å)/(å§“å,åºå·)/å•åˆ—å§“å
        for (const r0 of rows) {
          const r = r0.map(clean);
          for (let c = 0; c < r.length; c += 2) {
            const a = r[c] ?? "",
              b = r[c + 1] ?? "";
            if (!a && !b) continue;
            if (/^\d+$/.test(a) && isCJK(b)) parsed.push({
              id: String(a),
              name: b
            });
            else if (isCJK(a) && /^\d+$/.test(b)) parsed.push({
              id: String(b),
              name: a
            });
            else if (isCJK(a) && !b) parsed.push({
              id: "",
              name: a
            });
            else if (isCJK(b) && !a) parsed.push({
              id: "",
              name: b
            });
          }
        }
        $('#mapping').style.display = 'none';
        $('#range').style.display = '';
      }
      // å»é‡ & ç»„è£…æ˜¾ç¤ºæ ‡ç­¾
      const seen = new Set();
      entries = parsed.filter(x => {
        const key = (x.name || "") + '|' + (x.id || "");
        if (!x.name && !x.id) return false;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      }).map(x => ({
        name: x.name,
        id: x.id,
        label: x.name && x.id ? `${x.name}ï¼ˆ${x.id}ï¼‰` : (x.name || x.id)
      }));
      buildNameList();
      fillIdMM();
      autoPickRangeMode();
      updateCandidates();
      updateStats();
      $('#screen').textContent = 'æ•°æ®å·²è½½å…¥ï¼Œè¯·è®¾ç½®èŒƒå›´åç‚¹å‡»â€œå¼€å§‹æŠ½å–â€ã€‚';
    }

    function showMapping(headerRow) {
      const cols = headerRow.map((v, i) => ({
        i,
        label: clean(v) || (`åˆ—${i+1}`)
      }));
      const selN = $('#selName'),
        selI = $('#selId');
      selN.innerHTML = cols.map(c => `<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
      selI.innerHTML = cols.map(c => `<option value="${c.i}">${escapeHtml(c.label)}</option>`).join('');
      $('#mapping').style.display = '';
      $('#range').style.display = '';
      $('#applyMap').onclick = () => alert('å·²åº”ç”¨æ˜ å°„ã€‚ä¸ºç®€æ´èµ·è§ï¼Œè¯·æŒ‰æ–°æ˜ å°„é‡æ–°å¯¼å…¥ä¸€æ¬¡æ–‡ä»¶ä»¥å®Œå…¨ç”Ÿæ•ˆã€‚');
      $('#sample').textContent = 'å·²æ£€æµ‹åˆ°è¡¨å¤´ï¼š' + headerRow.map(clean).join(' | ');
    }

    /* -------------------- èŒƒå›´ / å€™é€‰ -------------------- */
    function buildNameList() {
      const box = $('#nameList');
      const names = [...new Set(entries.map(e => e.name).filter(Boolean))].sort((a, b) => a.localeCompare(b, 'zh'));
      box.innerHTML = names.map(n => `<label><input type="checkbox" class="cbN" value="${escapeHtml(n)}" checked><span class="nm">${escapeHtml(n)}</span></label>`).join('');
      $('#nameSearch').oninput = () => {
        const kw = $('#nameSearch').value.trim();
        $$('.cbN').forEach(cb => {
          const lab = cb.closest('label');
          lab.style.display = !kw || cb.value.includes(kw) ? 'flex' : 'none';
        });
      };
      $('#all').onclick = () => {
        $$('.cbN').forEach(cb => cb.checked = true);
        updateCandidates();
      };
      $('#none').onclick = () => {
        $$('.cbN').forEach(cb => cb.checked = false);
        updateCandidates();
      };
    }

    function fillIdMM() {
      const ids = entries.map(e => e.id).filter(v => /^\d+$/.test(v)).map(Number);
      if (ids.length) {
        $('#idMin').value = Math.min(...ids);
        $('#idMax').value = Math.max(...ids);
      }
    }
    $('#fillMM').onclick = fillIdMM;
    $$('input[name="mode"]').forEach(r => r.addEventListener('change', () => {
      userModeTouched = true;
      const m = document.querySelector('input[name="mode"]:checked').value;
      $('#idRange').style.display = m === 'id' ? '' : 'none';
      $('#nameRange').style.display = m === 'name' ? '' : 'none';
      updateCandidates();
    }));
    ['idMin', 'idMax', 'exclude'].forEach(id => document.getElementById(id).addEventListener('input', updateCandidates));
    document.addEventListener('change', e => {
      if (e.target && e.target.classList && e.target.classList.contains('cbN')) updateCandidates();
    });

    function setMode(m) {
      const rId = document.querySelector('input[name="mode"][value="id"]');
      const rName = document.querySelector('input[name="mode"][value="name"]');
      rId.checked = (m === 'id');
      rName.checked = (m === 'name');
      $('#idRange').style.display = m === 'id' ? '' : 'none';
      $('#nameRange').style.display = m === 'name' ? '' : 'none';
    }

    function autoPickRangeMode() {
      if (userModeTouched) return; // ç”¨æˆ·æœ‰è¿‡é€‰æ‹©å°±ä¸è¦†ç›–
      const total = entries.length;
      const numericIds = entries.filter(e => /^\d+$/.test(e.id)).length;
      const uniqueIdCount = new Set(entries.map(e => e.id).filter(id => /^\d+$/.test(id))).size;
      const haveNames = entries.some(e => e.name && e.name.trim());
      const pickId = (numericIds >= Math.max(5, Math.floor(total * 0.6))) && (uniqueIdCount >= 2);
      if (pickId) {
        setMode('id');
        $('#autoModeHint').textContent = 'ï¼ˆå·²è‡ªåŠ¨é€‰æ‹©ï¼šæŒ‰å­¦å·ï¼‰';
      } else if (haveNames) {
        setMode('name');
        $('#autoModeHint').textContent = 'ï¼ˆå·²è‡ªåŠ¨é€‰æ‹©ï¼šæŒ‰å§“åï¼‰';
      } else {
        setMode('id');
        $('#autoModeHint').textContent = 'ï¼ˆè‡ªåŠ¨é€‰æ‹©ï¼šæŒ‰å­¦å·ï¼‰';
      }
    }

    function updateCandidates() {
      // â˜… è‹¥åœ¨æŠ½å–é”å®šæœŸï¼Œå»¶åé‡å»ºï¼Œé¿å…æ‰“æ–­åŠ¨ç”»/è¦†ç›– overlay
      if (uiLocked) {
        pendingRecalc = true;
        return;
      }

      const mode = document.querySelector('input[name="mode"]:checked').value;
      const excl = new Set(($('#exclude').value.trim().split(/[\s,ï¼Œ;ï¼›]+/).filter(Boolean)));
      let pool = [];
      if (mode === 'id') {
        const min = +($('#idMin').value || Number.NEGATIVE_INFINITY);
        const max = +($('#idMax').value || Number.POSITIVE_INFINITY);
        pool = entries.filter(e => /^\d+$/.test(e.id) && +e.id >= min && +e.id <= max);
      } else {
        const allowed = new Set([...document.querySelectorAll('.cbN:checked')].map(cb => cb.value));
        pool = entries.filter(e => e.name && allowed.has(e.name));
      }
      pool = pool.filter(e => !(excl.has(e.name) || excl.has(e.id)));
      candidates = pool;
      updateStats();
      buildStrip(candidates);
    }

    function updateStats() {
      $('#statTotal').textContent = entries.length;
      $('#statCand').textContent = candidates.length;
    }

    /* -------------------- è€è™æœºåŠ¨ç”»ï¼ˆé¡ºæ»‘è¿æŠ½ï¼šå¯è°ƒæ—¶é•¿/é—´éš”ï¼‰ -------------------- */
    const VISIBLE_ROWS = 3,
      CENTER_INDEX = 1,
      COPIES = 3,
      MAX_N_DOM = 400;
    const stripEl = document.getElementById('strip'),
      overlayEl = document.getElementById('overlay');
    const BASE_Y = 0; // ç»ˆæ­¢åœ¨ 0

    function buildStrip(list) {
      // ä¸åœ¨è¿™é‡Œéšè— overlayï¼Œé¿å…åœ¨æŠ½å–åå±•ç¤ºæœŸé—´è¢«æ„å¤–æ¸…é™¤
      stripEl.innerHTML = '';
      const baseCount = Math.max(list.length, VISIBLE_ROWS),
        Ndom = Math.min(baseCount, MAX_N_DOM);
      stripEl.dataset.ndom = String(Ndom);
      for (let k = 0; k < COPIES; k++)
        for (let i = 0; i < Ndom; i++) {
          const d = document.createElement('div');
          d.className = 'cell';
          const data = list.length ? list[i % list.length] : {
            label: String(i + 1)
          };
          d.textContent = data.label;
          stripEl.appendChild(d);
        }
      stripEl.style.transform = `translateY(${BASE_Y}px)`;
    }

    function buildStripForSpin(snapshot, winnerIdx) {
      // æ¯è½®å¼€å§‹å‰æ¸…ç† overlay
      overlayEl.classList.remove('show');
      overlayEl.textContent = '';
      stripEl.innerHTML = '';
      const baseCount = Math.max(snapshot.length, VISIBLE_ROWS),
        Ndom = Math.min(baseCount, MAX_N_DOM);
      stripEl.dataset.ndom = String(Ndom);
      const start = (winnerIdx - CENTER_INDEX + snapshot.length) % snapshot.length; // winner ä½äºä¸­é—´è¡Œ
      for (let k = 0; k < COPIES; k++)
        for (let i = 0; i < Ndom; i++) {
          const d = document.createElement('div');
          d.className = 'cell';
          d.textContent = snapshot[(start + i) % snapshot.length].label;
          stripEl.appendChild(d);
        }
      stripEl.style.transform = `translateY(${BASE_Y}px)`;
    }
    const easeOutCubic = t => 1 - Math.pow(1 - t, 3);

    function spinToCenter(durationMs) {
      const cellH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell-h')) || 56;
      const Ndom = parseInt(stripEl.dataset.ndom, 10) || VISIBLE_ROWS;
      const spins = 14; // åœˆæ•°
      const travel = spins * Ndom * cellH;
      stripEl.classList.add('spinning');
      return new Promise(resolve => {
        const t0 = performance.now();

        function frame(now) {
          const t = Math.max(0, Math.min(1, (now - t0) / durationMs));
          const yRaw = -travel * easeOutCubic(t);
          const yLoop = -(Math.abs(yRaw) % (Ndom * cellH));
          stripEl.style.transform = `translateY(${BASE_Y + yLoop}px)`;
          if (t < 1) requestAnimationFrame(frame);
          else {
            stripEl.style.transform = `translateY(${BASE_Y}px)`;
            stripEl.classList.remove('spinning');
            resolve();
          }
        }
        requestAnimationFrame(frame);
      });
    }

    function pickFromSnapshot(snapshot, excludeSet) {
      const idxPool = [];
      for (let i = 0; i < snapshot.length; i++) {
        const key = snapshot[i].name + '|' + snapshot[i].id;
        if (!excludeSet || !excludeSet.has(key)) idxPool.push(i);
      }
      if (!idxPool.length) return null;
      const chosenIndex = Math.floor(rng() * idxPool.length);
      const idxSnap = idxPool[chosenIndex];
      const item = snapshot[idxSnap];
      const idxGlobal = candidates.findIndex(e => e === item || (e.name === item.name && e.id === item.id));
      return {
        item,
        idxSnap,
        idxGlobal
      };
    }

    function renderHistory() {
      const html = winnersAll.slice().reverse().map(rec => {
        const chips = rec.list.map((x, i) => `<span class="chip" title="ç¬¬${i+1}ä¸ª">${escapeHtml(x.label)}</span>`).join('');
        return `<div class="history-group">
        <div class="history-head"><div class="history-time">ğŸ•’ ${rec.time}</div><div class="history-count">æœ¬æ‰¹æ¬¡ ${rec.list.length} ä¸ª</div></div>
        <div class="history-row">${chips}</div>
      </div>`;
      }).join('');
      $('#history').innerHTML = html || '<div class="help">æš‚æ— è®°å½•</div>';
    }

    function setBusy(b) {
      spinning = b;
      $('#start').disabled = b;
      $('#stop').disabled = !b;
    }

    /* -------------------- æŠ½å–æ§åˆ¶ï¼ˆé¡ºæ»‘è¿æŠ½ + é”å®šæœŸ + æ‰¹é‡å†å²ï¼‰ -------------------- */
    let rng = Math.random;
    $('#start').onclick = async () => {
      if (spinning || autoRun) return;
      if (!candidates.length) {
        alert('å€™é€‰é›†ä¸ºç©ºï¼šè¯·æ£€æŸ¥èŒƒå›´è®¾ç½®æˆ–æ’é™¤åå•ã€‚');
        return;
      }
      rng = ($('#seed').value.trim()) ? mulberry32(hashSeed($('#seed').value.trim())) : Math.random;

      const N = Math.max(1, Math.floor(+$('#count').value || 1));
      const used = new Set();
      autoRun = true;
      setBusy(true);
      const spinMs = Math.max(500, Math.floor(+$('#spinMs').value || 1400));
      const holdMs = Math.max(200, Math.floor(+$('#holdMs').value || 900));
      const gapMs = Math.max(0, Math.floor(+$('#gapMs').value || 350));

      // æœ¬æ¬¡æ‰¹é‡å†å²è®°å½•å®¹å™¨ï¼ˆä¸€ä¸ªæ‰¹æ¬¡=ä¸€è¡Œï¼‰
      const currentBatch = {
        time: new Date().toLocaleString(),
        list: []
      };

      for (let i = 0; i < N && autoRun; i++) {
        $('#progress').textContent = `ï¼ˆè¿›åº¦ï¼š${i+1}/${N}ï¼‰`;

        // é”å®šæœŸå¼€å§‹ï¼šé˜»æ­¢ä»»ä½•å€™é€‰é›†é‡å»º
        uiLocked = true;

        const snapshot = candidates.slice();
        const pick = pickFromSnapshot(snapshot, $('#noRepeat').checked ? used : null);
        if (!pick) {
          uiLocked = false;
          break;
        }

        buildStripForSpin(snapshot, pick.idxSnap);
        await spinToCenter(spinMs);

        // éšè—æ¡å¸¦ä¸­å±…ä¸­é‚£ä¸€è¡Œï¼Œé¿å…ä¸æµ®ç°æ–‡æœ¬é‡å 
        const centerCell = stripEl.children[CENTER_INDEX];
        if (centerCell) centerCell.classList.add('hiddenCenter');

        // æµ®ç°æ”¾å¤§ç‰ˆç»“æœ
        overlayEl.textContent = pick.item.label;
        overlayEl.classList.add('show');
        $('#screen').textContent = 'ğŸ‰ æ­å–œï¼š' + pick.item.label;

        // å†™å…¥æœ¬æ‰¹æ¬¡ï¼ˆä¸ç«‹åˆ»æ¸²æŸ“ï¼Œé¿å…ä¸€æ‰¹å‡ºç°å¤šè¡Œï¼‰
        currentBatch.list.push(pick.item);
        if ($('#noRepeat').checked) {
          used.add(pick.item.name + '|' + pick.item.id);
        }

        // å¯ç”¨â€œä¸­å¥–åå–æ¶ˆå‹¾é€‰â€ï¼šå…ˆä»…æ”¹å¤é€‰æ¡†ï¼Œä¸è§¦å‘é‡å»ºï¼›è®°å½•å¾…é‡å»ºæ ‡å¿—
        if (autoUncheckEnabled && pick.item.name) {
          $$('.cbN').forEach(cb => {
            if (cb.value === pick.item.name) cb.checked = false;
          });
          pendingRecalc = true;
        }

        // å±•ç¤ºåœé¡¿
        await new Promise(r => setTimeout(r, holdMs));
        overlayEl.classList.remove('show');
        await new Promise(r => setTimeout(r, 180));

        // é”å®šæœŸç»“æŸï¼šå¦‚æœ‰å¾…é‡å»ºï¼Œåˆ™åœ¨æ­¤åˆ»ç»Ÿä¸€æ›´æ–°ï¼ˆä¸ºä¸‹ä¸€è½®å‡†å¤‡ï¼‰
        uiLocked = false;
        if (pendingRecalc) {
          pendingRecalc = false;
          updateCandidates();
        }

        if (gapMs > 0) await new Promise(r => setTimeout(r, gapMs));
      }

      // æ‰¹æ¬¡å†™å…¥å†å²å¹¶æ¸²æŸ“ï¼ˆå•è¡Œæ˜¾ç¤ºï¼‰
      if (currentBatch.list.length > 0) {
        winnersAll.push(currentBatch);
        renderHistory();
      }

      $('#progress').textContent = '';
      autoRun = false;
      setBusy(false);
    };
    $('#stop').onclick = () => {
      autoRun = false;
    };

    /* -------------------- å¯¼å‡ºå†å²ï¼ˆæ‰¹æ¬¡åŒ–ï¼‰ -------------------- */
    $('#export').onclick = () => {
      if (!winnersAll.length) {
        alert('æš‚æ— ä¸­å¥–è®°å½•å¯å¯¼å‡ºã€‚');
        return;
      }
      const rows = [
        ['æ‰¹æ¬¡æ—¶é—´', 'æ‰¹æ¬¡åºå·', 'åºå·(æ‰¹å†…)', 'å§“å', 'å­¦å·', 'æ˜¾ç¤ºæ ‡ç­¾']
      ];
      winnersAll.forEach((rec, bi) => rec.list.forEach((p, i) => rows.push([rec.time, bi + 1, i + 1, p.name, p.id, p.label])));
      const csv = rows.map(r => r.map(x => `"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
      const url = URL.createObjectURL(new Blob([csv], {
        type: 'text/csv;charset=utf-8;'
      }));
      const a = document.createElement('a');
      a.href = url;
      a.download = 'winners_batches.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    };

    /* -------------------- ä¸­å¥–åå–æ¶ˆå‹¾é€‰ï¼ˆå¹¶æ’å¼€å…³ï¼‰ -------------------- */
    const autoUncheckCb = $('#autoUncheck');
    autoUncheckCb.addEventListener('change', () => {
      autoUncheckEnabled = autoUncheckCb.checked;
      if (!autoUncheckEnabled) { // å…³é—­æ—¶ï¼šç«‹å³æ¢å¤â€œæŒ‰å§“åâ€åˆ—è¡¨ä¸ºå…¨é€‰
        $$('.cbN').forEach(cb => cb.checked = true);
        updateCandidates();
      }
    });

    /* -------------------- åå•æŒä¹…åŒ–ï¼ˆä¿å­˜/ç®¡ç†/å¯¼å‡º/å¯¼å…¥ï¼‰ -------------------- */
    const LS_KEY = 'lotteryListsV1';
    const loadStore = () => {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY)) || {
          lists: {},
          lastUsed: ''
        };
      } catch (e) {
        return {
          lists: {},
          lastUsed: ''
        };
      }
    };
    const saveStore = st => localStorage.setItem(LS_KEY, JSON.stringify(st));

    function refreshSavedListUI() {
      const box = $('#savedListBox');
      const st = loadStore();
      const names = Object.keys(st.lists);
      if (!names.length) {
        box.innerHTML = '<div class="help">æš‚æ— ä¿å­˜çš„åå•ã€‚</div>';
        return;
      }
      box.innerHTML = names.map(n => {
        const cnt = (st.lists[n].entries || []).length;
        const tag = (st.lastUsed === n) ? '<span class="help" style="color:#10b981"> [ä¸Šæ¬¡ä½¿ç”¨]</span>' : '';
        const safe = escapeHtml(n);
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eee">
        <div><b>${safe}</b> <span class="help">ï¼ˆ${cnt} æ¡ï¼‰</span>${tag}</div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" data-act="load" data-name="${safe}">åŠ è½½</button>
          <button class="btn bad" data-act="del" data-name="${safe}">åˆ é™¤</button>
        </div></div>`;
      }).join('');
      box.querySelectorAll('button').forEach(btn => {
        btn.onclick = (e) => {
          const act = e.currentTarget.dataset.act,
            nm = e.currentTarget.dataset.name;
          if (act === 'load') loadList(nm);
          if (act === 'del') {
            if (confirm('ç¡®è®¤åˆ é™¤ä¿å­˜çš„åå•ï¼š' + nm + 'ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
              const st2 = loadStore();
              delete st2.lists[nm];
              if (st2.lastUsed === nm) st2.lastUsed = '';
              saveStore(st2);
              refreshSavedListUI();
            }
          }
        };
      });
    }

    function applyEntries(newEntries, sourceLabel) {
      entries = Array.isArray(newEntries) ? newEntries.map(x => ({
        name: x.name || '',
        id: x.id || '',
        label: x.label || ((x.name && x.id) ? `${x.name}ï¼ˆ${x.id}ï¼‰` : (x.name || x.id))
      })) : [].slice();
      buildNameList();
      fillIdMM();
      userModeTouched = false;
      autoPickRangeMode();
      updateCandidates();
      updateStats();
      $('#screen').textContent = sourceLabel || 'æ•°æ®å·²è½½å…¥ï¼ˆæœ¬åœ°ï¼‰';
      $('#range').style.display = '';
    }

    function loadList(name) {
      const st = loadStore();
      const rec = st.lists[name];
      if (!rec) {
        alert('æœªæ‰¾åˆ°ä¿å­˜çš„åå•ï¼š' + name);
        return;
      }
      applyEntries(rec.entries, 'å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼š' + name + 'ï¼ˆå¯ç›´æ¥æŠ½å¥–ï¼‰');
      st.lastUsed = name;
      saveStore(st);
    }

    function saveCurrentList() {
      if (!entries.length) {
        alert('æš‚æ— æ•°æ®å¯ä¿å­˜ï¼Œè¯·å…ˆå¯¼å…¥ã€‚');
        return;
      }
      if (!storageAvailable()) {
        $('#storageWarn').style.display = '';
        alert('å½“å‰ç¯å¢ƒä¸æ”¯æŒæœ¬åœ°å­˜å‚¨ã€‚');
        return;
      }
      const name = ($('#listName').value.trim() || 'é»˜è®¤åå•');
      const st = loadStore();
      if (st.lists[name] && !confirm('åŒååå•å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ\nåç§°ï¼š' + name)) return;
      st.lists[name] = {
        entries
      };
      st.lastUsed = name;
      saveStore(st);
      refreshSavedListUI();
      alert('å·²ä¿å­˜ä¸ºï¼š' + name + 'ã€‚ä¸‹æ¬¡æ‰“å¼€ä¼šè‡ªåŠ¨åŠ è½½è¯¥åå•ã€‚');
    }
    $('#btnSaveList').onclick = saveCurrentList;
    $('#btnManageList').onclick = () => {
      const p = $('#savedPanel');
      const show = p.style.display === 'none';
      p.style.display = show ? 'block' : 'none';
      if (show) refreshSavedListUI();
      $('#storageWarn').style.display = storageAvailable() ? 'none' : '';
    };
    $('#btnExportSaved').onclick = () => {
      try {
        const st = loadStore();
        const blob = new Blob([JSON.stringify(st, null, 2)], {
          type: 'application/json;charset=utf-8'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'lottery_lists_backup.json';
        a.click();
        URL.revokeObjectURL(a.href);
      } catch (e) {
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + (e && e.message || e));
      }
    };
    $('#importSavedFile').addEventListener('change', e => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const obj = JSON.parse(fr.result);
          if (!obj || typeof obj !== 'object' || !obj.lists) {
            alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼šç¼ºå°‘ lists å­—æ®µ');
            return;
          }
          saveStore(obj);
          refreshSavedListUI();
          alert('å¯¼å…¥å®Œæˆï¼Œå·²è¦†ç›–æœ¬åœ°ä¿å­˜çš„åå•ã€‚');
        } catch (err) {
          alert('è§£æå¤±è´¥ï¼š' + err.message);
        }
      };
      fr.readAsText(f, 'utf-8');
    });

    /* -------------------- é¡µé¢æ‰“å¼€ï¼šè‡ªåŠ¨åŠ è½½ä¸Šæ¬¡ä½¿ç”¨åå• -------------------- */
    (function autoLoad() {
      try {
        if (!storageAvailable()) return;
        const st = loadStore();
        if (st.lastUsed && st.lists[st.lastUsed]) {
          applyEntries(st.lists[st.lastUsed].entries, 'å·²è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„åå•ï¼š' + st.lastUsed + 'ï¼ˆå¯ç›´æ¥æŠ½å¥–ï¼‰');
          $('#encInfo').textContent = 'æ¥æºï¼šæœ¬åœ°å­˜å‚¨';
        }
      } catch (e) {}
    })();

    /* -------------------- åˆå§‹åŒ–ç©º strip -------------------- */
    buildStrip([]);
  </script>
</body>

</html>